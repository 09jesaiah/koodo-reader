import e from"axios";import t from"fs";import o from"path";import{Client as r}from"basic-ftp";import{S3Client as i,PutObjectCommand as s,GetObjectCommand as n,ListObjectsV2Command as a}from"@aws-sdk/client-s3";import{createClient as c,AuthType as l}from"webdav";import d from"ssh2-sftp-client";function h(e,t,o,r){return new(o||(o=Promise))((function(i,s){function n(e){try{c(r.next(e))}catch(e){s(e)}}function a(e){try{c(r.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(n,a)}c((r=r.apply(e,t||[])).next())}))}const p="https://web.koodoreader.com",u="https://cloud.960960.xyz/api/v1/third_auth/dropbox_auth",f="https://cloud.960960.xyz/api/v1/third_auth/dropbox_refresh",m="https://cloud.960960.xyz/api/v1/third_auth/onedrive_auth",g="https://cloud.960960.xyz/api/v1/third_auth/onedrive_refresh",y="https://cloud.960960.xyz/api/v1/third_auth/google_auth",v="https://cloud.960960.xyz/api/v1/third_auth/google_refresh";class w{constructor(e){this.config=e}listFiles(t){return h(this,void 0,void 0,(function*(){try{let{refresh_token:o}=this.config;const r=yield this.refreshToken(o),i=yield e.post("https://api.dropboxapi.com/2/files/list_folder",{path:"/"+t},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});return console.log(i.data.entries.map((e=>e.name))),i.data.entries.map((e=>e.name))}catch(e){throw console.error("Error listing files:",e),e}}))}refreshToken(t){return h(this,void 0,void 0,(function*(){return(yield e.post(f,{refresh_token:t})).data.access_token}))}authToken(t){return h(this,void 0,void 0,(function*(){let o=yield e.post(u,{code:t,redirect_uri:p});return console.log(o.data),o.data.refresh_token}))}}class F extends w{constructor(e,t){super(e),this.storagePath=t}uploadFile(r,i){return new Promise(((s,n)=>h(this,void 0,void 0,(function*(){try{let{refresh_token:n}=this.config;const a=yield this.refreshToken(n),c=t.createReadStream(o.join(this.storagePath,r)),l=yield e.post("https://content.dropboxapi.com/2/files/upload",c,{headers:{Authorization:`Bearer ${a}`,"Content-Type":"application/octet-stream","Dropbox-API-Arg":JSON.stringify({path:"/"+i,mode:"overwrite",autorename:!0,mute:!1})}});console.log("File uploaded successfully:",l),s(!0)}catch(e){console.error("Error uploading file:",e),n(!1)}}))))}downloadFile(r,i){return new Promise(((s,n)=>h(this,void 0,void 0,(function*(){try{let{refresh_token:a}=this.config;const c=yield this.refreshToken(a),l=t.createWriteStream(o.join(this.storagePath,i));(yield e({url:"https://content.dropboxapi.com/2/files/download",method:"GET",responseType:"stream",headers:{Authorization:`Bearer ${c}`,"Dropbox-API-Arg":JSON.stringify({path:"/"+r})}})).data.pipe(l),l.on("finish",(()=>{s(!0)})),l.on("error",(e=>{n(!1)}))}catch(e){console.error("Error occurred during file download:",e),n(!1)}}))))}}class k{constructor(e,t){this.config=e,this.storagePath=t}uploadFile(e,t){return h(this,void 0,void 0,(function*(){let{url:i,username:s,password:n,dir:a,ssl:c}=this.config;const l=new r;l.ftp.verbose=!0;const d=()=>h(this,void 0,void 0,(function*(){yield l.access({host:i,user:s,password:n,secure:"1"===c}),yield l.uploadFrom(o.join(this.storagePath,e),a+"/"+t)}));try{return yield d(),!0}catch(e){return console.error(e),!1}}))}downloadFile(e,t){return h(this,void 0,void 0,(function*(){let{url:i,username:s,password:n,dir:a,ssl:c}=this.config;const l=new r;l.ftp.verbose=!0;const d=()=>h(this,void 0,void 0,(function*(){yield l.access({host:i,user:s,password:n,secure:"1"===c}),yield l.downloadTo(o.join(this.storagePath,t),a+"/"+e)}));try{return yield d(),!0}catch(e){return console.error(e),!1}}))}listFiles(e){return h(this,void 0,void 0,(function*(){let{url:t,username:o,password:i,dir:s,ssl:n}=this.config;const a=new r;a.ftp.verbose=!0;const c=()=>h(this,void 0,void 0,(function*(){return yield a.access({host:t,user:o,password:i,secure:"1"===n}),yield a.list(s+"/"+e)}));try{return yield c()}catch(e){return console.error(e),e}}))}}class x{constructor(e){this.config=e}listFiles(t){return h(this,void 0,void 0,(function*(){try{let{refresh_token:o}=this.config;const r=(yield e.post(g,{refresh_token:o})).data.access_token,i=yield e.get(`https://graph.microsoft.com/v1.0/me/drive/special/approot:/${t}:/children`,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});return console.log("Files in folder:",i.data.value.map((e=>e.name))),i.data.value.map((e=>e.name))}catch(e){throw console.error("Error listing files:",e),e}}))}refreshToken(t){return h(this,void 0,void 0,(function*(){return(yield e.post(g,{refresh_token:t})).data.access_token}))}authToken(t){return h(this,void 0,void 0,(function*(){let o=yield e.post(m,{code:t,redirect_uri:p});return console.log(o.data),o.data.refresh_token}))}}const P=e=>"json"===e?"application/json":["jpg","jpeg","png","gif","bmp"].includes(e)?"image/"+e:"zip"===e?"application/zip":"epub"===e?"application/epub+zip":"txt"===e?"text/plain":"pdf"===e?"application/pdf":"mobi"===e?"application/x-mobipocket-ebook":"azw3"===e||"azw"===e?"application/vnd.amazon.ebook":"cbz"===e?"application/x-cbz":"cbr"===e?"application/x-cbr":"cbt"===e?"application/x-cbt":"cb7"===e?"application/x-cb7":"fb2"===e?"application/x-fictionbook+xml":"html"===e?"text/html":"css"===e?"text/css":"js"===e?"application/javascript":"xml"===e?"application/xml":"xhtml"===e?"application/xhtml+xml":"opf"===e?"application/oebps-package+xml":"ncx"===e?"application/x-dtbncx+xml":"mp3"===e?"audio/mpeg":"wav"===e?"audio/wav":"ogg"===e?"audio/ogg":"mp4"===e?"video/mp4":"webm"===e?"video/webm":"avi"===e?"video/x-msvideo":"wmv"===e?"video/x-ms-wmv":"flv"===e?"video/x-flv":"m3u8"===e?"application/x-mpegURL":"ts"===e?"video/MP2T":"3gp"===e?"video/3gpp":"3g2"===e?"video/3gpp2":void 0;class b extends x{constructor(e,t){super(e),this.storagePath=t}uploadFile(r,i){return new Promise(((s,n)=>h(this,void 0,void 0,(function*(){try{let{refresh_token:n}=this.config;const a=yield this.refreshToken(n);console.log(a);let c=i.split(".").pop(),l=P(c||"");const d="https://graph.microsoft.com/v1.0/me/drive/special/approot:/"+i+":/createUploadSession",h=(yield e.post(d,null,{headers:{Authorization:"Bearer "+a,"Content-Type":"application/json"}})).data.uploadUrl,p=t.createReadStream(o.join(this.storagePath,r)),u=yield e.put(h,p,{headers:{Authorization:"Bearer "+a,"Content-Type":l}});console.log("File uploaded successfully:",u),s(!0)}catch(e){console.error("Error occurred during file upload:",e),s(!1)}}))))}downloadFile(r,i){return new Promise(((s,n)=>h(this,void 0,void 0,(function*(){try{let{refresh_token:a}=this.config;const c=yield this.refreshToken(a),l=`https://graph.microsoft.com/v1.0/me/drive/special/approot:/${r}:/content`,d=t.createWriteStream(o.join(this.storagePath,i));(yield e({url:l,method:"GET",responseType:"stream",headers:{Authorization:"Bearer "+c}})).data.pipe(d),d.on("finish",(()=>{s(!0)})),d.on("error",(e=>{n(!1)}))}catch(e){console.error("Error occurred during file download:",e),n(!1)}}))))}}class T{constructor(e){this.config=e}getFileId(t,o,r){return h(this,void 0,void 0,(function*(){const i=`https://www.googleapis.com/drive/v3/files?q=name='${o}'+and+'${r}'+in+parents&spaces=appDataFolder&fields=files(id,name)`;try{const o=yield e.get(i,{headers:{Authorization:"Bearer "+t}});if(0===o.data.files.length)return"";const r=o.data.files;return console.log(r),r.length>0?r[0].id:null}catch(e){return console.error("Error occurred during file list retrieval:",e),""}}))}checkFolder(t,o){return h(this,void 0,void 0,(function*(){const r=yield this.getFolderId(t,o);if(r)return console.log("Folder already exists:",r),r;const i={name:o,mimeType:"application/vnd.google-apps.folder",parents:["appDataFolder"]};try{const o=yield e.post("https://www.googleapis.com/drive/v3/files",i,{headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});return console.log("Folder created:",o.data.id),o.data.id}catch(e){throw console.error("Error occurred during folder creation:",e),e}}))}getFolderId(t,o){return h(this,void 0,void 0,(function*(){const r=`https://www.googleapis.com/drive/v3/files?q=name='${o}'+and+mimeType='application/vnd.google-apps.folder'+and+'appDataFolder'+in+parents&spaces=appDataFolder&fields=files(id,name)`;try{const o=(yield e.get(r,{headers:{Authorization:`Bearer ${t}`}})).data.files;return o.length>0?o[0].id:null}catch(e){throw console.error("Error occurred during fetching folder ID:",e),e}}))}listFiles(t){return h(this,void 0,void 0,(function*(){try{let{refresh_token:o}=this.config;const r=yield this.refreshToken(o);let i=yield this.checkFolder(r,t);console.log(i);const s=`https://www.googleapis.com/drive/v3/files?q='${i}'+in+parents&spaces=appDataFolder&fields=files(id,name)`,n=yield e.get(s,{headers:{Authorization:`Bearer ${r}`}});return console.log("Files in folder:",n.data.files.map((e=>e.name))),n.data.files}catch(e){throw console.error("Error listing files:",e),e}}))}refreshToken(t){return h(this,void 0,void 0,(function*(){return(yield e.post(v,{refresh_token:t})).data.access_token}))}authToken(t){return h(this,void 0,void 0,(function*(){let o=yield e.post(y,{code:t,redirect_uri:p});return console.log(o.data),o.data.refresh_token}))}}class _ extends T{constructor(e,t){super(e),this.storagePath=t}uploadFile(r,i){return new Promise(((s,n)=>h(this,void 0,void 0,(function*(){try{let{refresh_token:n}=this.config;const a=yield this.refreshToken(n);console.log(a);let c=r.split("/").pop(),l=i.split(".").pop(),d=P(l||""),h=i.split("/")[0],p=yield this.checkFolder(a,h),u=yield this.getFileId(a,c||"",p);console.log(u,"fileId");const f={mimeType:d,name:c,parents:[p]},m=u?`https://www.googleapis.com/upload/drive/v3/files/${u}?uploadType=resumable`:"https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable";console.log(m);const g=(yield e({method:u?"PATCH":"POST",url:m,data:u?null:JSON.stringify(f),headers:{Authorization:"Bearer "+a,"Content-Type":"application/json; charset=UTF-8"}})).headers.location;console.log(g);let y=yield this.getFileSize(o.join(this.storagePath,r));const v=t.createReadStream(o.join(this.storagePath,r)),w=yield e.put(g,v,{headers:{Authorization:"Bearer "+a,"Content-Type":"application/zip","Content-Range":`bytes 0-${y-1}/${y}`}});console.log("File uploaded successfully:",w),s(!0)}catch(e){console.error("Error occurred during upload:",e),s(!1)}}))))}downloadFile(r,i){return new Promise(((s,n)=>h(this,void 0,void 0,(function*(){try{let{refresh_token:a}=this.config;const c=yield this.refreshToken(a);let l=r.split("/").pop(),d=r.split("/")[0],h=yield this.checkFolder(c,d),p=yield this.getFileId(c,l||"",h);p||(console.error("File not found"),n(!1));const u=`https://www.googleapis.com/drive/v3/files/${p}?alt=media`,f=t.createWriteStream(o.join(this.storagePath,i)),m=yield e({url:u,method:"GET",responseType:"stream",headers:{Authorization:"Bearer "+c}});m.data.pipe(f),f.on("finish",(()=>{s(!0)})),f.on("error",(e=>{n(!1)})),console.log(m),s(!0)}catch(e){console.error("Error occurred during file download:",e),n(!1)}}))))}getFileSize(e){return new Promise(((o,r)=>{t.stat(e,((e,t)=>{e&&r(e),o(t.size)}))}))}}class z{constructor(e,t){this.config=e,this.storagePath=t}uploadFile(e,r){return h(this,void 0,void 0,(function*(){let{endpoint:n,region:a,bucketName:c,accessKeyId:l,secretAccessKey:d}=this.config;const h=new i({endpoint:n,region:a,credentials:{accessKeyId:l,secretAccessKey:d}});try{return yield h.send(new s({Bucket:c,Key:r,Body:t.createReadStream(o.join(this.storagePath,e))})),!0}catch(e){return console.log("Error: ",e),!1}}))}downloadFile(e,r){return h(this,void 0,void 0,(function*(){let{endpoint:s,region:a,bucketName:c,accessKeyId:l,secretAccessKey:d}=this.config;const p=()=>new Promise(((p,u)=>{const f=new i({region:a,endpoint:s,credentials:{accessKeyId:l,secretAccessKey:d}});let m=t.createWriteStream(o.join(this.storagePath,r));(function(e,t,o,r){return new Promise(((i,s)=>h(this,void 0,void 0,(function*(){const a=yield e.send(new n({Bucket:t,Key:o}));a.Body?(a.Body.pipe(r),r.on("finish",(e=>{e&&s(!1),i(!0)}))):s(!1)}))))})(f,c,e,m).then((e=>{p(!0)})).catch((e=>{console.error(e),p(!1)}))}));try{return yield p()}catch(e){return console.error(e),!1}}))}listFiles(e){return h(this,void 0,void 0,(function*(){let{endpoint:t,region:o,bucketName:r,accessKeyId:s,secretAccessKey:n}=this.config;const c=new i({endpoint:t,region:o,credentials:{accessKeyId:s,secretAccessKey:n}});try{return(yield c.send(new a({Bucket:r,Prefix:e}))).Contents.map((e=>e.Key))}catch(e){return console.error(e),[]}}))}}class j{constructor(e,t){this.storagePath=t;let{username:o,password:r,url:i}=e;this.client=c(i,{authType:l.Password,username:o,password:r}),this.username=o,this.password=r}uploadFile(e,r){return new Promise(((i,s)=>h(this,void 0,void 0,(function*(){try{!1===(yield this.client.exists("/KoodoReader"))&&(yield this.client.createDirectory("/KoodoReader"));let s=this.client.createWriteStream("/KoodoReader/"+r);t.createReadStream(o.join(this.storagePath,e)).pipe(s),s.on("finish",(()=>{i(!0)})),s.on("error",(e=>{console.log(e),i(!1)}))}catch(e){console.error("Error uploading file:",e),s(!1)}}))))}downloadFile(e,r){return new Promise(((i,s)=>h(this,void 0,void 0,(function*(){try{!1===(yield this.client.exists("/KoodoReader/"+e))&&i(!1);let n=t.createWriteStream(o.join(this.storagePath,r));this.client.createReadStream("/KoodoReader/"+e).pipe(n),n.on("finish",(()=>{i(!0)})),n.on("error",(e=>{s(!1)}))}catch(e){console.error("Error occurred during file download:",e),s(!1)}}))))}listFiles(e){return h(this,void 0,void 0,(function*(){try{let t=yield this.client.getDirectoryContents("/KoodoReader/"+e);return console.log(t.map((e=>e.basename))),t.map((e=>e.basename))}catch(e){return console.error("Error listing files:",e),[]}}))}}class A{constructor(e,t){this.config=e,this.storagePath=t}uploadFile(e,r){return h(this,void 0,void 0,(function*(){let{url:i,username:s,password:n,dir:a,port:c}=this.config,l=new d;const h=()=>new Promise(((d,h)=>{let p=t.createReadStream(o.join(this.storagePath,e)),u="/"+a+"/"+r;l.connect({host:i,port:c,username:s,password:n}).then((()=>l.put(p,u))).then((()=>(d(!0),l.end()))).catch((e=>{console.error(e.message),d(!1)}))}));try{return yield h()}catch(e){return console.error(e),!1}}))}downloadFile(e,r){return h(this,void 0,void 0,(function*(){let{url:i,username:s,password:n,dir:a,port:c}=this.config,l=new d;const h=()=>new Promise(((d,h)=>{let p="/"+a+"/"+e,u=t.createWriteStream(o.join(this.storagePath,r));l.connect({host:i,port:c,username:s,password:n}).then((()=>l.get(p,u))).then((()=>(d(!0),l.end()))).catch((e=>{console.error(e.message),d(!1)}))}));try{return yield h()}catch(e){return console.error(e),!1}}))}listFiles(e){return h(this,void 0,void 0,(function*(){let{url:t,username:o,password:r,dir:i,port:s}=this.config,n=new d;try{return yield new Promise(((a,c)=>{let l="/"+i+"/"+e;n.connect({host:t,port:s,username:o,password:r}).then((()=>n.list(l))).then((()=>(a(!0),n.end()))).catch((e=>{console.error(e.message),a(!1)}))}))}catch(e){return console.error(e),!1}}))}}const S=["book","config","cover","font"];class K{constructor(e,t,o){this.type=e,this.storagePath=o,"dropbox"===e?this.remote=new F(t,o):"onedrive"===e?this.remote=new b(t,o):"googledrive"===e?this.remote=new _(t,o):"s3compatible"===e?this.remote=new z(t,o):"webdav"===e?this.remote=new j(t,o):"ftp"===e?this.remote=new k(t,o):"sftp"===e&&(this.remote=new A(t,o))}downloadFile(e,r){return h(this,void 0,void 0,(function*(){return t.existsSync(o.join(this.storagePath+"/"+r))||t.mkdirSync(o.join(this.storagePath+"/"+r)),yield this.remote.downloadFile(r+"/"+e,r+"/"+e)}))}uploadFile(e,t){return h(this,void 0,void 0,(function*(){return yield this.remote.uploadFile(t+"/"+e,t+"/"+e)}))}listFiles(e){return h(this,void 0,void 0,(function*(){return yield this.remote.listFiles(e)}))}downloadAllFiles(){return h(this,void 0,void 0,(function*(){for(let e of S){let t=yield this.listFiles(e);for(let o of t)yield this.downloadFile(o,e)}}))}authToken(e){return h(this,void 0,void 0,(function*(){yield this.remote.authToken(e)}))}}export{K as SyncUtil};
