import e from"axios";import{createClient as t,AuthType as r}from"webdav/dist/web/index.js";import{isElectron as o}from"react-device-detect";function n(e,t,r,o){return new(r||(r=Promise))((function(n,i){function a(e){try{l(o.next(e))}catch(e){i(e)}}function s(e){try{l(o.throw(e))}catch(e){i(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,s)}l((o=o.apply(e,t||[])).next())}))}const i={publicUrl:"https://api.960960.xyz",cloudUrl:"https://cloud.960960.xyz",devUrl:"https://cloudtest.960960.xyz"},a={callbackUrl:"https://web.koodoreader.com/",dropboxClientId:"vnc67byrssocvy1",microsoftClientId:"506df58a-29ab-4020-afc5-6f423dc80f35",googleClientId:"1051055003225-ph1f5fvh328dhv7bco5jitlnfhg6ks2t.apps.googleusercontent.com",facebookClientId:"2845583825559500",githubClientId:"Ov23liJVzfvJMMEEZ8v2"};var s={CloudConfig:i,ThirdpartyConfig:a,LoginAuthRequest:{google:{clientId:a.googleClientId,scopes:["openid"],usePKCE:!1,responseType:"code",redirectUri:a.callbackUrl,extraParams:{prompt:"consent",scope:"openid"}},microsoft:{clientId:a.microsoftClientId,scopes:["openid","profile","User.Read","offline_access"],usePKCE:!1,responseType:"code",redirectUri:a.callbackUrl,extraParams:{scope:"openid profile User.Read offline_access"}},facebook:{clientId:a.facebookClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:a.callbackUrl,extraParams:{scope:""}},github:{clientId:a.githubClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:a.callbackUrl,extraParams:{scope:""}}},LoginDiscovery:{microsoft:{authorizationEndpoint:"https://login.microsoftonline.com/common/oauth2/v2.0/authorize",tokenEndpoint:"https://login.microsoftonline.com/common/oauth2/v2.0/token"},google:{authorizationEndpoint:"https://accounts.google.com/o/oauth2/v2/auth",tokenEndpoint:"https://oauth2.googleapis.com/token"},facebook:{authorizationEndpoint:"https://www.facebook.com/v12.0/dialog/oauth",tokenEndpoint:"https://graph.facebook.com/v12.0/oauth/access_token"},github:{authorizationEndpoint:"https://github.com/login/oauth/authorize",tokenEndpoint:"https://github.com/login/oauth/access_token"}},DriveAuthRequest:{dropbox:{clientId:a.dropboxClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:a.callbackUrl,extraParams:{token_access_type:"offline"}},microsoft:{clientId:a.microsoftClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:a.callbackUrl,extraParams:{scope:"files.readwrite.appfolder offline_access"}},google:{clientId:a.googleClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:a.callbackUrl,extraParams:{prompt:"consent",scope:"https://www.googleapis.com/auth/drive.appdata",access_type:"offline"}}},DriveDiscovery:{dropbox:{authorizationEndpoint:"https://www.dropbox.com/oauth2/authorize",tokenEndpoint:"https://www.dropbox.com/oauth2/token"},microsoft:{authorizationEndpoint:"https://login.microsoftonline.com/common/oauth2/v2.0/authorize",tokenEndpoint:"https://login.microsoftonline.com/common/oauth2/v2.0/token"},google:{authorizationEndpoint:"https://accounts.google.com/o/oauth2/v2/auth",tokenEndpoint:"https://oauth2.googleapis.com/token"}}};class l{constructor(e,t){this.config=e,this.thirdpartyRequest=t}listFiles(t){return n(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken();console.log("list folder",t);const o=yield e.post("https://api.dropboxapi.com/2/files/list_folder",{path:"/"+t},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});return console.log(o.data),o.data.entries.map((e=>e.name))}catch(e){return console.log("Error listing files:",e),[]}}))}deleteFile(t){return n(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken();yield e.post("https://api.dropboxapi.com/2/files/delete_v2",{path:"/"+t},{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});return!0}catch(e){return console.log("Error deleting file:",e),!1}}))}refreshToken(){return n(this,void 0,void 0,(function*(){if(this.config.access_token&&this.config.expires_at>(new Date).getTime())return this.config.access_token;let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"dropbox",refresh_token:e});return this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,t.data.access_token}))}authToken(e){return n(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"dropbox",redirect_uri:a.callbackUrl,code:e})).data.refresh_token}))}getAuthUrl(){return`https://www.dropbox.com/oauth2/authorize?response_type=code&token_access_type=offline&client_id=${a.dropboxClientId}&redirect_uri=${a.callbackUrl}`}}class c extends l{constructor(e,t){super(e,t)}uploadFile(t,r){return new Promise(((o,i)=>n(this,void 0,void 0,(function*(){try{const n=yield this.refreshToken();let i=r.split("/").pop()||"",a=new File([t],i,{lastModified:(new Date).getTime(),type:t.type});const s=yield e.post("https://content.dropboxapi.com/2/files/upload",a,{headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/octet-stream","Dropbox-API-Arg":JSON.stringify({path:"/"+r,mode:"overwrite",autorename:!0,mute:!1})},maxContentLength:1/0,maxBodyLength:1/0});if(s.status>=300)return console.log("Error occurred during file download:",s),void o(!1);o(!0)}catch(e){console.log("Error uploading file:",e),o(!1)}}))))}downloadFile(t){return new Promise(((r,o)=>n(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken(),n=yield e({url:"https://content.dropboxapi.com/2/files/download",method:"post",headers:{Authorization:`Bearer ${o}`,"Dropbox-API-Arg":JSON.stringify({path:"/"+t})},maxContentLength:1/0,maxBodyLength:1/0,responseType:"arraybuffer"});if(n.status>=300)return console.log("Error occurred during file download:",n),void r(new ArrayBuffer(0));r(n.data)}catch(e){console.log("Error occurred during file download:",e),r(new ArrayBuffer(0))}}))))}}class u{constructor(e,t){this.config=e,this.thirdpartyRequest=t}getFileId(t,r){return n(this,void 0,void 0,(function*(){const o=yield this.refreshToken(),n=`https://www.googleapis.com/drive/v3/files?q=name='${t}'+and+'${r}'+in+parents&spaces=appDataFolder&fields=files(id,name)`;try{const t=yield e.get(n,{headers:{Authorization:"Bearer "+o}});if(0===t.data.files.length)return"";const r=t.data.files;return r.length>0?r[0].id:null}catch(e){return console.log("Error occurred during file list retrieval:",e),""}}))}checkFolder(t){return n(this,void 0,void 0,(function*(){const r=yield this.refreshToken(),o=yield this.getFolderId(t);if(o)return o;const n={name:t,mimeType:"application/vnd.google-apps.folder",parents:["appDataFolder"]};try{return(yield e.post("https://www.googleapis.com/drive/v3/files",n,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}})).data.id}catch(e){throw console.log("Error occurred during folder creation:",e),e}}))}getFolderId(t){return n(this,void 0,void 0,(function*(){const r=yield this.refreshToken(),o=`https://www.googleapis.com/drive/v3/files?q=name='${t}'+and+mimeType='application/vnd.google-apps.folder'+and+'appDataFolder'+in+parents&spaces=appDataFolder&fields=files(id,name)`;try{const t=(yield e.get(o,{headers:{Authorization:`Bearer ${r}`}})).data.files;return t.length>0?t[0].id:null}catch(e){throw console.log("Error occurred during fetching folder ID:",e),e}}))}listFiles(t){return n(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken();const o=`https://www.googleapis.com/drive/v3/files?q='${yield this.checkFolder(t)}'+in+parents&spaces=appDataFolder&fields=files(id,name)`;return(yield e.get(o,{headers:{Authorization:`Bearer ${r}`}})).data.files.map((e=>e.name))}catch(e){return console.log("Error listing files:",e),[]}}))}deleteFile(t){return n(this,void 0,void 0,(function*(){const r=t.split("/")[1],o=t.split("/")[0],n=yield this.getFolderId(o),i=yield this.refreshToken(),a=yield this.getFileId(r,n);if(""===a)return console.log("File not found:",r),!1;try{const t=yield e.delete(`https://www.googleapis.com/drive/v3/files/${a}`,{headers:{Authorization:`Bearer ${i}`}});return console.log("File deleted:",t),!0}catch(e){return console.log("Error deleting file:",e),!1}}))}refreshToken(){return n(this,void 0,void 0,(function*(){if(this.config.access_token&&this.config.expires_at>(new Date).getTime())return this.config.access_token;let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"google",refresh_token:e});return this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,t.data.access_token}))}authToken(e){return n(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"google",redirect_uri:a.callbackUrl,code:e})).data.refresh_token}))}getAuthUrl(){return`https://accounts.google.com/o/oauth2/v2/auth?redirect_uri=${a.callbackUrl}&prompt=consent&response_type=code&client_id=${a.googleClientId}&scope=https://www.googleapis.com/auth/drive.appdata&access_type=offline`}}const d=e=>"json"===e?"application/json":["jpg","jpeg","png","gif","bmp"].includes(e)?"image/"+e:"zip"===e?"application/zip":"epub"===e?"application/epub+zip":"txt"===e?"text/plain":"pdf"===e?"application/pdf":"mobi"===e?"application/x-mobipocket-ebook":"azw3"===e||"azw"===e?"application/vnd.amazon.ebook":"cbz"===e?"application/x-cbz":"cbr"===e?"application/x-cbr":"cbt"===e?"application/x-cbt":"cb7"===e?"application/x-cb7":"fb2"===e?"application/x-fictionbook+xml":"html"===e?"text/html":"css"===e?"text/css":"js"===e?"application/javascript":"xml"===e?"application/xml":"xhtml"===e?"application/xhtml+xml":"opf"===e?"application/oebps-package+xml":"ncx"===e?"application/x-dtbncx+xml":"mp3"===e?"audio/mpeg":"wav"===e?"audio/wav":"ogg"===e?"audio/ogg":"mp4"===e?"video/mp4":"webm"===e?"video/webm":"avi"===e?"video/x-msvideo":"wmv"===e?"video/x-ms-wmv":"flv"===e?"video/x-flv":"m3u8"===e?"application/x-mpegURL":"ts"===e?"video/MP2T":"3gp"===e?"video/3gpp":"3g2"===e?"video/3gpp2":"db"===e?"application/x-sqlite3":void 0,p=["books","notes","bookmarks","plugins","words"],f=e=>{var t=new ArrayBuffer(e.byteLength);return new Uint8Array(t).set(new Uint8Array(e)),t},h=e=>{const t=atob(e),r=t.length,o=new Uint8Array(r);for(let e=0;e<r;e++)o[e]=t.charCodeAt(e);return o.buffer},g=e=>{let t="";const r=new Uint8Array(e),o=r.byteLength;for(let e=0;e<o;e++)t+=String.fromCharCode(r[e]);return btoa(t)};function y(e){return n(this,void 0,void 0,(function*(){const t=(new TextEncoder).encode(e),r=yield crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(r)).map((e=>e.toString(16).padStart(2,"0"))).join("")}))}var m={getMimeType:d,databaseList:p,configList:["readerConfig","themeColors","readingTime","recentBooks","deletedBooks","favoriteBooks","shelfList","noteTags","recordLocation","sortedShelfList"],copyArrayBuffer:f,base64ToArrayBuffer:h,arrayBufferToBase64:g,generateSHA256Hash:y};class v extends u{constructor(e,t){super(e,t),this.getData=e=>new Promise(((t,r)=>{if(e){const o=new FileReader;o.onload=r=>t({fileName:e.name,mimeType:e.type,fileSize:e.size,data:r.target.result}),o.onerror=e=>r(e),o.readAsArrayBuffer(e)}else t({})}))}uploadFile(t,r){return new Promise(((o,i)=>n(this,void 0,void 0,(function*(){try{const n=yield this.refreshToken();let i=r.split("/").pop()||"",a=new File([t],i,{lastModified:(new Date).getTime(),type:t.type}),s=r.split(".").pop(),l=d(s||""),c=r.split("/")[0],u=yield this.checkFolder(c),p=yield this.getFileId(i||"",u);const f={mimeType:l,name:i,parents:[u]},h=p?`https://www.googleapis.com/upload/drive/v3/files/${p}?uploadType=resumable`:"https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable",g=(yield e({method:p?"PATCH":"POST",url:h,data:p?null:JSON.stringify(f),headers:{Authorization:"Bearer "+n,"Content-Type":"application/json; charset=UTF-8"}})).headers.location,y=yield this.getData(a);if(0===Object.keys(y).length)return;const m=yield e.put(g,y.data,{headers:{Authorization:"Bearer "+n,"Content-Type":"application/zip","Content-Range":`bytes 0-${y.fileSize-1}/${y.fileSize}`},maxContentLength:1/0,maxBodyLength:1/0});if(m.status>=300)return console.log("Error occurred during file download:",m),void o(!1);o(!0)}catch(e){console.log("Error uploading file:",e),o(!1)}}))))}downloadFile(t){return new Promise(((r,o)=>n(this,void 0,void 0,(function*(){try{const n=yield this.refreshToken();let i=t.split("/").pop(),a=t.split("/")[0],s=yield this.checkFolder(a),l=yield this.getFileId(i||"",s);l||o(new Error("File not found"));const c=`https://www.googleapis.com/drive/v3/files/${l}?alt=media`,u=yield e.get(c,{headers:{Authorization:"Bearer "+n},maxContentLength:1/0,maxBodyLength:1/0,responseType:"arraybuffer"});if(u.status>=300)return console.log("Error occurred during file download:",u),void r(new ArrayBuffer(0));r(u.data)}catch(e){console.log("Error occurred during file download:",e),r(new ArrayBuffer(0))}}))))}}class k{constructor(e,t){this.config=e,this.thirdpartyRequest=t}listFiles(t){return n(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),o=yield e.get(`https://graph.microsoft.com/v1.0/me/drive/special/approot:/${t}:/children`,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});return o.status>=300?[]:o.data.value.map((e=>e.name))}catch(e){return console.log("Error occurred during file list:",e),[]}}))}deleteFile(t){return n(this,void 0,void 0,(function*(){try{const r=yield this.refreshToken(),o=yield e.delete(`https://graph.microsoft.com/v1.0/me/drive/special/approot:/${t}`,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});return!(o.status>=300)||(console.log("Error deleting file:",o),!1)}catch(e){return console.log("Error occurred during file upload:",e),!1}}))}refreshToken(){return n(this,void 0,void 0,(function*(){if(this.config.access_token&&this.config.expires_at>(new Date).getTime())return this.config.access_token;let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"microsoft",refresh_token:e});return this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,t.data.access_token}))}authToken(e){return n(this,void 0,void 0,(function*(){return(yield this.thirdpartyRequest.authThirdToken({provider:"microsoft",redirect_uri:a.callbackUrl,code:e})).data.refresh_token}))}getAuthUrl(){return`https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=${a.microsoftClientId}&scope=files.readwrite.appfolder offline_access&response_type=code&redirect_uri=${a.callbackUrl}`}}class b extends k{constructor(e,t){super(e,t)}uploadFile(t,r){return new Promise(((o,i)=>n(this,void 0,void 0,(function*(){try{const n=yield this.refreshToken();let i=r.split("/").pop()||"",a=new File([t],i,{lastModified:(new Date).getTime(),type:t.type});const s="https://graph.microsoft.com/v1.0/me/drive/special/approot:/"+r+":/createUploadSession",l=yield e.post(s,null,{headers:{Authorization:"Bearer "+n,"Content-Type":"application/json"}});let c=a.size;const u=a.type,d=l.data.uploadUrl,p=yield e.put(d,a,{headers:{"Content-Type":u,"Content-Range":`bytes 0-${c-1}/${c}`},maxContentLength:1/0,maxBodyLength:1/0});if(p.status>=300)return console.log("Error occurred during file download:",p),void o(!1);o(!0)}catch(e){console.log("Error uploading file:",e),o(!1)}}))))}downloadFile(t){return new Promise(((r,o)=>n(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken(),n=`https://graph.microsoft.com/v1.0/me/drive/special/approot:/${t}:/content`,i=yield e.get(n,{responseType:"arraybuffer",headers:{Authorization:"Bearer "+o},maxContentLength:1/0,maxBodyLength:1/0});if(i.status>=300)return console.log("Error occurred during file download:",i),void r(new ArrayBuffer(0));r(i.data)}catch(e){console.log("Error occurred during file download:",e),r(new ArrayBuffer(0))}}))))}}class w{downloadFile(e,t){return n(this,void 0,void 0,(function*(){return new Promise((e=>{e(!0)}))}))}uploadFile(e,t){return n(this,void 0,void 0,(function*(){return new Promise((e=>{e(!0)}))}))}listFiles(e){return n(this,void 0,void 0,(function*(){return new Promise((e=>{e([])}))}))}authToken(e){return n(this,void 0,void 0,(function*(){return new Promise((e=>{e("")}))}))}getAuthUrl(){return""}}class E{constructor(e,t){this.config=e,this.thirdpartyRequest=t}listFiles(e){return n(this,void 0,void 0,(function*(){let{endpoint:t,region:r,bucketName:o,accessKeyId:n,secretAccessKey:i,dir:a}=this.config;try{return(yield this.thirdpartyRequest.s3List({bucket_name:o,prefix:a+"/"+e,region:r,endpoint:t,access_key_id:n,secret_access_key:i})).data.contents.map((e=>e.split("/").pop()))}catch(e){return console.log("Error listing files:",e),[]}}))}deleteFile(e){return n(this,void 0,void 0,(function*(){let{endpoint:t,region:r,bucketName:o,accessKeyId:n,secretAccessKey:i,dir:a}=this.config;try{yield this.thirdpartyRequest.s3Delete({bucket_name:o,object_key:a+"/"+e,region:r,endpoint:t,access_key_id:n,secret_access_key:i});return!0}catch(e){return console.log("Error deleting file:",e),!1}}))}}class C extends E{constructor(e,t){super(e,t)}uploadFile(t,r){return new Promise(((o,i)=>n(this,void 0,void 0,(function*(){let{endpoint:n,region:i,bucketName:a,accessKeyId:s,secretAccessKey:l,dir:c}=this.config;try{const u=(yield this.thirdpartyRequest.s3Upload({bucket_name:a,object_key:c+"/"+r,region:i,endpoint:n,access_key_id:s,secret_access_key:l})).data.url;let d=r.split("/").pop()||"",p=new File([t],d,{lastModified:(new Date).getTime(),type:t.type});yield e.put(u,p,{headers:{}});o(!0)}catch(e){console.log("Error occurred during file upload:",e),o(!1)}}))))}downloadFile(t){return new Promise(((r,o)=>n(this,void 0,void 0,(function*(){let{endpoint:o,region:n,bucketName:i,accessKeyId:a,secretAccessKey:s,dir:l}=this.config;try{const c=(yield this.thirdpartyRequest.s3Download({bucket_name:i,object_key:l+"/"+t,region:n,endpoint:o,access_key_id:a,secret_access_key:s})).data.url,u=yield e({url:c,method:"get",headers:{},responseType:"arraybuffer"});r(u.data)}catch(e){console.log("Error occurred during file download:",e),r(!1)}}))))}}class T{constructor(e){let{username:o,password:n,url:i,dir:a}=e;this.client=t(i,{authType:r.Password,username:o,password:n}),this.username=o,this.password=n,this.dir=a}uploadFile(t,r){return new Promise(((o,i)=>n(this,void 0,void 0,(function*(){try{!1===(yield this.client.exists(r.substring(0,r.lastIndexOf("/"))))&&(yield this.client.createDirectory(r.substring(0,r.lastIndexOf("/"))));let n=r.split("/").pop()||"",i=new File([t],n,{lastModified:(new Date).getTime(),type:t.type}),a=this.client.getFileUploadLink(this.dir+"/"+r);const s=new URL(a);s.search="",a=s.toString();const l=btoa(this.username+":"+this.password);yield e.put(a,i,{headers:{Authorization:"Basic "+l}});o(!0)}catch(e){console.log("Error uploading file:",e),o(!1)}}))))}downloadFile(t){return new Promise(((r,o)=>n(this,void 0,void 0,(function*(){try{const o=this.client.getFileDownloadLink(this.dir+"/"+t),n=btoa(this.username+":"+this.password),i=yield e({url:o,method:"get",headers:{Authorization:"Basic "+n},responseType:"arraybuffer"});if(i.status>=300)return console.log("Error occurred during file download:",i),void r(new ArrayBuffer(0));r(i.data)}catch(e){console.log("Error occurred during file download:",e),o(e)}}))))}listFiles(e){return n(this,void 0,void 0,(function*(){try{return(yield this.client.getDirectoryContents(this.dir+"/"+e)).map((e=>e.basename))}catch(e){return console.log("Error listing files:",e),[]}}))}deleteFile(e){return n(this,void 0,void 0,(function*(){try{return yield this.client.deleteFile(this.dir+"/"+e),!0}catch(e){return console.log("Error deleting file:",e),!1}}))}}const S=["book","config","cover","font"];class R{constructor(e,t,r){this.type=e,this.remote="dropbox"===e?new c(t,r):"microsoft"===e?new b(t,r):"google"===e?new v(t,r):"s3compatible"===e?new C(t,r):"webdav"===e?new T(t):new w}downloadFile(e,t){return n(this,void 0,void 0,(function*(){return(yield this.listFiles(t)).find((t=>e.indexOf(t)>-1))?yield this.remote.downloadFile(t+"/"+e):new ArrayBuffer(0)}))}uploadFile(e,t,r){return n(this,void 0,void 0,(function*(){return yield this.remote.uploadFile(r,t+"/"+e)}))}deleteFile(e,t){return n(this,void 0,void 0,(function*(){return yield this.remote.deleteFile(t+"/"+e)}))}listFiles(e){return n(this,void 0,void 0,(function*(){return yield this.remote.listFiles(e)}))}isExist(e,t){return n(this,void 0,void 0,(function*(){return(yield this.listFiles(e)).find((e=>-1!==e.indexOf(t)))}))}downloadAllFiles(){return n(this,void 0,void 0,(function*(){for(let e of S){let t=yield this.listFiles(e);for(let r of t)yield this.downloadFile(r,e)}}))}authToken(e){return n(this,void 0,void 0,(function*(){return yield this.remote.authToken(e)}))}getAuthUrl(){return this.remote.getAuthUrl?this.remote.getAuthUrl():""}}const A={notes:"SELECT * FROM notes WHERE key = ?",bookmarks:"SELECT * FROM bookmarks WHERE key = ?",books:"SELECT * FROM books WHERE key = ?",plugins:"SELECT * FROM plugins WHERE key = ?",words:"SELECT * FROM words WHERE key = ?"},x={notes:"SELECT * FROM notes WHERE bookKey = ?",bookmarks:"SELECT * FROM bookmarks WHERE bookKey = ?",words:"SELECT * FROM words WHERE bookKey = ?",books:"SELECT * FROM books WHERE key = ?"},O={notes:"DELETE FROM notes WHERE bookKey = ?",bookmarks:"DELETE FROM bookmarks WHERE bookKey = ?",words:"DELETE FROM words WHERE bookKey = ?"};function _(e){for(const t in e)e.hasOwnProperty(t)&&(e[`temp-${t}`]=e[t]);return e}const L={notes:e=>{let t=Object.assign({},e);return t.date=JSON.parse(e.date),t.tag=JSON.parse(e.tag),t},bookmarks:e=>e,books:e=>e,plugins:e=>{let t=Object.assign({},e);return e.autoValue||delete t.autoValue,e.langList?t.langList=JSON.parse(e.langList):delete t.langList,e.voiceList?t.voiceList=JSON.parse(e.voiceList):delete t.voiceList,t.config=JSON.parse(e.config),t},words:e=>{let t=Object.assign({},e);return t.date=JSON.parse(e.date),t}};var I,M={sqlStatement:{createTableStatement:_({notes:'\n      CREATE TABLE IF NOT EXISTS "notes" (\n        "key" text PRIMARY KEY,\n        "bookKey" text,\n        "date" object,\n        "chapter" text,\n        "chapterIndex" integer,\n        "text" text,\n        "cfi" text,\n        "range" text,\n        "notes" text,\n        "percentage" text,\n        "color" integer,\n        "tag" array\n      )\n    ',bookmarks:'\n      CREATE TABLE IF NOT EXISTS "bookmarks" (\n        "key" text PRIMARY KEY,\n        "bookKey" text,\n        "cfi" text,\n        "label" text,\n        "percentage" text,\n        "chapter" text\n      );\n    ',books:'\n      CREATE TABLE IF NOT EXISTS "books" (\n        "key" text PRIMARY KEY,\n        "name" text,\n        "author" text,\n        "description" text,\n        "md5" text,\n        "cover" text,\n        "format" text,\n        "publisher" text,\n        "size" integer,\n        "page" integer,\n        "path" text,\n        "charset" text\n      );\n    ',plugins:'\n      CREATE TABLE IF NOT EXISTS "plugins" (\n        "key" text PRIMARY KEY,\n        "type" text,\n        "displayName" text,\n        "icon" text,\n        "version" text,\n        "config" object,\n        "autoValue" string,\n        "langList" text,\n        "voiceList" text,\n        "scriptSHA256" text,\n        "script" text\n      );\n    ',words:'\n      CREATE TABLE IF NOT EXISTS "words" (\n        "key" text PRIMARY KEY,\n        "bookKey" text,\n        "date" object,\n        "word" text,\n        "chapter" text\n      );\n    '}),getAllStatement:_({notes:"SELECT * FROM notes",bookmarks:"SELECT * FROM bookmarks",books:"SELECT * FROM books",plugins:"SELECT * FROM plugins",words:"SELECT * FROM words"}),saveStatement:_({notes:"INSERT OR REPLACE INTO notes (key, bookKey, chapter, chapterIndex, text, cfi, range, notes, date, percentage, color, tag) VALUES (@key, @bookKey, @chapter, @chapterIndex, @text, @cfi, @range, @notes, @date, @percentage, @color, @tag)",bookmarks:"INSERT OR REPLACE INTO bookmarks (key, bookKey, cfi, label, percentage, chapter) VALUES (@key, @bookKey, @cfi, @label, @percentage, @chapter)",books:"INSERT OR REPLACE INTO books (key, name, author, description, md5, cover, format, publisher, size, page, path, charset) VALUES (@key, @name, @author, @description, @md5, @cover, @format, @publisher, @size, @page, @path, @charset)",plugins:"INSERT OR REPLACE INTO plugins (key, type, displayName, icon, version, config, autoValue, langList, voiceList, scriptSHA256, script) VALUES (@key, @type, @displayName, @icon, @version, @config, @autoValue, @langList, @voiceList, @scriptSHA256, @script)",words:"INSERT OR REPLACE INTO words (key, bookKey, date, word, chapter) VALUES (@key, @bookKey, @date, @word, @chapter)"}),deleteAllStatement:_({notes:"DELETE FROM notes",bookmarks:"DELETE FROM bookmarks",books:"DELETE FROM books",plugins:"DELETE FROM plugins",words:"DELETE FROM words"}),updateStatement:_({notes:"UPDATE notes SET bookKey = @bookKey, chapter = @chapter, chapterIndex = @chapterIndex, text = @text, cfi = @cfi, range = @range, notes = @notes, date = @date, percentage = @percentage, color = @color, tag = @tag WHERE key = @key",bookmarks:"UPDATE bookmarks SET bookKey = @bookKey, cfi = @cfi, label = @label, percentage = @percentage, chapter = @chapter WHERE key = @key",books:"UPDATE books SET name = @name, author = @author, description = @description, md5 = @md5, cover = @cover, format = @format, publisher = @publisher, size = @size, page = @page, path = @path, charset = @charset WHERE key = @key",plugins:"UPDATE plugins SET type = @type, displayName = @displayName, icon = @icon, version = @version, config = @config, autoValue = @autoValue, langList = @langList, voiceList = @voiceList, scriptSHA256 = @scriptSHA256, script = @script WHERE key = @key",words:"UPDATE words SET bookKey = @bookKey, date = @date, word = @word, chapter = @chapter WHERE key = @key"}),deleteStatement:_({notes:"DELETE FROM notes WHERE key = ?",bookmarks:"DELETE FROM bookmarks WHERE key = ?",books:"DELETE FROM books WHERE key = ?",plugins:"DELETE FROM plugins WHERE key = ?",words:"DELETE FROM words WHERE key = ?"}),getStatement:_(A),getByBookKeyStatement:_(x),getByBookKeysStatement:_({notes:e=>`SELECT * FROM notes WHERE bookKey IN (${e.map((()=>"?")).join(",")})`,bookmarks:e=>`SELECT * FROM bookmarks WHERE bookKey IN (${e.map((()=>"?")).join(",")})`,words:e=>`SELECT * FROM words WHERE bookKey IN (${e.map((()=>"?")).join(",")})`,books:e=>`SELECT * FROM books WHERE key IN (${e.map((()=>"?")).join(",")})`}),deleteByBookKeyStatement:_(O)},jsonToSqlite:_({notes:e=>{let t=Object.assign({},e);return t.date=JSON.stringify(e.date),t.tag=JSON.stringify(e.tag),t},bookmarks:e=>e,books:e=>{let t=Object.assign({},e);return t.page=e.page||0,t},plugins:e=>{let t=Object.assign({},e);return e.autoValue||(t.autoValue=null),e.langList?t.langList=JSON.stringify(e.langList):t.langList=null,e.voiceList?t.voiceList=JSON.stringify(e.voiceList):t.voiceList=null,t.config=JSON.stringify(e.config),t},words:e=>{let t=Object.assign({},e);return t.date=JSON.stringify(e.date),t}}),sqliteToJson:_(L)};class j{constructor(e,t,r,o,n,i,a,s,l,c,u,d){this.key=e,this.name=t,this.author=r,this.description=o,this.md5=n,this.cover=i,this.format=a,this.publisher=s,this.size=l,this.page=c,this.path=u,this.charset=d}}class F{static generateBook(e,t,r,o,i,a,s){return new Promise(((l,c)=>n(this,void 0,void 0,(function*(){try{let n,c,u,d,p,f,h,g,y="";switch([c,u,p,d,f,h]=[e,"","","","",0],t){case"pdf":case"epub":case"mobi":case"azw":case"azw3":case"fb2":g=yield s.getMetadata(),[c,u,p,d,y]=[g.name||e,g.author||"",g.description||"",g.publisher||"",g.cover||""];break;case"cbr":case"cbt":case"cbz":case"cb7":g=yield s.getMetadata(),y=g.cover;break;case"txt":g=yield s.getMetadata(a),f=g.charset}let m=t.toUpperCase();n=(new Date).getTime()+"",l(new j(n,c,u,p,r,y,m,d,o,h,i,f))}catch(e){console.log(e),c(e)}}))))}}I=F,F.getRendtion=(e,t,r,o,n,i,a,s)=>{let l;return"CACHE"===t?l=new s.CacheRender(e,{readerMode:r,animation:n,isBionic:i,convertChinese:a}):"MOBI"===t||"AZW3"===t||"AZW"===t?l=new s.MobiRender(e,{readerMode:r,animation:n,isBionic:i,convertChinese:a}):"EPUB"===t?l=new s.EpubRender(e,{readerMode:r,animation:n,isBionic:i,convertChinese:a}):"TXT"===t?l=new s.TxtRender(e,{readerMode:r,animation:n,charset:o,isBionic:i,convertChinese:a}):"MD"===t?l=new s.MdRender(e,{readerMode:r,animation:n,isBionic:i,convertChinese:a}):"PDF"===t?l=new s.PdfRender(e,{readerMode:r,animation:n,isBionic:i,convertChinese:a}):"FB2"===t?l=new s.Fb2Render(e,{readerMode:r,animation:n,isBionic:i,convertChinese:a}):"DOCX"===t?l=new s.DocxRender(e,{readerMode:r,animation:n,isBionic:i,convertChinese:a}):"HTML"===t||"XHTML"===t||"MHTML"===t||"HTM"===t||"XML"===t?l=new s.HtmlRender(e,{readerMode:r,format:t,animation:n,isBionic:i,convertChinese:a}):"CBR"!==t&&"CBT"!==t&&"CBZ"!==t&&"CB7"!==t||(l=new s.ComicRender(f(e),{readerMode:r,format:t,animation:n,isBionic:i,convertChinese:a})),l},F.addMobileBook=(e,t,r,o,i,a)=>n(void 0,void 0,void 0,(function*(){let n=h(e),s=I.getRendtion(n,r.toUpperCase(),"","","","no","no",window.Kookit),l=yield F.generateBook(t,r,o,i,a,n,s);if(!l||!l.key)return;window.ReactNativeWebView.postMessage(JSON.stringify({event:"metadata",bookInfo:l}));let c=yield s.preCache(n);if(""===c)window.ReactNativeWebView.postMessage(JSON.stringify({event:"cache",cacheBase64:"",key:l.key}));else if("err"!==c){let e=g(c);window.ReactNativeWebView.postMessage(JSON.stringify({event:"cache",cacheBase64:e,key:l.key}))}else window.ReactNativeWebView.postMessage(JSON.stringify({event:"error",message:"Parse book failed"}))}));class B{constructor(e){this.accessToken=e}getGoogleFont(t){return n(this,void 0,void 0,(function*(){let r=yield e.post(i.devUrl+"/api/v1/reader/get_google_font",{font_family:t});return{family:r.data.family,variants:JSON.parse(r.data.variants),files:JSON.parse(r.data.files)}}))}}class N{constructor(e,t){this.TokenService=e,this.ConfigService=t}refreshUserToken(){return n(this,void 0,void 0,(function*(){let t=yield this.TokenService.getToken("refresh_token"),r=(yield e.post(i.devUrl+"/api/v1/public/user/refresh_token",{refresh_token:t})).data;return 200===r.code&&(yield this.TokenService.setToken("access_token",r.data.access_token),yield this.TokenService.setToken("refresh_token",r.data.refresh_token)),r}))}requestWithRetry(t){return n(this,void 0,void 0,(function*(){let r=yield this.TokenService.getToken("access_token"),o="req-"+Date.now().toString(36)+"-"+Math.random().toString(36).substring(2,11);t.baseURL=i.devUrl,t.headers={Authorization:"Bearer "+r,"X-Request-ID":o};let n=(yield e(t)).data;if(console.log(n),402===n.code){let o=yield this.refreshUserToken();if(200===o.code){return t.headers=t.headers||{},t.headers.Authorization="Bearer "+r,(yield e(t)).data}return o}return 200!==n.code&&this.ConfigService.setItem("errorLog",JSON.stringify({request:t.data,url:t.url,result:n,requestID:o})),n}))}}class U extends N{constructor(e,t){super(e,t)}encryptToken(e){return n(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/encrypt_token",data:e};return yield this.requestWithRetry(t)}))}decryptToken(e){return n(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/decrypt_token",data:e};return yield this.requestWithRetry(t)}))}authThirdToken(e){return n(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/auth_token",data:e};return yield this.requestWithRetry(t)}))}refreshThirdToken(e){return n(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/refresh_token",data:e};return yield this.requestWithRetry(t)}))}s3Upload(e){return n(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/s3_upload",data:e};return yield this.requestWithRetry(t)}))}s3Download(e){return n(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/s3_download",data:e};return yield this.requestWithRetry(t)}))}s3List(e){return n(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/s3_list",data:e};return yield this.requestWithRetry(t)}))}s3Delete(e){return n(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/pro/thirdparty/s3_delete",data:e};return yield this.requestWithRetry(t)}))}getSyncState(){return n(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"get",url:"/api/v1/pro/thirdparty/get_sync_state"})}))}deleteSyncState(){return n(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"post",url:"/api/v1/pro/thirdparty/delete_sync_state"})}))}}class z extends N{constructor(e,t){super(e,t)}loginRegister(e){return n(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/public/user/login_register",data:e};return yield this.requestWithRetry(t)}))}logout(){return n(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"post",url:"/api/v1/member/user/logout"})}))}getLogins(){return n(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"post",url:"/api/v1/member/user/get_logins"})}))}addLogin(e){return n(this,void 0,void 0,(function*(){console.log("addLogin",e);const t={method:"post",url:"/api/v1/member/user/add_login",data:e};return yield this.requestWithRetry(t)}))}removeLogin(e){return n(this,void 0,void 0,(function*(){const t={method:"post",url:"/api/v1/member/user/remove_login",data:e};return yield this.requestWithRetry(t)}))}getUserInfo(){return n(this,void 0,void 0,(function*(){return yield this.requestWithRetry({method:"post",url:"/api/v1/member/user/get_info"})}))}}var D={getAuthUrl:(e,t)=>{let r="";if("github"===e?r=`https://github.com/login/oauth/authorize?client_id=${a.githubClientId}&redirect_uri=${a.callbackUrl}&scope=openid`:"google"===e?r=`https://accounts.google.com/o/oauth2/v2/auth?redirect_uri=${a.callbackUrl}&prompt=consent&response_type=code&client_id=${a.googleClientId}&scope=openid&access_type=offline`:"facebook"===e?r=`https://www.facebook.com/v12.0/dialog/oauth?client_id=${a.facebookClientId}&redirect_uri=${a.callbackUrl}&scope=&response_type=code`:"microsoft"===e&&(r=`https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=${a.microsoftClientId}&scope=openid profile User.Read offline_access&response_type=code&redirect_uri=${a.callbackUrl}`),"manual"===t)return r;let o=JSON.stringify({deeplink:"desktop"===t?"koodo-reader://callback":"browser"===t?"https://web.koodoreader.com/#/login":"",service:e});return`${r}&state=${"state|"+encodeURIComponent(o)}`}};class P{static CompareDatabase(e,t){return n(this,void 0,void 0,(function*(){let r=Object.keys(e).filter((e=>e.startsWith("database.sqlite.books"))),o=Object.keys(e).filter((e=>e.startsWith("database.sqlite.notes"))),n=Object.keys(e).filter((e=>e.startsWith("database.sqlite.bookmarks"))),i=Object.keys(e).filter((e=>e.startsWith("database.sqlite.plugins"))),a=Object.keys(e).filter((e=>e.startsWith("database.sqlite.words"))),s=Object.keys(t).filter((e=>e.startsWith("database.sqlite.books"))),l=Object.keys(t).filter((e=>e.startsWith("database.sqlite.notes"))),c=Object.keys(t).filter((e=>e.startsWith("database.sqlite.bookmarks"))),u=Object.keys(t).filter((e=>e.startsWith("database.sqlite.plugins"))),d=Object.keys(t).filter((e=>e.startsWith("database.sqlite.words"))),p={books:Array.from(new Set(r.concat(s))),notes:Array.from(new Set(o.concat(l))),bookmarks:Array.from(new Set(n.concat(c))),plugins:Array.from(new Set(i.concat(u))),words:Array.from(new Set(a.concat(d)))},f={books:{save:[],update:[],delete:[],conflict:[],upload:[]},notes:{save:[],update:[],delete:[],conflict:[],upload:[]},bookmarks:{save:[],update:[],delete:[],conflict:[],upload:[]},plugins:{save:[],update:[],delete:[],conflict:[],upload:[]},words:{save:[],update:[],delete:[],conflict:[],upload:[]}},h=["books","notes","bookmarks","plugins","words"];for(let r of h)for(let o of p[r]){let n=o.split(".")[3],i=e[o],a=t[o];i?a?("save"===a.operation&&("update"===i.operation||"delete"===i.operation?f[r].upload.push(n):console.log("ignore",a)),"delete"===a.operation&&("save"===i.operation&&(f[r].delete.push(n),e[o]=a),"update"===i.operation&&(i.time<a.time?(f[r].delete.push(n),e[o]=a):i.time>a.time?f[r].conflict.push(n):console.log("ignore",a)),"delete"===i.operation&&console.log("ignore",a)),"update"===a.operation&&("save"===i.operation&&(f[r].update.push(n),e[o]=a),"update"===i.operation&&(i.time<a.time?(f[r].update.push(n),e[o]=a):i.time>a.time?f[r].upload.push(n):console.log("ignore",a)),"delete"===i.operation&&(i.time<a.time?f[r].conflict.push(n):i.time>a.time?f[r].upload.push(n):console.log("ignore",a)))):f[r].upload.push(n):(f[r].save.push(n),e[o]=a)}return{compareResult:f,syncRecords:e}}))}static CompareConfig(e,t){return n(this,void 0,void 0,(function*(){let r=Object.keys(e).filter((e=>e.startsWith("config.readerConfig"))),o=Object.keys(e).filter((e=>e.startsWith("config.listConfig"))),n=Object.keys(e).filter((e=>e.startsWith("config.objectConfig"))),i=Object.keys(e).filter((e=>e.startsWith("config.mapConfig"))),a=Object.keys(t).filter((e=>e.startsWith("config.readerConfig"))),s=Object.keys(t).filter((e=>e.startsWith("config.listConfig"))),l=Object.keys(t).filter((e=>e.startsWith("config.objectConfig"))),c=Object.keys(t).filter((e=>e.startsWith("config.mapConfig"))),u={readerConfig:Array.from(new Set(r.concat(a))),listConfig:Array.from(new Set(o.concat(s))),objectConfig:Array.from(new Set(n.concat(l))),mapConfig:Array.from(new Set(i.concat(c)))},d={readerConfig:{update:[],upload:[]},listConfig:{update:[],upload:[]},objectConfig:{update:[],delete:[],conflict:[],upload:[]},mapConfig:{update:[],delete:[],conflict:[],upload:[]}},p=["readerConfig","listConfig"];for(let r of p)for(let o of u[r]){let n=o,i=e[o],a=t[o];i?a?i.time<a.time?(d[r].update.push(n),e[o]=a):i.time>a.time?d[r].upload.push(n):console.log("ignore",a):d[r].upload.push(n):(d[r].update.push(n),e[o]=a)}let f=["objectConfig","mapConfig"];for(let r of f)for(let o of u[r]){let n=o,i=e[o],a=t[o];i?a?("delete"===a.operation&&("update"===i.operation&&(i.time<a.time?(d[r].delete.push(n),e[o]=a):i.time>a.time?d[r].conflict.push(n):console.log("ignore",a)),"delete"===i.operation&&console.log("ignore",a)),"update"===a.operation&&("update"===i.operation&&(i.time<a.time?(d[r].update.push(n),e[o]=a):i.time>a.time?d[r].upload.push(n):console.log("ignore",a)),"delete"===i.operation&&(i.time<a.time?d[r].conflict.push(n):i.time>a.time?d[r].upload.push(n):console.log("ignore",a)))):d[r].upload.push(n):(d[r].update.push(n),e[o]=a)}return{compareResult:d,syncRecords:e}}))}static compareAll(e,t){return n(this,void 0,void 0,(function*(){let{compareResult:r,syncRecords:o}=yield this.CompareDatabase(e,t),{compareResult:n,syncRecords:i}=yield this.CompareConfig(o,t);return{compareResult:Object.assign(Object.assign({},r),n),syncRecords:i}}))}static startSync(e,t,r,o,i,a){return n(this,void 0,void 0,(function*(){yield this.syncConfig(e,t,r,i,o),yield this.syncCover(a,i),yield this.syncBook(t,i)}))}static syncConfig(e,t,r,o,i){return n(this,void 0,void 0,(function*(){for(let t of p){if(e[t].save.length+e[t].update.length>0){let o=yield i.getCloudDatabase(t);for(let n of e[t].save){let e=o.find((e=>e.key===n));e&&(yield r.saveRecord(e,t))}for(let n of e[t].update){let e=o.find((e=>e.key===n));e&&(yield r.updateRecord(e,t,!1))}}if(e[t].delete.length>0)for(let n of e[t].delete)yield r.deleteRecord(n,t),"books"===t&&(yield o.deleteOfflineBook(n))}if(e.readerConfig.update.length>0||e.listConfig.update.length>0||e.objectConfig.update.length>0||e.mapConfig.update.length>0){let r=yield i.getCloudConfig("config");for(let o of e.readerConfig.update){let e=o.split(".")[3];r.readerConfig&&t.setReaderConfig(e,JSON.parse(r.readerConfig)[e],!1)}for(let o of e.listConfig.update){let e=o.split(".")[3];r[e]&&t.setAllListConfig(JSON.parse(r[e]),e,!1)}for(let o of e.objectConfig.update){let e=o.split(".")[3],n=o.split(".")[2];r[n]&&JSON.parse(r[n])&&JSON.parse(r[n])[e]&&t.setObjectConfig(e,JSON.parse(r[n])[e],n,!1)}for(let o of e.mapConfig.update){let e=o.split(".")[3],n=o.split(".")[2];if(r[n]&&JSON.parse(r[n])&&JSON.parse(r[n])[e]){let o=JSON.parse(r[n])[e];t.setOneMapConfig(e,o,n,!1)}}}if(e.objectConfig.delete.length>0||e.mapConfig.delete.length>0){for(let r of e.objectConfig.delete){let e=r.split(".")[3],o=r.split(".")[2];t.deleteObjectConfig(e,o)}for(let r of e.mapConfig.delete){let e=r.split(".")[3],o=r.split(".")[2];t.deleteMapConfig(e,o)}}for(let t of p)e[t].upload.length>0&&(yield i.uploadDatabase(t));(e.readerConfig.upload.length>0||e.listConfig.upload.length>0||e.objectConfig.upload.length>0||e.mapConfig.upload.length>0)&&(yield i.uploadConfig("config")),yield i.uploadConfig("sync")}))}static syncCover(e,t){return n(this,void 0,void 0,(function*(){let r=yield e.getLocalCoverList(),o=yield e.getCloudCoverList(),n=yield t.getLocalBookList(),i=Array.from(new Set([...r,...o])),a=[];console.log("localCoverList",r),console.log("cloudCoverList",o),console.log("sumCoverList",i);for(let t of i)r.includes(t)&&!o.includes(t)&&(a.push(e.uploadCover(t)),console.log("upload cover",t)),r.includes(t)||!o.includes(t)||n.find((e=>e.split(".")[0]===t.split(".")[0]))||(a.push(e.downloadCover(t)),console.log("download cover",t));yield Promise.all(a)}))}static syncBook(e,t){return n(this,void 0,void 0,(function*(){let r=yield t.getLocalBookList(),o=yield t.getCloudBookList();console.log(r,"localbooklist"),console.log(o,"cloudbooklist");let n=[],i=Array.from(new Set([...r,...o]));for(let a of i){if(r.includes(a)&&!o.includes(a)){let e=a.split(".")[0],r=a.split(".")[1];n.push(t.uploadBook(e,r)),console.log("upload book",a)}let i="yes"===e.getReaderConfig("autoOffline");if(!r.includes(a)&&o.includes(a)&&i){let e=a.split(".")[0],r=a.split(".")[1];"pdf"===r&&(n.push(t.offlineBook(e,r.toUpperCase())),console.log("download book",a)),"zip"===r&&(n.push(t.offlineBook(e.split("-")[1],r.toUpperCase())),console.log("download book",a))}}yield Promise.all(n)}))}}const W=(q=class{static getItem(e){return localStorage.getItem(e)}static setItem(e,t){localStorage.setItem(e,t)}static removeItem(e){localStorage.removeItem(e)}},class extends q{static getReaderConfig(e){return JSON.parse(this.getItem("readerConfig")||"{}")[e]}static setReaderConfig(e,t,r=!0){let o=JSON.parse(this.getItem("readerConfig")||"{}");o[e]=t,this.setItem("readerConfig",JSON.stringify(o)),r&&this.setSyncRecord({type:"config",catergory:"readerConfig",name:"",key:e},{operation:"update",time:Date.now()})}static getAllListConfig(e){return("{}"!==this.getItem(e)&&this.getItem(e)?JSON.parse(this.getItem(e)||""):[])||[]}static deleteListConfig(e,t){let r=this.getAllListConfig(t);const o=r.indexOf(e);o>-1&&r.splice(o,1),this.setAllListConfig(r,t)}static setListConfig(e,t){let r=this.getAllListConfig(t);const o=r.indexOf(e);o>-1?(r.splice(o,1),r.unshift(e)):r.unshift(e),this.setAllListConfig(r,t)}static setAllListConfig(e,t,r=!0){this.setItem(t,JSON.stringify(e)),r&&this.setSyncRecord({type:"config",catergory:"listConfig",name:"general",key:t},{operation:"update",time:Date.now()})}static setObjectConfig(e,t,r,o=!0){let n=this.getAllObjectConfig(r);n[e]=t,o&&this.setSyncRecord({type:"config",catergory:"objectConfig",name:r,key:e},{operation:"update",time:Date.now()}),this.setAllObjectConfig(n,r)}static getObjectConfig(e,t,r){return this.getAllObjectConfig(t)[e]||r}static getAllObjectConfig(e){let t=this.getItem(e);return JSON.parse(t)||{}}static setAllObjectConfig(e,t){this.setItem(t,JSON.stringify(e))}static deleteObjectConfig(e,t){let r=this.getAllObjectConfig(t);delete r[e],this.setSyncRecord({type:"config",catergory:"objectConfig",name:t,key:e},{operation:"delete",time:Date.now()}),this.setAllObjectConfig(r,t)}static getAllMapConfig(e){let t=this.getItem(e);return JSON.parse(t)||{}}static getMapConfig(e,t){return this.getAllMapConfig(t)[e]||[]}static setAllMapConfig(e,t){this.setItem(t,JSON.stringify(e))}static setMapConfig(e,t,r){let o=this.getAllMapConfig(r);void 0===o[e]&&(o[e]=[]),t&&-1===o[e].indexOf(t)&&o[e].unshift(t),this.setSyncRecord({type:"config",catergory:"mapConfig",name:r,key:e},{operation:"update",time:Date.now()}),this.setAllMapConfig(o,r)}static setOneMapConfig(e,t,r,o=!0){let n=this.getAllMapConfig(r);n[e]=t,o&&this.setSyncRecord({type:"config",catergory:"mapConfig",name:r,key:e},{operation:"update",time:Date.now()}),this.setAllMapConfig(n,r)}static deleteFromMapConfig(e,t,r){let o=this.getAllMapConfig(r),n=o[e].indexOf(t);o[e].splice(n,1),this.setSyncRecord({type:"config",catergory:"mapConfig",name:r,key:e},{operation:"update",time:Date.now()}),this.setAllMapConfig(o,r)}static deleteFromAllMapConfig(e,t){let r=this.getAllMapConfig(t);Object.keys(r).forEach((o=>{let n=r[o].indexOf(e);n>-1&&(r[o].splice(n,1),this.setSyncRecord({type:"config",catergory:"mapConfig",name:t,key:o},{operation:"update",time:Date.now()}))})),this.setAllMapConfig(r,t)}static deleteMapConfig(e,t){let r=this.getAllMapConfig(t);delete r[e],this.setSyncRecord({type:"config",catergory:"mapConfig",name:t,key:e},{operation:"delete",time:Date.now()}),this.setAllMapConfig(r,t)}static getFromAllMapConfig(e,t){let r=this.getAllMapConfig(t),o=[];for(let t in r)r[t]&&r[t].indexOf(e)>-1&&o.push(t);return o}static getSyncRecord(e){return JSON.parse(this.getItem("syncRecord")||"{}")[e.type+"."+e.catergory+"."+e.name+"."+e.key]||{operation:"",time:0}}static getAllSyncRecord(){return JSON.parse(this.getItem("syncRecord")||"{}")}static setSyncRecord(e,t){let r=JSON.parse(this.getItem("syncRecord")||"{}");r[e.type+"."+e.catergory+"."+e.name+"."+e.key]=t,this.setItem("syncRecord",JSON.stringify(r))}static setAllSyncRecord(e){this.setItem("syncRecord",JSON.stringify(e))}});var q;class ${static saveAllToken(e){return n(this,void 0,void 0,(function*(){if(e)if(o){const{ipcRenderer:t}=window.require("electron");t.invoke("encrypt-data",{token:e})}else{const t=yield this.encryptString(e);localStorage.setItem("encryptedToken",t)}}))}static getAllToken(){return n(this,void 0,void 0,(function*(){if(o){const{ipcRenderer:e}=window.require("electron");return yield e.invoke("decrypt-data")}{let e=localStorage.getItem("encryptedToken")||"";return e?yield this.decryptString(e):null}}))}static setToken(e,t){return n(this,void 0,void 0,(function*(){const r=JSON.parse((yield this.getAllToken())||"{}");r[e]=t,yield this.saveAllToken(JSON.stringify(r))}))}static getToken(e){return n(this,void 0,void 0,(function*(){return JSON.parse((yield this.getAllToken())||"{}")[e]||null}))}static deleteToken(e){return n(this,void 0,void 0,(function*(){const t=JSON.parse((yield this.getAllToken())||"{}");delete t[e],yield this.saveAllToken(JSON.stringify(t))}))}static encryptString(e){return n(this,void 0,void 0,(function*(){let t=yield this.getFingerprint();const r=yield crypto.subtle.digest("SHA-256",(new TextEncoder).encode(t)),o=yield crypto.subtle.importKey("raw",r,{name:"AES-GCM",length:256},!1,["encrypt"]),n=crypto.getRandomValues(new Uint8Array(12)),i=(new TextEncoder).encode(e),a=yield crypto.subtle.encrypt({name:"AES-GCM",iv:n},o,i),s=new Uint8Array(a),l=new Uint8Array(n.length+s.length);return l.set(n),l.set(s,n.length),String.fromCharCode(...l)}))}static decryptString(e){return n(this,void 0,void 0,(function*(){let t=yield this.getFingerprint();const r=yield crypto.subtle.digest("SHA-256",(new TextEncoder).encode(t)),o=yield crypto.subtle.importKey("raw",r,{name:"AES-GCM",length:256},!1,["decrypt"]),n=new Uint8Array(e.split("").map((e=>e.charCodeAt(0)))),i=n.slice(0,12),a=n.slice(12),s=yield crypto.subtle.decrypt({name:"AES-GCM",iv:i},o,a);return(new TextDecoder).decode(s)}))}static getFingerprint(){return n(this,void 0,void 0,(function*(){if(o){const{ipcRenderer:e}=window.require("electron");return e.invoke("get-mac")}return yield J.generate()}))}}class J{static getHardwareInfo(){return[navigator.hardwareConcurrency,window.screen.width,window.screen.height,window.devicePixelRatio].join("|")}static getWebGLInfo(){const e=document.createElement("canvas"),t=e.getContext("webgl2")||e.getContext("webgl");return t?[t.getSupportedExtensions(),t.getParameter(t.RED_BITS),t.getParameter(t.GREEN_BITS),t.getParameter(t.BLUE_BITS),t.getParameter(t.ALPHA_BITS),t.getParameter(t.DEPTH_BITS),t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),t.getParameter(t.MAX_RENDERBUFFER_SIZE),t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),t.getParameter(t.MAX_TEXTURE_SIZE),t.getParameter(t.MAX_VARYING_VECTORS),t.getParameter(t.MAX_VERTEX_ATTRIBS),t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS)].join("|"):""}static getFonts(){const e=document.createElement("canvas").getContext("2d");if(!e)return"";return["monospace","sans-serif","serif"].map((t=>(e.font=`72px ${t}`,e.measureText("mmmmmmmmmmlli").width))).join("|")}static getMediaCapabilities(){const e=document.createElement("audio"),t=document.createElement("video");return[e.canPlayType("audio/mp4"),e.canPlayType("audio/webm"),t.canPlayType("video/mp4"),t.canPlayType("video/webm")].join("|")}static hashComponent(e){return n(this,void 0,void 0,(function*(){const t=(new TextEncoder).encode(e),r=yield crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(r)).map((e=>e.toString(16).padStart(2,"0"))).join("")}))}static generate(){return n(this,void 0,void 0,(function*(){const e=yield Promise.all([this.hashComponent(this.getHardwareInfo()),this.hashComponent(this.getWebGLInfo()),this.hashComponent(this.getFonts()),this.hashComponent(this.getMediaCapabilities())]);return yield y(e.join(""))}))}}var K="1.13.7",H="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global||Function("return this")()||{},V=Array.prototype,X=Object.prototype,G="undefined"!=typeof Symbol?Symbol.prototype:null,Q=V.push,Y=V.slice,Z=X.toString,ee=X.hasOwnProperty,te="undefined"!=typeof ArrayBuffer,re="undefined"!=typeof DataView,oe=Array.isArray,ne=Object.keys,ie=Object.create,ae=te&&ArrayBuffer.isView,se=isNaN,le=isFinite,ce=!{toString:null}.propertyIsEnumerable("toString"),ue=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"],de=Math.pow(2,53)-1;function pe(e,t){return t=null==t?e.length-1:+t,function(){for(var r=Math.max(arguments.length-t,0),o=Array(r),n=0;n<r;n++)o[n]=arguments[n+t];switch(t){case 0:return e.call(this,o);case 1:return e.call(this,arguments[0],o);case 2:return e.call(this,arguments[0],arguments[1],o)}var i=Array(t+1);for(n=0;n<t;n++)i[n]=arguments[n];return i[t]=o,e.apply(this,i)}}function fe(e){var t=typeof e;return"function"===t||"object"===t&&!!e}function he(e){return void 0===e}function ge(e){return!0===e||!1===e||"[object Boolean]"===Z.call(e)}function ye(e){var t="[object "+e+"]";return function(e){return Z.call(e)===t}}var me=ye("String"),ve=ye("Number"),ke=ye("Date"),be=ye("RegExp"),we=ye("Error"),Ee=ye("Symbol"),Ce=ye("ArrayBuffer"),Te=ye("Function"),Se=H.document&&H.document.childNodes;"function"!=typeof/./&&"object"!=typeof Int8Array&&"function"!=typeof Se&&(Te=function(e){return"function"==typeof e||!1});var Re=Te,Ae=ye("Object"),xe=re&&(!/\[native code\]/.test(String(DataView))||Ae(new DataView(new ArrayBuffer(8)))),Oe="undefined"!=typeof Map&&Ae(new Map),_e=ye("DataView");var Le=xe?function(e){return null!=e&&Re(e.getInt8)&&Ce(e.buffer)}:_e,Ie=oe||ye("Array");function Me(e,t){return null!=e&&ee.call(e,t)}var je=ye("Arguments");!function(){je(arguments)||(je=function(e){return Me(e,"callee")})}();var Fe=je;function Be(e){return ve(e)&&se(e)}function Ne(e){return function(){return e}}function Ue(e){return function(t){var r=e(t);return"number"==typeof r&&r>=0&&r<=de}}function ze(e){return function(t){return null==t?void 0:t[e]}}var De=ze("byteLength"),Pe=Ue(De),We=/\[object ((I|Ui)nt(8|16|32)|Float(32|64)|Uint8Clamped|Big(I|Ui)nt64)Array\]/;var qe=te?function(e){return ae?ae(e)&&!Le(e):Pe(e)&&We.test(Z.call(e))}:Ne(!1),$e=ze("length");function Je(e,t){t=function(e){for(var t={},r=e.length,o=0;o<r;++o)t[e[o]]=!0;return{contains:function(e){return!0===t[e]},push:function(r){return t[r]=!0,e.push(r)}}}(t);var r=ue.length,o=e.constructor,n=Re(o)&&o.prototype||X,i="constructor";for(Me(e,i)&&!t.contains(i)&&t.push(i);r--;)(i=ue[r])in e&&e[i]!==n[i]&&!t.contains(i)&&t.push(i)}function Ke(e){if(!fe(e))return[];if(ne)return ne(e);var t=[];for(var r in e)Me(e,r)&&t.push(r);return ce&&Je(e,t),t}function He(e,t){var r=Ke(t),o=r.length;if(null==e)return!o;for(var n=Object(e),i=0;i<o;i++){var a=r[i];if(t[a]!==n[a]||!(a in n))return!1}return!0}function Ve(e){return e instanceof Ve?e:this instanceof Ve?void(this._wrapped=e):new Ve(e)}function Xe(e){return new Uint8Array(e.buffer||e,e.byteOffset||0,De(e))}Ve.VERSION=K,Ve.prototype.value=function(){return this._wrapped},Ve.prototype.valueOf=Ve.prototype.toJSON=Ve.prototype.value,Ve.prototype.toString=function(){return String(this._wrapped)};var Ge="[object DataView]";function Qe(e,t,r,o){if(e===t)return 0!==e||1/e==1/t;if(null==e||null==t)return!1;if(e!=e)return t!=t;var n=typeof e;return("function"===n||"object"===n||"object"==typeof t)&&Ye(e,t,r,o)}function Ye(e,t,r,o){e instanceof Ve&&(e=e._wrapped),t instanceof Ve&&(t=t._wrapped);var n=Z.call(e);if(n!==Z.call(t))return!1;if(xe&&"[object Object]"==n&&Le(e)){if(!Le(t))return!1;n=Ge}switch(n){case"[object RegExp]":case"[object String]":return""+e==""+t;case"[object Number]":return+e!=+e?+t!=+t:0==+e?1/+e==1/t:+e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object Symbol]":return G.valueOf.call(e)===G.valueOf.call(t);case"[object ArrayBuffer]":case Ge:return Ye(Xe(e),Xe(t),r,o)}var i="[object Array]"===n;if(!i&&qe(e)){if(De(e)!==De(t))return!1;if(e.buffer===t.buffer&&e.byteOffset===t.byteOffset)return!0;i=!0}if(!i){if("object"!=typeof e||"object"!=typeof t)return!1;var a=e.constructor,s=t.constructor;if(a!==s&&!(Re(a)&&a instanceof a&&Re(s)&&s instanceof s)&&"constructor"in e&&"constructor"in t)return!1}o=o||[];for(var l=(r=r||[]).length;l--;)if(r[l]===e)return o[l]===t;if(r.push(e),o.push(t),i){if((l=e.length)!==t.length)return!1;for(;l--;)if(!Qe(e[l],t[l],r,o))return!1}else{var c,u=Ke(e);if(l=u.length,Ke(t).length!==l)return!1;for(;l--;)if(!Me(t,c=u[l])||!Qe(e[c],t[c],r,o))return!1}return r.pop(),o.pop(),!0}function Ze(e){if(!fe(e))return[];var t=[];for(var r in e)t.push(r);return ce&&Je(e,t),t}function et(e){var t=$e(e);return function(r){if(null==r)return!1;var o=Ze(r);if($e(o))return!1;for(var n=0;n<t;n++)if(!Re(r[e[n]]))return!1;return e!==it||!Re(r[tt])}}var tt="forEach",rt=["clear","delete"],ot=["get","has","set"],nt=rt.concat(tt,ot),it=rt.concat(ot),at=["add"].concat(rt,tt,"has"),st=Oe?et(nt):ye("Map"),lt=Oe?et(it):ye("WeakMap"),ct=Oe?et(at):ye("Set"),ut=ye("WeakSet");function dt(e){for(var t=Ke(e),r=t.length,o=Array(r),n=0;n<r;n++)o[n]=e[t[n]];return o}function pt(e){for(var t={},r=Ke(e),o=0,n=r.length;o<n;o++)t[e[r[o]]]=r[o];return t}function ft(e){var t=[];for(var r in e)Re(e[r])&&t.push(r);return t.sort()}function ht(e,t){return function(r){var o=arguments.length;if(t&&(r=Object(r)),o<2||null==r)return r;for(var n=1;n<o;n++)for(var i=arguments[n],a=e(i),s=a.length,l=0;l<s;l++){var c=a[l];t&&void 0!==r[c]||(r[c]=i[c])}return r}}var gt=ht(Ze),yt=ht(Ke),mt=ht(Ze,!0);function vt(e){if(!fe(e))return{};if(ie)return ie(e);var t=function(){};t.prototype=e;var r=new t;return t.prototype=null,r}function kt(e){return Ie(e)?e:[e]}function bt(e){return Ve.toPath(e)}function wt(e,t){for(var r=t.length,o=0;o<r;o++){if(null==e)return;e=e[t[o]]}return r?e:void 0}function Et(e,t,r){var o=wt(e,bt(t));return he(o)?r:o}function Ct(e){return e}function Tt(e){return e=yt({},e),function(t){return He(t,e)}}function St(e){return e=bt(e),function(t){return wt(t,e)}}function Rt(e,t,r){if(void 0===t)return e;switch(null==r?3:r){case 1:return function(r){return e.call(t,r)};case 3:return function(r,o,n){return e.call(t,r,o,n)};case 4:return function(r,o,n,i){return e.call(t,r,o,n,i)}}return function(){return e.apply(t,arguments)}}function At(e,t,r){return null==e?Ct:Re(e)?Rt(e,t,r):fe(e)&&!Ie(e)?Tt(e):St(e)}function xt(e,t){return At(e,t,1/0)}function Ot(e,t,r){return Ve.iteratee!==xt?Ve.iteratee(e,t):At(e,t,r)}function _t(){}function Lt(e,t){return null==t&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))}Ve.toPath=kt,Ve.iteratee=xt;var It=Date.now||function(){return(new Date).getTime()};function Mt(e){var t=function(t){return e[t]},r="(?:"+Ke(e).join("|")+")",o=RegExp(r),n=RegExp(r,"g");return function(e){return e=null==e?"":""+e,o.test(e)?e.replace(n,t):e}}var jt={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},Ft=Mt(jt),Bt=Mt(pt(jt)),Nt=Ve.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g},Ut=/(.)^/,zt={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},Dt=/\\|'|\r|\n|\u2028|\u2029/g;function Pt(e){return"\\"+zt[e]}var Wt=/^\s*(\w|\$)+\s*$/;var qt=0;function $t(e,t,r,o,n){if(!(o instanceof t))return e.apply(r,n);var i=vt(e.prototype),a=e.apply(i,n);return fe(a)?a:i}var Jt=pe((function(e,t){var r=Jt.placeholder,o=function(){for(var n=0,i=t.length,a=Array(i),s=0;s<i;s++)a[s]=t[s]===r?arguments[n++]:t[s];for(;n<arguments.length;)a.push(arguments[n++]);return $t(e,o,this,this,a)};return o}));Jt.placeholder=Ve;var Kt=pe((function(e,t,r){if(!Re(e))throw new TypeError("Bind must be called on a function");var o=pe((function(n){return $t(e,o,t,this,r.concat(n))}));return o})),Ht=Ue($e);function Vt(e,t,r,o){if(o=o||[],t||0===t){if(t<=0)return o.concat(e)}else t=1/0;for(var n=o.length,i=0,a=$e(e);i<a;i++){var s=e[i];if(Ht(s)&&(Ie(s)||Fe(s)))if(t>1)Vt(s,t-1,r,o),n=o.length;else for(var l=0,c=s.length;l<c;)o[n++]=s[l++];else r||(o[n++]=s)}return o}var Xt=pe((function(e,t){var r=(t=Vt(t,!1,!1)).length;if(r<1)throw new Error("bindAll must be passed function names");for(;r--;){var o=t[r];e[o]=Kt(e[o],e)}return e}));var Gt=pe((function(e,t,r){return setTimeout((function(){return e.apply(null,r)}),t)})),Qt=Jt(Gt,Ve,1);function Yt(e){return function(){return!e.apply(this,arguments)}}function Zt(e,t){var r;return function(){return--e>0&&(r=t.apply(this,arguments)),e<=1&&(t=null),r}}var er=Jt(Zt,2);function tr(e,t,r){t=Ot(t,r);for(var o,n=Ke(e),i=0,a=n.length;i<a;i++)if(t(e[o=n[i]],o,e))return o}function rr(e){return function(t,r,o){r=Ot(r,o);for(var n=$e(t),i=e>0?0:n-1;i>=0&&i<n;i+=e)if(r(t[i],i,t))return i;return-1}}var or=rr(1),nr=rr(-1);function ir(e,t,r,o){for(var n=(r=Ot(r,o,1))(t),i=0,a=$e(e);i<a;){var s=Math.floor((i+a)/2);r(e[s])<n?i=s+1:a=s}return i}function ar(e,t,r){return function(o,n,i){var a=0,s=$e(o);if("number"==typeof i)e>0?a=i>=0?i:Math.max(i+s,a):s=i>=0?Math.min(i+1,s):i+s+1;else if(r&&i&&s)return o[i=r(o,n)]===n?i:-1;if(n!=n)return(i=t(Y.call(o,a,s),Be))>=0?i+a:-1;for(i=e>0?a:s-1;i>=0&&i<s;i+=e)if(o[i]===n)return i;return-1}}var sr=ar(1,or,ir),lr=ar(-1,nr);function cr(e,t,r){var o=(Ht(e)?or:tr)(e,t,r);if(void 0!==o&&-1!==o)return e[o]}function ur(e,t,r){var o,n;if(t=Rt(t,r),Ht(e))for(o=0,n=e.length;o<n;o++)t(e[o],o,e);else{var i=Ke(e);for(o=0,n=i.length;o<n;o++)t(e[i[o]],i[o],e)}return e}function dr(e,t,r){t=Ot(t,r);for(var o=!Ht(e)&&Ke(e),n=(o||e).length,i=Array(n),a=0;a<n;a++){var s=o?o[a]:a;i[a]=t(e[s],s,e)}return i}function pr(e){return function(t,r,o,n){var i=arguments.length>=3;return function(t,r,o,n){var i=!Ht(t)&&Ke(t),a=(i||t).length,s=e>0?0:a-1;for(n||(o=t[i?i[s]:s],s+=e);s>=0&&s<a;s+=e){var l=i?i[s]:s;o=r(o,t[l],l,t)}return o}(t,Rt(r,n,4),o,i)}}var fr=pr(1),hr=pr(-1);function gr(e,t,r){var o=[];return t=Ot(t,r),ur(e,(function(e,r,n){t(e,r,n)&&o.push(e)})),o}function yr(e,t,r){t=Ot(t,r);for(var o=!Ht(e)&&Ke(e),n=(o||e).length,i=0;i<n;i++){var a=o?o[i]:i;if(!t(e[a],a,e))return!1}return!0}function mr(e,t,r){t=Ot(t,r);for(var o=!Ht(e)&&Ke(e),n=(o||e).length,i=0;i<n;i++){var a=o?o[i]:i;if(t(e[a],a,e))return!0}return!1}function vr(e,t,r,o){return Ht(e)||(e=dt(e)),("number"!=typeof r||o)&&(r=0),sr(e,t,r)>=0}var kr=pe((function(e,t,r){var o,n;return Re(t)?n=t:(t=bt(t),o=t.slice(0,-1),t=t[t.length-1]),dr(e,(function(e){var i=n;if(!i){if(o&&o.length&&(e=wt(e,o)),null==e)return;i=e[t]}return null==i?i:i.apply(e,r)}))}));function br(e,t){return dr(e,St(t))}function wr(e,t,r){var o,n,i=-1/0,a=-1/0;if(null==t||"number"==typeof t&&"object"!=typeof e[0]&&null!=e)for(var s=0,l=(e=Ht(e)?e:dt(e)).length;s<l;s++)null!=(o=e[s])&&o>i&&(i=o);else t=Ot(t,r),ur(e,(function(e,r,o){((n=t(e,r,o))>a||n===-1/0&&i===-1/0)&&(i=e,a=n)}));return i}var Er=/[^\ud800-\udfff]|[\ud800-\udbff][\udc00-\udfff]|[\ud800-\udfff]/g;function Cr(e){return e?Ie(e)?Y.call(e):me(e)?e.match(Er):Ht(e)?dr(e,Ct):dt(e):[]}function Tr(e,t,r){if(null==t||r)return Ht(e)||(e=dt(e)),e[Lt(e.length-1)];var o=Cr(e),n=$e(o);t=Math.max(Math.min(t,n),0);for(var i=n-1,a=0;a<t;a++){var s=Lt(a,i),l=o[a];o[a]=o[s],o[s]=l}return o.slice(0,t)}function Sr(e,t){return function(r,o,n){var i=t?[[],[]]:{};return o=Ot(o,n),ur(r,(function(t,n){var a=o(t,n,r);e(i,t,a)})),i}}var Rr=Sr((function(e,t,r){Me(e,r)?e[r].push(t):e[r]=[t]})),Ar=Sr((function(e,t,r){e[r]=t})),xr=Sr((function(e,t,r){Me(e,r)?e[r]++:e[r]=1})),Or=Sr((function(e,t,r){e[r?0:1].push(t)}),!0);function _r(e,t,r){return t in r}var Lr=pe((function(e,t){var r={},o=t[0];if(null==e)return r;Re(o)?(t.length>1&&(o=Rt(o,t[1])),t=Ze(e)):(o=_r,t=Vt(t,!1,!1),e=Object(e));for(var n=0,i=t.length;n<i;n++){var a=t[n],s=e[a];o(s,a,e)&&(r[a]=s)}return r})),Ir=pe((function(e,t){var r,o=t[0];return Re(o)?(o=Yt(o),t.length>1&&(r=t[1])):(t=dr(Vt(t,!1,!1),String),o=function(e,r){return!vr(t,r)}),Lr(e,o,r)}));function Mr(e,t,r){return Y.call(e,0,Math.max(0,e.length-(null==t||r?1:t)))}function jr(e,t,r){return null==e||e.length<1?null==t||r?void 0:[]:null==t||r?e[0]:Mr(e,e.length-t)}function Fr(e,t,r){return Y.call(e,null==t||r?1:t)}var Br=pe((function(e,t){return t=Vt(t,!0,!0),gr(e,(function(e){return!vr(t,e)}))})),Nr=pe((function(e,t){return Br(e,t)}));function Ur(e,t,r,o){ge(t)||(o=r,r=t,t=!1),null!=r&&(r=Ot(r,o));for(var n=[],i=[],a=0,s=$e(e);a<s;a++){var l=e[a],c=r?r(l,a,e):l;t&&!r?(a&&i===c||n.push(l),i=c):r?vr(i,c)||(i.push(c),n.push(l)):vr(n,l)||n.push(l)}return n}var zr=pe((function(e){return Ur(Vt(e,!0,!0))}));function Dr(e){for(var t=e&&wr(e,$e).length||0,r=Array(t),o=0;o<t;o++)r[o]=br(e,o);return r}var Pr=pe(Dr);function Wr(e,t){return e._chain?Ve(t).chain():t}function qr(e){return ur(ft(e),(function(t){var r=Ve[t]=e[t];Ve.prototype[t]=function(){var e=[this._wrapped];return Q.apply(e,arguments),Wr(this,r.apply(Ve,e))}})),Ve}ur(["pop","push","reverse","shift","sort","splice","unshift"],(function(e){var t=V[e];Ve.prototype[e]=function(){var r=this._wrapped;return null!=r&&(t.apply(r,arguments),"shift"!==e&&"splice"!==e||0!==r.length||delete r[0]),Wr(this,r)}})),ur(["concat","join","slice"],(function(e){var t=V[e];Ve.prototype[e]=function(){var e=this._wrapped;return null!=e&&(e=t.apply(e,arguments)),Wr(this,e)}}));var $r=Object.freeze({__proto__:null,VERSION:K,restArguments:pe,isObject:fe,isNull:function(e){return null===e},isUndefined:he,isBoolean:ge,isElement:function(e){return!(!e||1!==e.nodeType)},isString:me,isNumber:ve,isDate:ke,isRegExp:be,isError:we,isSymbol:Ee,isArrayBuffer:Ce,isDataView:Le,isArray:Ie,isFunction:Re,isArguments:Fe,isFinite:function(e){return!Ee(e)&&le(e)&&!isNaN(parseFloat(e))},isNaN:Be,isTypedArray:qe,isEmpty:function(e){if(null==e)return!0;var t=$e(e);return"number"==typeof t&&(Ie(e)||me(e)||Fe(e))?0===t:0===$e(Ke(e))},isMatch:He,isEqual:function(e,t){return Qe(e,t)},isMap:st,isWeakMap:lt,isSet:ct,isWeakSet:ut,keys:Ke,allKeys:Ze,values:dt,pairs:function(e){for(var t=Ke(e),r=t.length,o=Array(r),n=0;n<r;n++)o[n]=[t[n],e[t[n]]];return o},invert:pt,functions:ft,methods:ft,extend:gt,extendOwn:yt,assign:yt,defaults:mt,create:function(e,t){var r=vt(e);return t&&yt(r,t),r},clone:function(e){return fe(e)?Ie(e)?e.slice():gt({},e):e},tap:function(e,t){return t(e),e},get:Et,has:function(e,t){for(var r=(t=bt(t)).length,o=0;o<r;o++){var n=t[o];if(!Me(e,n))return!1;e=e[n]}return!!r},mapObject:function(e,t,r){t=Ot(t,r);for(var o=Ke(e),n=o.length,i={},a=0;a<n;a++){var s=o[a];i[s]=t(e[s],s,e)}return i},identity:Ct,constant:Ne,noop:_t,toPath:kt,property:St,propertyOf:function(e){return null==e?_t:function(t){return Et(e,t)}},matcher:Tt,matches:Tt,times:function(e,t,r){var o=Array(Math.max(0,e));t=Rt(t,r,1);for(var n=0;n<e;n++)o[n]=t(n);return o},random:Lt,now:It,escape:Ft,unescape:Bt,templateSettings:Nt,template:function(e,t,r){!t&&r&&(t=r),t=mt({},t,Ve.templateSettings);var o=RegExp([(t.escape||Ut).source,(t.interpolate||Ut).source,(t.evaluate||Ut).source].join("|")+"|$","g"),n=0,i="__p+='";e.replace(o,(function(t,r,o,a,s){return i+=e.slice(n,s).replace(Dt,Pt),n=s+t.length,r?i+="'+\n((__t=("+r+"))==null?'':_.escape(__t))+\n'":o?i+="'+\n((__t=("+o+"))==null?'':__t)+\n'":a&&(i+="';\n"+a+"\n__p+='"),t})),i+="';\n";var a,s=t.variable;if(s){if(!Wt.test(s))throw new Error("variable is not a bare identifier: "+s)}else i="with(obj||{}){\n"+i+"}\n",s="obj";i="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+i+"return __p;\n";try{a=new Function(s,"_",i)}catch(e){throw e.source=i,e}var l=function(e){return a.call(this,e,Ve)};return l.source="function("+s+"){\n"+i+"}",l},result:function(e,t,r){var o=(t=bt(t)).length;if(!o)return Re(r)?r.call(e):r;for(var n=0;n<o;n++){var i=null==e?void 0:e[t[n]];void 0===i&&(i=r,n=o),e=Re(i)?i.call(e):i}return e},uniqueId:function(e){var t=++qt+"";return e?e+t:t},chain:function(e){var t=Ve(e);return t._chain=!0,t},iteratee:xt,partial:Jt,bind:Kt,bindAll:Xt,memoize:function(e,t){var r=function(o){var n=r.cache,i=""+(t?t.apply(this,arguments):o);return Me(n,i)||(n[i]=e.apply(this,arguments)),n[i]};return r.cache={},r},delay:Gt,defer:Qt,throttle:function(e,t,r){var o,n,i,a,s=0;r||(r={});var l=function(){s=!1===r.leading?0:It(),o=null,a=e.apply(n,i),o||(n=i=null)},c=function(){var c=It();s||!1!==r.leading||(s=c);var u=t-(c-s);return n=this,i=arguments,u<=0||u>t?(o&&(clearTimeout(o),o=null),s=c,a=e.apply(n,i),o||(n=i=null)):o||!1===r.trailing||(o=setTimeout(l,u)),a};return c.cancel=function(){clearTimeout(o),s=0,o=n=i=null},c},debounce:function(e,t,r){var o,n,i,a,s,l=function(){var c=It()-n;t>c?o=setTimeout(l,t-c):(o=null,r||(a=e.apply(s,i)),o||(i=s=null))},c=pe((function(c){return s=this,i=c,n=It(),o||(o=setTimeout(l,t),r&&(a=e.apply(s,i))),a}));return c.cancel=function(){clearTimeout(o),o=i=s=null},c},wrap:function(e,t){return Jt(t,e)},negate:Yt,compose:function(){var e=arguments,t=e.length-1;return function(){for(var r=t,o=e[t].apply(this,arguments);r--;)o=e[r].call(this,o);return o}},after:function(e,t){return function(){if(--e<1)return t.apply(this,arguments)}},before:Zt,once:er,findKey:tr,findIndex:or,findLastIndex:nr,sortedIndex:ir,indexOf:sr,lastIndexOf:lr,find:cr,detect:cr,findWhere:function(e,t){return cr(e,Tt(t))},each:ur,forEach:ur,map:dr,collect:dr,reduce:fr,foldl:fr,inject:fr,reduceRight:hr,foldr:hr,filter:gr,select:gr,reject:function(e,t,r){return gr(e,Yt(Ot(t)),r)},every:yr,all:yr,some:mr,any:mr,contains:vr,includes:vr,include:vr,invoke:kr,pluck:br,where:function(e,t){return gr(e,Tt(t))},max:wr,min:function(e,t,r){var o,n,i=1/0,a=1/0;if(null==t||"number"==typeof t&&"object"!=typeof e[0]&&null!=e)for(var s=0,l=(e=Ht(e)?e:dt(e)).length;s<l;s++)null!=(o=e[s])&&o<i&&(i=o);else t=Ot(t,r),ur(e,(function(e,r,o){((n=t(e,r,o))<a||n===1/0&&i===1/0)&&(i=e,a=n)}));return i},shuffle:function(e){return Tr(e,1/0)},sample:Tr,sortBy:function(e,t,r){var o=0;return t=Ot(t,r),br(dr(e,(function(e,r,n){return{value:e,index:o++,criteria:t(e,r,n)}})).sort((function(e,t){var r=e.criteria,o=t.criteria;if(r!==o){if(r>o||void 0===r)return 1;if(r<o||void 0===o)return-1}return e.index-t.index})),"value")},groupBy:Rr,indexBy:Ar,countBy:xr,partition:Or,toArray:Cr,size:function(e){return null==e?0:Ht(e)?e.length:Ke(e).length},pick:Lr,omit:Ir,first:jr,head:jr,take:jr,initial:Mr,last:function(e,t,r){return null==e||e.length<1?null==t||r?void 0:[]:null==t||r?e[e.length-1]:Fr(e,Math.max(0,e.length-t))},rest:Fr,tail:Fr,drop:Fr,compact:function(e){return gr(e,Boolean)},flatten:function(e,t){return Vt(e,t,!1)},without:Nr,uniq:Ur,unique:Ur,union:zr,intersection:function(e){for(var t=[],r=arguments.length,o=0,n=$e(e);o<n;o++){var i=e[o];if(!vr(t,i)){var a;for(a=1;a<r&&vr(arguments[a],i);a++);a===r&&t.push(i)}}return t},difference:Br,unzip:Dr,transpose:Dr,zip:Pr,object:function(e,t){for(var r={},o=0,n=$e(e);o<n;o++)t?r[e[o]]=t[o]:r[e[o][0]]=e[o][1];return r},range:function(e,t,r){null==t&&(t=e||0,e=0),r||(r=t<e?-1:1);for(var o=Math.max(Math.ceil((t-e)/r),0),n=Array(o),i=0;i<o;i++,e+=r)n[i]=e;return n},chunk:function(e,t){if(null==t||t<1)return[];for(var r=[],o=0,n=e.length;o<n;)r.push(Y.call(e,o,o+=t));return r},mixin:qr,default:Ve}),Jr=qr($r);Jr._=Jr;const Kr=e=>e.map((e=>e.name)),Hr=e=>e.map((e=>e.key)),Vr=(e,t)=>{let r=[];for(let o=0;o<e.length;o++)t.indexOf(e[o])>-1&&r.push(t.indexOf(e[o]));return r.length<t.length&&t.forEach((o=>{if(-1===e.indexOf(o))for(let e=0;e<t.length;e++)if(-1===r.indexOf(e)){r.push(e);break}})),[...new Set(r.map((e=>e-Math.min(...r))))]};class Xr{static sortBooks(e,t,r){let o=e.map((e=>e.key)),n=(e=>e.getAllListConfig("recentBooks"))(r);if(1===t.sort||0===t.sort)return 1===t.order?Vr(n,o).reverse():Vr(n,o);if(2===t.sort){let r=Kr(e),o=Kr(e).sort();return 1===t.order?Vr(o,r).reverse():Vr(o,r)}if(3===t.sort){let r=[];for(let t=0;t<e.length;t++)r.push(t);return 1===t.order?r.reverse():r}if(4===t.sort){let o=(e=>{let t=e.getAllObjectConfig("readingTime");var r=[];for(let e in t)r.push([e,t[e]]);return r.sort((function(e,t){return e[1]-t[1]})),Object.keys(t)})(r),n=Hr(e);return 1===t.order?Vr(Jr.union(o,n),n).reverse():Vr(Jr.union(o,n),n)}if(5===t.sort){let r=Hr(e),o=(e=>Jr.sortBy(e.map((e=>({key:e.key,author:e.author}))),"author").map((e=>e.key)))(e);return 1===t.order?Vr(o,r).reverse():Vr(o,r)}if(6===t.sort){let o=(e=>{let t=e.getAllObjectConfig("recordLocation");var r=[];for(let e in t)r.push([e,t[e].percentage||0]);return r.sort((function(e,t){return e[1]-t[1]})),r.map((e=>e[0]))})(r),n=Hr(e);return 1===t.order?Vr(o,n).reverse():Vr(o,n)}}static sortNotes(e,t,r=[]){if(3===t.sort){let r=Jr.clone(e).reverse(),o=Jr.uniq(e.map((e=>({chapter:e.chapter,chapterIndex:e.chapterIndex}))));o=1===t.order?Jr.sortBy(o,"chapterIndex"):Jr.sortBy(o,"chapterIndex").reverse();let n=Jr.uniq(o.map((e=>e.chapter))),i={};return n.forEach((e=>{i[e]=[]})),r.forEach((e=>{i[e.chapter].push(e)})),n.map((e=>({group:e,notes:i[e]})))||[]}if(2===t.sort){let r=Jr.clone(e).reverse(),o=Jr.uniq(e.map((e=>e.date.year+"-"+e.date.month+"-"+e.date.day)));1===t.order?o.sort():o.sort().reverse();let n={};return o.forEach((e=>{n[e]=[]})),r.forEach((e=>{o.forEach((t=>{t===e.date.year+"-"+e.date.month+"-"+e.date.day&&n[t].push(e)}))})),n||{}}if(1===t.sort){let o=Jr.clone(e).reverse(),n=Jr.uniq(e.map((e=>{let t=Jr.findLastIndex(r,{key:e.bookKey});return t>-1?r[t].name:""})));1===t.order?n.sort():n.sort().reverse();let i={};return n.forEach((e=>{i[e]=[]})),o.forEach((e=>{n.forEach((t=>{let o=Jr.findLastIndex(r,{key:e.bookKey});o>-1&&t===r[o].name&&i[t].push(e)}))})),i||{}}}static sortBookmarks(e,t){if(3===t.sort){let r=Jr.clone(e).reverse(),o=Jr.uniq(e.map((e=>({chapter:e.chapter,chapterIndex:parseInt(JSON.parse(e.cfi).chapterDocIndex)}))));o=1===t.order?Jr.sortBy(o,"chapterIndex"):Jr.sortBy(o,"chapterIndex").reverse();let n=Jr.uniq(o.map((e=>e.chapter))),i={};return n.forEach((e=>{i[e]=[]})),r.forEach((e=>{i[e.chapter].push(e)})),n.map((e=>({group:e,bookmarks:i[e]})))||[]}}}class Gr{static getDefaultCss(e,t=!1){return`::selection{background:#f3a6a68c}::-moz-selection{background:#f3a6a68c}.kookit-note:hover{cursor:pointer;}img{max-width:100% !important}.kookit-text{${this.getCustomCss(e,t)}}code,pre{white-space: pre-wrap;}`}static getCustomCss(e,t=!1){return`font-size: ${e.getReaderConfig(t?"mobileFontSize":"fontSize")}px !important;line-height: ${e.getReaderConfig("lineHeight")||"1.25"} !important;font-family: ${e.getReaderConfig("fontFamily")||""} !important;background-color: transparent;color: ${e.getReaderConfig("textColor")?e.getReaderConfig("textColor"):"rgba(44,47,49,1)"===e.getReaderConfig("backgroundColor")||"night"===e.getReaderConfig("appSkin")||"system"===e.getReaderConfig("appSkin")&&"yes"===e.getReaderConfig("isOSNight")?"white":""} !important;letter-spacing: ${e.getReaderConfig("letterSpacing")?e.getReaderConfig("letterSpacing"):""}px !important;text-align: ${e.getReaderConfig("textAlign")?e.getReaderConfig("textAlign"):""} !important;font-weight: ${"yes"===e.getReaderConfig("isBold")?"bold !important":""};font-style: ${"yes"===e.getReaderConfig("isItalic")?"italic !important":""};text-shadow: ${"yes"===e.getReaderConfig("isShadow")?"2px 2px 2px #cccccc !important":""};text-indent: ${"yes"===e.getReaderConfig("isIndent")?"2rem":""};text-decoration: ${"yes"===e.getReaderConfig("isUnderline")?"underline !important":""};margin-bottom: ${e.getReaderConfig("paraSpacing")||0}px !important;padding:0px !important;word-wrap: break-word !important; writing-mode: horizontal-tb !important;`}}class Qr{static mergeArray(e,t){var r=[];for(let t of e)r.push(t);for(let n of t){var o=!0;for(let t of e)if(n===t){o=!1;break}o&&r.push(n)}return r}static fuzzyQuery(e,t){for(var r=[],o=0;o<e.length;o++)e[o].indexOf(t.trim())>-1&&r.push(o);return r}static mouseSearch(e){let t=document.querySelector(".header-search-box").value.toLowerCase(),r=[],o=[];if(!e)return[];e.forEach((e=>{r.push(e.name.toLowerCase()),o.push(e.author.toLowerCase())}));let n=this.fuzzyQuery(r,t),i=this.fuzzyQuery(o,t);return this.mergeArray(n,i)}static keywordSearch(e,t){let r=[],o=[];if(!t)return[];t.forEach((e=>{r.push(e.name.toLowerCase()),o.push(e.author.toLowerCase())}));let n=this.fuzzyQuery(r,e),i=this.fuzzyQuery(o,e);return this.mergeArray(n,i)}static keySearch(e,t){if(e&&13===e.keyCode){let r=[],o=[];if(!t)return[];t.forEach((e=>{r.push(e.name.toLowerCase()),o.push(e.author.toLowerCase())}));let n=this.fuzzyQuery(r,e.target.value.toLowerCase()),i=this.fuzzyQuery(o,e.target.value.toLowerCase());return this.mergeArray(n,i)}}static mouseNoteSearch(e){let t=document.querySelector(".header-search-box").value.toLowerCase(),r=[],o=[];e.forEach((e=>{r.push(e.notes.toLowerCase()),o.push(e.text.toLowerCase())}));let n=this.fuzzyQuery(r,t),i=this.fuzzyQuery(o,t);return this.mergeArray(n,i)}static keyNoteSearch(e,t){if(e&&13===e.keyCode){let r=[],o=[];t.forEach((e=>{r.push(e.notes.toLowerCase()),o.push(e.text.toLowerCase())}));let n=this.fuzzyQuery(r,e.target.value.toLowerCase()),i=this.fuzzyQuery(o,e.target.value.toLowerCase());return this.mergeArray(n,i)}}}export{F as BookHelper,m as CommonTool,W as ConfigService,s as KookitConfig,D as LoginHelper,B as ReaderRequest,Qr as SearchUtil,Xr as SortUtil,M as SqlStatement,Gr as StyleHelper,P as SyncHelper,R as SyncUtil,U as ThirdpartyRequest,$ as TokenService,z as UserRequest};
