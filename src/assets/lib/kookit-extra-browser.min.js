import e from"axios";import{createClient as t,AuthType as o}from"webdav/dist/web/index.js";function i(e,t,o,i){return new(o||(o=Promise))((function(r,s){function n(e){try{l(i.next(e))}catch(e){s(e)}}function a(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(n,a)}l((i=i.apply(e,t||[])).next())}))}const r={publicUrl:"https://api.960960.xyz",cloudUrl:"https://cloud.960960.xyz",devUrl:"https://cloudtest.960960.xyz"},s={callbackUrl:"https://web.koodoreader.com/",dropboxClientId:"vnc67byrssocvy1",microsoftClientId:"506df58a-29ab-4020-afc5-6f423dc80f35",googleClientId:"1051055003225-ph1f5fvh328dhv7bco5jitlnfhg6ks2t.apps.googleusercontent.com",facebookClientId:"2845583825559500",githubClientId:"Ov23liJVzfvJMMEEZ8v2"};var n={CloudConfig:r,ThirdpartyConfig:s,LoginAuthRequest:{google:{clientId:s.googleClientId,scopes:["openid"],usePKCE:!1,responseType:"code",redirectUri:s.callbackUrl,extraParams:{prompt:"consent",scope:"openid"}},microsoft:{clientId:s.microsoftClientId,scopes:["openid","profile","User.Read","offline_access"],usePKCE:!1,responseType:"code",redirectUri:s.callbackUrl,extraParams:{scope:"openid profile User.Read offline_access"}},facebook:{clientId:s.facebookClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:s.callbackUrl,extraParams:{scope:""}},github:{clientId:s.githubClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:s.callbackUrl,extraParams:{scope:""}}},LoginDiscovery:{microsoft:{authorizationEndpoint:"https://login.microsoftonline.com/common/oauth2/v2.0/authorize",tokenEndpoint:"https://login.microsoftonline.com/common/oauth2/v2.0/token"},google:{authorizationEndpoint:"https://accounts.google.com/o/oauth2/v2/auth",tokenEndpoint:"https://oauth2.googleapis.com/token"},facebook:{authorizationEndpoint:"https://www.facebook.com/v12.0/dialog/oauth",tokenEndpoint:"https://graph.facebook.com/v12.0/oauth/access_token"},github:{authorizationEndpoint:"https://github.com/login/oauth/authorize",tokenEndpoint:"https://github.com/login/oauth/access_token"}},DriveAuthRequest:{dropbox:{clientId:s.dropboxClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:s.callbackUrl,extraParams:{token_access_type:"offline"}},microsoft:{clientId:s.microsoftClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:s.callbackUrl,extraParams:{scope:"files.readwrite.appfolder offline_access"}},google:{clientId:s.googleClientId,scopes:[],usePKCE:!1,responseType:"code",redirectUri:s.callbackUrl,extraParams:{prompt:"consent",scope:"https://www.googleapis.com/auth/drive.appdata",access_type:"offline"}}},DriveDiscovery:{dropbox:{authorizationEndpoint:"https://www.dropbox.com/oauth2/authorize",tokenEndpoint:"https://www.dropbox.com/oauth2/token"},microsoft:{authorizationEndpoint:"https://login.microsoftonline.com/common/oauth2/v2.0/authorize",tokenEndpoint:"https://login.microsoftonline.com/common/oauth2/v2.0/token"},google:{authorizationEndpoint:"https://accounts.google.com/o/oauth2/v2/auth",tokenEndpoint:"https://oauth2.googleapis.com/token"}}};class a{constructor(e,t){this.config=e,this.thirdpartyRequest=t}listFiles(t){return i(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken(),i=yield e.post("https://api.dropboxapi.com/2/files/list_folder",{path:"/"+t},{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});return console.log(i.data.entries.map((e=>e.name))),i.data.entries.map((e=>e.name))}catch(e){return console.error("Error listing files:",e),[]}}))}refreshToken(){return i(this,void 0,void 0,(function*(){if(this.config.access_token&&this.config.expires_at>(new Date).getTime())return this.config.access_token;let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"dropbox",refresh_token:e});return this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,t.data.access_token}))}authToken(e){return i(this,void 0,void 0,(function*(){let t=yield this.thirdpartyRequest.authThirdToken({provider:"dropbox",redirect_uri:s.callbackUrl,code:e});return console.log(t),t.data.refresh_token}))}getAuthUrl(){return`https://www.dropbox.com/oauth2/authorize?response_type=code&token_access_type=offline&client_id=${s.dropboxClientId}&redirect_uri=${s.callbackUrl}`}}class l extends a{constructor(e,t){super(e,t)}uploadFile(t,o){return new Promise(((r,s)=>i(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken();console.log("accessToken",i);let s=o.split("/").pop()||"",n=new File([t],s,{lastModified:(new Date).getTime(),type:t.type});const a=yield e.post("https://content.dropboxapi.com/2/files/upload",n,{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/octet-stream","Dropbox-API-Arg":JSON.stringify({path:"/"+s,mode:"overwrite",autorename:!0,mute:!1})},maxContentLength:1/0,maxBodyLength:1/0});if(console.log("File uploaded successfully:",a),a.status>=300)return console.error("Error occurred during file download:",a),void r(!1);r(!0)}catch(e){console.error("Error uploading file:",e),r(!1)}}))))}downloadFile(t){return new Promise(((o,r)=>i(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken(),r=yield e({url:"https://content.dropboxapi.com/2/files/download",method:"post",headers:{Authorization:`Bearer ${i}`,"Dropbox-API-Arg":JSON.stringify({path:"/"+t})},maxContentLength:1/0,maxBodyLength:1/0,responseType:"arraybuffer"});if(r.status>=300)return console.error("Error occurred during file download:",r),void o(new ArrayBuffer(0));o(r.data)}catch(e){console.error("Error occurred during file download:",e),r(e)}}))))}}class c{constructor(e,t){this.config=e,this.thirdpartyRequest=t}getFileId(t,o){return i(this,void 0,void 0,(function*(){const i=yield this.refreshToken(),r=`https://www.googleapis.com/drive/v3/files?q=name='${t}'+and+'${o}'+in+parents&spaces=appDataFolder&fields=files(id,name)`;try{const t=yield e.get(r,{headers:{Authorization:"Bearer "+i}});if(0===t.data.files.length)return"";const o=t.data.files;return console.log(o),o.length>0?o[0].id:null}catch(e){return console.error("Error occurred during file list retrieval:",e),""}}))}checkFolder(t){return i(this,void 0,void 0,(function*(){const o=yield this.refreshToken(),i=yield this.getFolderId(t);if(i)return console.log("Folder already exists:",i),i;const r={name:t,mimeType:"application/vnd.google-apps.folder",parents:["appDataFolder"]};try{const t=yield e.post("https://www.googleapis.com/drive/v3/files",r,{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});return console.log("Folder created:",t.data.id),t.data.id}catch(e){throw console.error("Error occurred during folder creation:",e),e}}))}getFolderId(t){return i(this,void 0,void 0,(function*(){const o=yield this.refreshToken(),i=`https://www.googleapis.com/drive/v3/files?q=name='${t}'+and+mimeType='application/vnd.google-apps.folder'+and+'appDataFolder'+in+parents&spaces=appDataFolder&fields=files(id,name)`;try{const t=(yield e.get(i,{headers:{Authorization:`Bearer ${o}`}})).data.files;return t.length>0?t[0].id:null}catch(e){throw console.error("Error occurred during fetching folder ID:",e),e}}))}listFiles(t){return i(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken();let i=yield this.checkFolder(t);console.log(i);const r=`https://www.googleapis.com/drive/v3/files?q='${i}'+in+parents&spaces=appDataFolder&fields=files(id,name)`,s=yield e.get(r,{headers:{Authorization:`Bearer ${o}`}});return console.log("Files in folder:",s.data.files.map((e=>e.name))),s.data.files}catch(e){return console.error("Error listing files:",e),[]}}))}refreshToken(){return i(this,void 0,void 0,(function*(){if(this.config.access_token&&this.config.expires_at>(new Date).getTime())return this.config.access_token;let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"google",refresh_token:e});return this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,t.data.access_token}))}authToken(e){return i(this,void 0,void 0,(function*(){let t=yield this.thirdpartyRequest.authThirdToken({provider:"google",redirect_uri:s.callbackUrl,code:e});return console.log(t),t.data.refresh_token}))}getAuthUrl(){return`https://accounts.google.com/o/oauth2/v2/auth?redirect_uri=${s.callbackUrl}&prompt=consent&response_type=code&client_id=${s.googleClientId}&scope=https://www.googleapis.com/auth/drive.appdata&access_type=offline`}}const d=e=>"json"===e?"application/json":["jpg","jpeg","png","gif","bmp"].includes(e)?"image/"+e:"zip"===e?"application/zip":"epub"===e?"application/epub+zip":"txt"===e?"text/plain":"pdf"===e?"application/pdf":"mobi"===e?"application/x-mobipocket-ebook":"azw3"===e||"azw"===e?"application/vnd.amazon.ebook":"cbz"===e?"application/x-cbz":"cbr"===e?"application/x-cbr":"cbt"===e?"application/x-cbt":"cb7"===e?"application/x-cb7":"fb2"===e?"application/x-fictionbook+xml":"html"===e?"text/html":"css"===e?"text/css":"js"===e?"application/javascript":"xml"===e?"application/xml":"xhtml"===e?"application/xhtml+xml":"opf"===e?"application/oebps-package+xml":"ncx"===e?"application/x-dtbncx+xml":"mp3"===e?"audio/mpeg":"wav"===e?"audio/wav":"ogg"===e?"audio/ogg":"mp4"===e?"video/mp4":"webm"===e?"video/webm":"avi"===e?"video/x-msvideo":"wmv"===e?"video/x-ms-wmv":"flv"===e?"video/x-flv":"m3u8"===e?"application/x-mpegURL":"ts"===e?"video/MP2T":"3gp"===e?"video/3gpp":"3g2"===e?"video/3gpp2":"db"===e?"application/x-sqlite3":void 0,p=["books","notes","bookmarks","plugins","words"];var u={getMimeType:d,databaseList:p,configList:["readerConfig","themeColors","readingTime","recentBooks","deletedBooks","favoriteBooks","shelfList","noteTags","recordLocation","dataSourceList","sortedShelfList"]};class h extends c{constructor(e,t){super(e,t),this.getData=e=>new Promise(((t,o)=>{if(e){const i=new FileReader;i.onload=o=>t({fileName:e.name,mimeType:e.type,fileSize:e.size,data:o.target.result}),i.onerror=e=>o(e),i.readAsArrayBuffer(e)}else t({})}))}uploadFile(t,o){return new Promise(((r,s)=>i(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken();console.log(i);let s=o.split("/").pop()||"",n=new File([t],s,{lastModified:(new Date).getTime(),type:t.type}),a=o.split(".").pop(),l=d(a||""),c=o.split("/")[0],p=yield this.checkFolder(c),u=yield this.getFileId(s||"",p);console.log(u,"fileId");const h={mimeType:l,name:s,parents:[p]},g=u?`https://www.googleapis.com/upload/drive/v3/files/${u}?uploadType=resumable`:"https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable";console.log(g);const f=(yield e({method:u?"PATCH":"POST",url:g,data:u?null:JSON.stringify(h),headers:{Authorization:"Bearer "+i,"Content-Type":"application/json; charset=UTF-8"}})).headers.location;console.log(f);const y=yield this.getData(n);if(0===Object.keys(y).length)return void console.log("No file.");const m=yield e.put(f,y.data,{headers:{Authorization:"Bearer "+i,"Content-Type":"application/zip","Content-Range":`bytes 0-${y.fileSize-1}/${y.fileSize}`},maxContentLength:1/0,maxBodyLength:1/0});if(console.log("File uploaded successfully:",m),m.status>=300)return console.error("Error occurred during file download:",m),void r(!1);r(!0)}catch(e){console.error("Error uploading file:",e),r(!1)}}))))}downloadFile(t){return new Promise(((o,r)=>i(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken();let s=t.split("/").pop(),n=t.split("/")[0],a=yield this.checkFolder(n),l=yield this.getFileId(s||"",a);l||(console.error("File not found"),r(new Error("File not found")));const c=`https://www.googleapis.com/drive/v3/files/${l}?alt=media`,d=yield e.get(c,{headers:{Authorization:"Bearer "+i},maxContentLength:1/0,maxBodyLength:1/0,responseType:"arraybuffer"});o(d.data)}catch(e){console.error("Error occurred during file download:",e),r(e)}}))))}}class g{constructor(e,t){this.config=e,this.thirdpartyRequest=t}listFiles(t){return i(this,void 0,void 0,(function*(){try{const o=yield this.refreshToken(),i=yield e.get(`https://graph.microsoft.com/v1.0/me/drive/special/approot:/${t}:/children`,{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});return i.status>=300?[]:(console.log("Files in folder:",i.data.value.map((e=>e.name))),i.data.value.map((e=>e.name)))}catch(e){return console.error("Error listing files:",e),[]}}))}refreshToken(){return i(this,void 0,void 0,(function*(){if(this.config.access_token&&this.config.expires_at>(new Date).getTime())return this.config.access_token;let e=this.config.refresh_token,t=yield this.thirdpartyRequest.refreshThirdToken({provider:"microsoft",refresh_token:e});return this.config.access_token=t.data.access_token,this.config.expires_at=(new Date).getTime()+1e3*t.data.expires_in,t.data.access_token}))}authToken(e){return i(this,void 0,void 0,(function*(){console.log(e,"safdfsfd"),console.log({provider:"microsoft",redirect_uri:s.callbackUrl,code:e}),console.log(this.thirdpartyRequest,"this.thirdpartyRequest");let t=yield this.thirdpartyRequest.authThirdToken({provider:"microsoft",redirect_uri:s.callbackUrl,code:e});return console.log(t),t.data.refresh_token}))}getAuthUrl(){return`https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=${s.microsoftClientId}&scope=files.readwrite.appfolder offline_access&response_type=code&redirect_uri=${s.callbackUrl}`}}class f extends g{constructor(e,t){super(e,t)}uploadFile(t,o){return new Promise(((r,s)=>i(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken();console.log(i);let s=o.split("/").pop()||"",n=new File([t],s,{lastModified:(new Date).getTime(),type:t.type});const a="https://graph.microsoft.com/v1.0/me/drive/special/approot:/"+o+":/createUploadSession",l=(yield e.post(a,null,{headers:{Authorization:"Bearer "+i,"Content-Type":"application/json"}})).data.uploadUrl,c=yield e.put(l,n,{headers:{Authorization:"Bearer "+i,"Content-Type":n.type},maxContentLength:1/0,maxBodyLength:1/0});if(console.log("File uploaded successfully:",c),c.status>=300)return console.error("Error occurred during file download:",c),void r(!1);r(!0)}catch(e){console.error("Error uploading file:",e),r(!1)}}))))}downloadFile(t){return new Promise(((o,r)=>i(this,void 0,void 0,(function*(){try{const i=yield this.refreshToken(),r=`https://graph.microsoft.com/v1.0/me/drive/special/approot:/${t}:/content`,s=yield e.get(r,{responseType:"arraybuffer",headers:{Authorization:"Bearer "+i},maxContentLength:1/0,maxBodyLength:1/0});o(s.data)}catch(e){console.error("Error occurred during file download:",e),r(e)}}))))}}class y{downloadFile(e,t){return i(this,void 0,void 0,(function*(){return new Promise((e=>{e(!0)}))}))}uploadFile(e,t){return i(this,void 0,void 0,(function*(){return new Promise((e=>{e(!0)}))}))}listFiles(e){return i(this,void 0,void 0,(function*(){return new Promise((e=>{e([])}))}))}authToken(e){return i(this,void 0,void 0,(function*(){return new Promise((e=>{e("")}))}))}getAuthUrl(){return""}}class m{constructor(e,t){this.config=e,this.thirdpartyRequest=t}uploadFile(t,o){return new Promise(((r,s)=>i(this,void 0,void 0,(function*(){let{endpoint:i,region:s,bucketName:n,accessKeyId:a,secretAccessKey:l}=this.config;try{const c=(yield this.thirdpartyRequest.s3Upload({bucket_name:n,object_key:o,region:s,endpoint:i,access_key_id:a,secret_access_key:l})).data.url;let d=o.split("/").pop()||"",p=new File([t],d,{lastModified:(new Date).getTime(),type:t.type});const u=yield e.put(c,p,{headers:{}});console.log("File uploaded successfully:",u),r(!0)}catch(e){console.error("Error occurred during file upload:",e),r(!1)}}))))}downloadFile(t){return new Promise(((o,r)=>i(this,void 0,void 0,(function*(){let{endpoint:i,region:r,bucketName:s,accessKeyId:n,secretAccessKey:a}=this.config;try{const l=(yield this.thirdpartyRequest.s3Download({bucket_name:s,object_key:t,region:r,endpoint:i,access_key_id:n,secret_access_key:a})).data.url,c=yield e({url:l,method:"post",headers:{},responseType:"arraybuffer"});o(c.data)}catch(e){console.error("Error occurred during file download:",e),o(!1)}}))))}listFiles(e){return i(this,void 0,void 0,(function*(){let{endpoint:t,region:o,bucketName:i,accessKeyId:r,secretAccessKey:s}=this.config;try{let n=yield this.thirdpartyRequest.s3List({bucket_name:i,object_key:e,region:o,endpoint:t,access_key_id:r,secret_access_key:s});return console.log("Files in folder:",n.data.contents.map((e=>e.split("/").pop()))),n.data.contents.map((e=>e.split("/").pop()))}catch(e){return console.error("Error listing files:",e),[]}}))}}class k{constructor(e){let{username:i,password:r,url:s}=e;this.client=t(s,{authType:o.Password,username:i,password:r}),this.username=i,this.password=r}uploadFile(t,o){return new Promise(((r,s)=>i(this,void 0,void 0,(function*(){try{!1===(yield this.client.exists(o.substring(0,o.lastIndexOf("/"))))&&(yield this.client.createDirectory(o.substring(0,o.lastIndexOf("/"))));let i=o.split("/").pop()||"",s=new File([t],i,{lastModified:(new Date).getTime(),type:t.type}),n=this.client.getFileUploadLink(o);const a=new URL(n);a.search="",n=a.toString();const l=btoa(this.username+":"+this.password),c=yield e.put(n,s,{headers:{Authorization:"Basic "+l}});console.log("File uploaded successfully:",c),r(!0)}catch(e){console.error("Error uploading file:",e),r(!1)}}))))}downloadFile(t){return new Promise(((o,r)=>i(this,void 0,void 0,(function*(){try{const i=this.client.getFileDownloadLink(t);console.log(i);const r=btoa(this.username+":"+this.password),s=yield e({url:i,method:"get",headers:{Authorization:"Basic "+r},responseType:"arraybuffer"});if(s.status>=300)return console.error("Error occurred during file download:",s),void o(new ArrayBuffer(0));o(s.data)}catch(e){console.error("Error occurred during file download:",e),r(e)}}))))}listFiles(e){return i(this,void 0,void 0,(function*(){try{let t=yield this.client.getDirectoryContents(e);return console.log(t.map((e=>e.basename))),t.map((e=>e.basename))}catch(e){return console.error("Error listing files:",e),[]}}))}}const v=["book","config","cover","font"];class b{constructor(e,t,o){this.type=e,this.remote="dropbox"===e?new l(t,o):"microsoft"===e?new f(t,o):"google"===e?new h(t,o):"s3compatible"===e?new m(t,o):"webdav"===e?new k(t):new y}downloadFile(e,t){return i(this,void 0,void 0,(function*(){return yield this.remote.downloadFile(t+"/"+e)}))}uploadFile(e,t,o){return i(this,void 0,void 0,(function*(){return yield this.remote.uploadFile(o,t+"/"+e)}))}listFiles(e){return i(this,void 0,void 0,(function*(){return yield this.remote.listFiles(e)}))}downloadAllFiles(){return i(this,void 0,void 0,(function*(){for(let e of v){let t=yield this.listFiles(e);for(let o of t)yield this.downloadFile(o,e)}}))}authToken(e){return i(this,void 0,void 0,(function*(){return yield this.remote.authToken(e)}))}getAuthUrl(){return this.remote.getAuthUrl?this.remote.getAuthUrl():""}}const E={notes:"SELECT * FROM notes WHERE key = ?",bookmarks:"SELECT * FROM bookmarks WHERE key = ?",books:"SELECT * FROM books WHERE key = ?",plugins:"SELECT * FROM plugins WHERE key = ?",words:"SELECT * FROM words WHERE key = ?"},w={notes:"SELECT * FROM notes WHERE bookKey = ?",bookmarks:"SELECT * FROM bookmarks WHERE bookKey = ?",words:"SELECT * FROM words WHERE bookKey = ?",books:"SELECT * FROM books WHERE key = ?"},T={notes:"DELETE FROM notes WHERE bookKey = ?",bookmarks:"DELETE FROM bookmarks WHERE bookKey = ?",words:"DELETE FROM words WHERE bookKey = ?"};function R(e){for(const t in e)e.hasOwnProperty(t)&&(e[`temp-${t}`]=e[t]);return e}const C={notes:e=>{let t=Object.assign({},e);return t.date=JSON.parse(e.date),t.tag=JSON.parse(e.tag),t},bookmarks:e=>e,books:e=>e,plugins:e=>{let t=Object.assign({},e);return e.autoValue||delete t.autoValue,e.langList?t.langList=JSON.parse(e.langList):delete t.langList,e.voiceList?t.voiceList=JSON.parse(e.voiceList):delete t.voiceList,t.config=JSON.parse(e.config),t},words:e=>{let t=Object.assign({},e);return t.date=JSON.parse(e.date),t}};var x={sqlStatement:{createTableStatement:R({notes:'\n      CREATE TABLE IF NOT EXISTS "notes" (\n        "key" text PRIMARY KEY,\n        "bookKey" text,\n        "date" object,\n        "chapter" text,\n        "chapterIndex" integer,\n        "text" text,\n        "cfi" text,\n        "range" text,\n        "notes" text,\n        "percentage" text,\n        "color" integer,\n        "tag" array\n      )\n    ',bookmarks:'\n      CREATE TABLE IF NOT EXISTS "bookmarks" (\n        "key" text PRIMARY KEY,\n        "bookKey" text,\n        "cfi" text,\n        "label" text,\n        "percentage" text,\n        "chapter" text\n      );\n    ',books:'\n      CREATE TABLE IF NOT EXISTS "books" (\n        "key" text PRIMARY KEY,\n        "name" text,\n        "author" text,\n        "description" text,\n        "md5" text,\n        "cover" text,\n        "format" text,\n        "publisher" text,\n        "size" integer,\n        "page" integer,\n        "path" text,\n        "charset" text\n      );\n    ',plugins:'\n      CREATE TABLE IF NOT EXISTS "plugins" (\n        "key" text PRIMARY KEY,\n        "type" text,\n        "displayName" text,\n        "icon" text,\n        "version" text,\n        "config" object,\n        "autoValue" string,\n        "langList" text,\n        "voiceList" text,\n        "scriptSHA256" text,\n        "script" text\n      );\n    ',words:'\n      CREATE TABLE IF NOT EXISTS "words" (\n        "key" text PRIMARY KEY,\n        "bookKey" text,\n        "date" object,\n        "word" text,\n        "chapter" text\n      );\n    '}),getAllStatement:R({notes:"SELECT * FROM notes",bookmarks:"SELECT * FROM bookmarks",books:"SELECT * FROM books",plugins:"SELECT * FROM plugins",words:"SELECT * FROM words"}),saveStatement:R({notes:"INSERT OR REPLACE INTO notes (key, bookKey, chapter, chapterIndex, text, cfi, range, notes, date, percentage, color, tag) VALUES (@key, @bookKey, @chapter, @chapterIndex, @text, @cfi, @range, @notes, @date, @percentage, @color, @tag)",bookmarks:"INSERT OR REPLACE INTO bookmarks (key, bookKey, cfi, label, percentage, chapter) VALUES (@key, @bookKey, @cfi, @label, @percentage, @chapter)",books:"INSERT OR REPLACE INTO books (key, name, author, description, md5, cover, format, publisher, size, page, path, charset) VALUES (@key, @name, @author, @description, @md5, @cover, @format, @publisher, @size, @page, @path, @charset)",plugins:"INSERT OR REPLACE INTO plugins (key, type, displayName, icon, version, config, autoValue, langList, voiceList, scriptSHA256, script) VALUES (@key, @type, @displayName, @icon, @version, @config, @autoValue, @langList, @voiceList, @scriptSHA256, @script)",words:"INSERT OR REPLACE INTO words (key, bookKey, date, word, chapter) VALUES (@key, @bookKey, @date, @word, @chapter)"}),deleteAllStatement:R({notes:"DELETE FROM notes",bookmarks:"DELETE FROM bookmarks",books:"DELETE FROM books",plugins:"DELETE FROM plugins",words:"DELETE FROM words"}),updateStatement:R({notes:"UPDATE notes SET bookKey = @bookKey, chapter = @chapter, chapterIndex = @chapterIndex, text = @text, cfi = @cfi, range = @range, notes = @notes, date = @date, percentage = @percentage, color = @color, tag = @tag WHERE key = @key",bookmarks:"UPDATE bookmarks SET bookKey = @bookKey, cfi = @cfi, label = @label, percentage = @percentage, chapter = @chapter WHERE key = @key",books:"UPDATE books SET name = @name, author = @author, description = @description, md5 = @md5, cover = @cover, format = @format, publisher = @publisher, size = @size, page = @page, path = @path, charset = @charset WHERE key = @key",plugins:"UPDATE plugins SET type = @type, displayName = @displayName, icon = @icon, version = @version, config = @config, autoValue = @autoValue, langList = @langList, voiceList = @voiceList, scriptSHA256 = @scriptSHA256, script = @script WHERE key = @key",words:"UPDATE words SET bookKey = @bookKey, date = @date, word = @word, chapter = @chapter WHERE key = @key"}),deleteStatement:R({notes:"DELETE FROM notes WHERE key = ?",bookmarks:"DELETE FROM bookmarks WHERE key = ?",books:"DELETE FROM books WHERE key = ?",plugins:"DELETE FROM plugins WHERE key = ?",words:"DELETE FROM words WHERE key = ?"}),getStatement:R(E),getByBookKeyStatement:R(w),getByBookKeysStatement:R({notes:e=>`SELECT * FROM notes WHERE bookKey IN (${e.map((()=>"?")).join(",")})`,bookmarks:e=>`SELECT * FROM bookmarks WHERE bookKey IN (${e.map((()=>"?")).join(",")})`,words:e=>`SELECT * FROM words WHERE bookKey IN (${e.map((()=>"?")).join(",")})`,books:e=>`SELECT * FROM books WHERE key IN (${e.map((()=>"?")).join(",")})`}),deleteByBookKeyStatement:R(T)},jsonToSqlite:R({notes:e=>{let t=Object.assign({},e);return t.date=JSON.stringify(e.date),t.tag=JSON.stringify(e.tag),t},bookmarks:e=>e,books:e=>{let t=Object.assign({},e);return t.page=e.page||0,t},plugins:e=>{let t=Object.assign({},e);return e.autoValue||(t.autoValue=null),e.langList?t.langList=JSON.stringify(e.langList):t.langList=null,e.voiceList?t.voiceList=JSON.stringify(e.voiceList):t.voiceList=null,t.config=JSON.stringify(e.config),t},words:e=>{let t=Object.assign({},e);return t.date=JSON.stringify(e.date),t}}),sqliteToJson:R(C)};class S{constructor(e,t,o,i,r,s,n,a,l,c,d,p){this.key=e,this.name=t,this.author=o,this.description=i,this.md5=r,this.cover=s,this.format=n,this.publisher=a,this.size=l,this.page=c,this.path=d,this.charset=p}}var L;class O{static generateBook(e,t,o,r,s,n,a){return new Promise(((l,c)=>i(this,void 0,void 0,(function*(){try{let i,c,d,p,u,h,g,f,y="";switch([c,d,u,p,h,g]=[e,"","","","",0],t){case"pdf":case"epub":case"mobi":case"azw":case"azw3":case"fb2":f=yield a.getMetadata(),[c,d,u,p,y]=[f.name||e,f.author||"",f.description||"",f.publisher||"",f.cover||""];break;case"cbr":case"cbt":case"cbz":case"cb7":f=yield a.getMetadata(),y=f.cover;break;case"txt":f=yield a.getMetadata(n),h=f.charset}let m=t.toUpperCase();i=(new Date).getTime()+"",l(new S(i,c,d,u,o,y,m,p,r,g,s,h))}catch(e){console.log(e),c(e)}}))))}}L=O,O.getRendtion=(e,t,o,i,r,s)=>{let n;var a,l;return"CACHE"===t?n=new s.CacheRender(e,o,r):"MOBI"===t||"AZW3"===t||"AZW"===t?n=new s.MobiRender(e,o,r):"EPUB"===t?n=new s.EpubRender(e,o,r):"TXT"===t?n=new s.TxtRender(e,o,r,i):"MD"===t?n=new s.MdRender(e,o,r):"PDF"===t?n=new s.PdfRender(e,o,r):"FB2"===t?n=new s.Fb2Render(e,o,r):"DOCX"===t?n=new s.DocxRender(e,o,r):"HTML"===t||"XHTML"===t||"MHTML"===t||"HTM"===t||"XML"===t?n=new s.HtmlRender(e,o,t,r):"CBR"!==t&&"CBT"!==t&&"CBZ"!==t&&"CB7"!==t||(n=new s.ComicRender((a=e,l=new ArrayBuffer(a.byteLength),new Uint8Array(l).set(new Uint8Array(a)),l),o,t,r)),n},O.addMobileBook=(e,t,o,r,s,n)=>i(void 0,void 0,void 0,(function*(){let i=(e=>{const t=atob(e),o=t.length,i=new Uint8Array(o);for(let e=0;e<o;e++)i[e]=t.charCodeAt(e);return i.buffer})(e),a=L.getRendtion(i,o.toUpperCase(),"","","",window.Kookit),l=yield O.generateBook(t,o,r,s,n,i,a);if(!l||!l.key)return;window.ReactNativeWebView.postMessage(JSON.stringify({event:"metadata",bookInfo:l}));let c=yield a.preCache(i);if("err"!==c){let e=(e=>{let t="";const o=new Uint8Array(e),i=o.byteLength;for(let e=0;e<i;e++)t+=String.fromCharCode(o[e]);return btoa(t)})(c);window.ReactNativeWebView.postMessage(JSON.stringify({event:"cache",cacheBase64:e,key:l.key}))}else window.ReactNativeWebView.postMessage(JSON.stringify({event:"error",message:"Parse book failed"}))}));class _{constructor(e){this.accessToken=e}getGoogleFont(t){return i(this,void 0,void 0,(function*(){let o=yield e.post(r.devUrl+"/api/v1/reader/get_google_font",{font_family:t});return console.log(o.data,"res.data"),{family:o.data.family,variants:JSON.parse(o.data.variants),files:JSON.parse(o.data.files)}}))}}class F{constructor(e){this.TokenService=e}refreshUserToken(){return i(this,void 0,void 0,(function*(){let t=yield this.TokenService.getToken("refresh_token"),o=(yield e.post(r.devUrl+"/api/v1/public/user/refresh_token",{refresh_token:t})).data;return console.log(o,"result"),200===o.code&&(yield this.TokenService.setToken("access_token",o.data.access_token),yield this.TokenService.setToken("refresh_token",o.data.refresh_token)),o}))}requestWithRetry(t){return i(this,void 0,void 0,(function*(){let o=yield this.TokenService.getToken("access_token");t.baseURL=r.devUrl,t.headers={Authorization:"Bearer "+o};let i=yield e(t);console.log(i.data,"res.data");let s=i.data;if(402===s.code){let i=yield this.refreshUserToken();if(200===i.code){return t.headers=t.headers||{},t.headers.Authorization="Bearer "+o,(yield e(t)).data}return i}return s}))}}class A extends F{constructor(e){super(e)}encryptToken(e){return i(this,void 0,void 0,(function*(){console.log(e,"request");const t={method:"post",url:"/api/v1/pro/thirdparty/encrypt_token",data:e};let o=yield this.requestWithRetry(t);return console.log(o,"result"),o}))}decryptToken(e){return i(this,void 0,void 0,(function*(){console.log(e,"request");const t={method:"post",url:"/api/v1/pro/thirdparty/decrypt_token",data:e};let o=yield this.requestWithRetry(t);return console.log(o,"result"),o}))}authThirdToken(e){return i(this,void 0,void 0,(function*(){console.log(e,"request");const t={method:"post",url:"/api/v1/pro/thirdparty/auth_token",data:e};let o=yield this.requestWithRetry(t);return console.log(o,"result"),o}))}refreshThirdToken(e){return i(this,void 0,void 0,(function*(){console.log(e,"request");const t={method:"post",url:"/api/v1/pro/thirdparty/refresh_token",data:e};let o=yield this.requestWithRetry(t);return console.log(o,"result"),o}))}s3Upload(e){return i(this,void 0,void 0,(function*(){console.log(e,"request");const t={method:"post",url:"/api/v1/pro/thirdparty/s3_upload",data:e};let o=yield this.requestWithRetry(t);return console.log(o,"result"),o}))}s3Download(e){return i(this,void 0,void 0,(function*(){console.log(e,"request");const t={method:"post",url:"/api/v1/pro/thirdparty/s3_download",data:e};let o=yield this.requestWithRetry(t);return console.log(o,"result"),o}))}s3List(e){return i(this,void 0,void 0,(function*(){console.log(e,"request");const t={method:"post",url:"/api/v1/pro/thirdparty/s3_list",data:e};let o=yield this.requestWithRetry(t);return console.log(o,"result"),o}))}getSyncState(){return i(this,void 0,void 0,(function*(){let e=yield this.requestWithRetry({method:"get",url:"/api/v1/pro/thirdparty/get_sync_state"});return console.log(e,"result"),e}))}deleteSyncState(){return i(this,void 0,void 0,(function*(){let e=yield this.requestWithRetry({method:"post",url:"/api/v1/pro/thirdparty/delete_sync_state"});return console.log(e,"result"),e}))}}class I extends F{constructor(e){super(e)}loginRegister(e){return i(this,void 0,void 0,(function*(){console.log(e,"request");const t={method:"post",url:"/api/v1/public/user/login_register",data:e};let o=yield this.requestWithRetry(t);return console.log(o,"result"),o}))}logout(){return i(this,void 0,void 0,(function*(){let e=yield this.requestWithRetry({method:"post",url:"/api/v1/member/user/logout"});return console.log(e,"result"),e}))}getLogins(){return i(this,void 0,void 0,(function*(){const e={method:"get",url:"/api/v1/member/user/get_logins"};console.log(e,"config");let t=yield this.requestWithRetry(e);return console.log(t,"result"),t}))}addLogin(e){return i(this,void 0,void 0,(function*(){console.log(e,"request");const t={method:"post",url:"/api/v1/member/user/add_login",data:e};let o=yield this.requestWithRetry(t);return console.log(o,"result"),o}))}removeLogin(e){return i(this,void 0,void 0,(function*(){console.log(e,"request");const t={method:"post",url:"/api/v1/member/user/remove_login",data:e};let o=yield this.requestWithRetry(t);return console.log(o,"result"),o}))}}var U={getAuthUrl:(e,t)=>{let o="";"github"===e?o=`https://github.com/login/oauth/authorize?client_id=${s.githubClientId}&redirect_uri=${s.callbackUrl}&scope=openid`:"google"===e?o=`https://accounts.google.com/o/oauth2/v2/auth?redirect_uri=${s.callbackUrl}&prompt=consent&response_type=code&client_id=${s.googleClientId}&scope=openid&access_type=offline`:"facebook"===e?o=`https://www.facebook.com/v12.0/dialog/oauth?client_id=${s.facebookClientId}&redirect_uri=${s.callbackUrl}&scope=&response_type=code`:"microsoft"===e&&(o=`https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=${s.microsoftClientId}&scope=openid profile User.Read offline_access&response_type=code&redirect_uri=${s.callbackUrl}`);let i=JSON.stringify({deeplink:t?"koodo-reader://callback":"http://localhost:3000/#/login",service:e});return`${o}&state=${"state|"+encodeURIComponent(i)}`}};class j{static CompareDatabase(e,t){return i(this,void 0,void 0,(function*(){let o=Object.keys(e).filter((e=>e.startsWith("database.sqlite.books"))),i=Object.keys(e).filter((e=>e.startsWith("database.sqlite.notes"))),r=Object.keys(e).filter((e=>e.startsWith("database.sqlite.bookmarks"))),s=Object.keys(e).filter((e=>e.startsWith("database.sqlite.plugins"))),n=Object.keys(e).filter((e=>e.startsWith("database.sqlite.words"))),a=Object.keys(t).filter((e=>e.startsWith("database.sqlite.books"))),l=Object.keys(t).filter((e=>e.startsWith("database.sqlite.notes"))),c=Object.keys(t).filter((e=>e.startsWith("database.sqlite.bookmarks"))),d=Object.keys(t).filter((e=>e.startsWith("database.sqlite.plugins"))),p=Object.keys(t).filter((e=>e.startsWith("database.sqlite.words"))),u={books:Array.from(new Set(o.concat(a))),notes:Array.from(new Set(i.concat(l))),bookmarks:Array.from(new Set(r.concat(c))),plugins:Array.from(new Set(s.concat(d))),words:Array.from(new Set(n.concat(p)))},h={books:{save:[],update:[],delete:[],conflict:[],upload:[]},notes:{save:[],update:[],delete:[],conflict:[],upload:[]},bookmarks:{save:[],update:[],delete:[],conflict:[],upload:[]},plugins:{save:[],update:[],delete:[],conflict:[],upload:[]},words:{save:[],update:[],delete:[],conflict:[],upload:[]}},g=["books","notes","bookmarks","plugins","words"];for(let o of g)for(let i of u[o]){let r=i.split(".")[3],s=e[i],n=t[i];s?n?("save"===n.operation&&("update"===s.operation||"delete"===s.operation?h[o].upload.push(r):console.log("ignore",n)),"delete"===n.operation&&("save"===s.operation&&(h[o].delete.push(r),e[i]=n),"update"===s.operation&&(s.time<n.time?(h[o].delete.push(r),e[i]=n):s.time>n.time?h[o].conflict.push(r):console.log("ignore",n)),"delete"===s.operation&&console.log("ignore",n)),"update"===n.operation&&("save"===s.operation&&(h[o].update.push(r),e[i]=n),"update"===s.operation&&(s.time<n.time?(h[o].update.push(r),e[i]=n):s.time>n.time?h[o].upload.push(r):console.log("ignore",n)),"delete"===s.operation&&(s.time<n.time?h[o].conflict.push(r):s.time>n.time?h[o].upload.push(r):console.log("ignore",n)))):h[o].upload.push(r):(h[o].save.push(r),e[i]=n)}return{compareResult:h,syncRecords:e}}))}static CompareConfig(e,t){return i(this,void 0,void 0,(function*(){let o=Object.keys(e).filter((e=>e.startsWith("config.readerConfig"))),i=Object.keys(e).filter((e=>e.startsWith("config.listConfig"))),r=Object.keys(e).filter((e=>e.startsWith("config.objectConfig"))),s=Object.keys(e).filter((e=>e.startsWith("config.mapConfig"))),n=Object.keys(t).filter((e=>e.startsWith("config.readerConfig"))),a=Object.keys(t).filter((e=>e.startsWith("config.listConfig"))),l=Object.keys(t).filter((e=>e.startsWith("config.objectConfig"))),c=Object.keys(t).filter((e=>e.startsWith("config.mapConfig"))),d={readerConfig:Array.from(new Set(o.concat(n))),listConfig:Array.from(new Set(i.concat(a))),objectConfig:Array.from(new Set(r.concat(l))),mapConfig:Array.from(new Set(s.concat(c)))},p={readerConfig:{update:[],upload:[]},listConfig:{update:[],upload:[]},objectConfig:{update:[],delete:[],conflict:[],upload:[]},mapConfig:{update:[],delete:[],conflict:[],upload:[]}},u=["readerConfig","listConfig"];for(let o of u)for(let i of d[o]){let r=i,s=e[i],n=t[i];s?n?s.time<n.time?(p[o].update.push(r),e[i]=n):s.time>n.time?p[o].upload.push(r):console.log("ignore",n):p[o].upload.push(r):(p[o].update.push(r),e[i]=n)}let h=["objectConfig","mapConfig"];for(let o of h)for(let i of d[o]){let r=i,s=e[i],n=t[i];s?n?("delete"===n.operation&&("update"===s.operation&&(s.time<n.time?(p[o].delete.push(r),e[i]=n):s.time>n.time?p[o].conflict.push(r):console.log("ignore",n)),"delete"===s.operation&&console.log("ignore",n)),"update"===n.operation&&("update"===s.operation&&(s.time<n.time?(p[o].update.push(r),e[i]=n):s.time>n.time?p[o].upload.push(r):console.log("ignore",n)),"delete"===s.operation&&(s.time<n.time?p[o].conflict.push(r):s.time>n.time?p[o].upload.push(r):console.log("ignore",n)))):p[o].upload.push(r):(p[o].update.push(r),e[i]=n)}return{compareResult:p,syncRecords:e}}))}static compareAll(e,t){return i(this,void 0,void 0,(function*(){let{compareResult:o,syncRecords:i}=yield this.CompareDatabase(e,t),{compareResult:r,syncRecords:s}=yield this.CompareConfig(i,t);return{compareResult:Object.assign(Object.assign({},o),r),syncRecords:s}}))}static startSync(e,t,o,r,s,n,a){return i(this,void 0,void 0,(function*(){yield this.syncConfig(e,t,o,n,s),yield this.syncCover(r,a),yield this.syncBook(t,r,n)}))}static syncConfig(e,t,o,r,s){return i(this,void 0,void 0,(function*(){for(let t of p){if(e[t].save.length+e[t].update.length>0){yield s.downloadTempDatabase(t);let i=yield o.getAllRecords("temp-"+t);yield o.closeConnection("temp-"+t),console.log(i,"cloudRecords");for(let r of e[t].save){console.log(i[0]),console.log(i[0].key);let e=i.find((e=>(console.log(e),console.log(e.key,r),e.key===r)));console.log(e,"record create"),e&&(yield o.saveRecord(e,t))}console.log("4345",t);for(let r of e[t].update){let e=i.find((e=>e.key===r));console.log(e,"record update"),e&&(yield o.updateRecord(e,t,!1))}}if(console.log("asdfsd"),e[t].delete.length>0)for(let i of e[t].delete)yield o.deleteRecord(i,t),"books"===t&&(yield r.deleteOfflineBook(i))}if(console.log("234234"),e.readerConfig.update.length>0||e.listConfig.update.length>0||e.objectConfig.update.length>0||e.mapConfig.update.length>0){yield s.downloadTempConfig("config"),console.log(yield s.getLocalConfig("temp-config"));let o=JSON.parse(yield s.getLocalConfig("temp-config"));console.log(o,"cloudConfig");for(let i of e.readerConfig.update){console.log(i);let e=i.split(".")[3];console.log(o.readerConfig,e),o.readerConfig&&t.setReaderConfig(e,JSON.parse(o.readerConfig)[e],!1)}for(let i of e.listConfig.update){console.log(i);let e=i.split(".")[3];console.log(o[e],e),o[e]&&t.setAllListConfig(JSON.parse(o[e]),e,!1)}for(let i of e.objectConfig.update){console.log(i);let e=i.split(".")[3],r=i.split(".")[2];console.log(o[r],e,r),o[r]&&JSON.parse(o[r])&&JSON.parse(o[r])[e]&&t.setObjectConfig(e,JSON.parse(o[r])[e],r,!1)}for(let i of e.mapConfig.update){console.log(i);let e=i.split(".")[3],r=i.split(".")[2];if(console.log(o[r],e,r),o[r]&&JSON.parse(o[r])&&JSON.parse(o[r])[e]){let i=JSON.parse(o[r])[e];t.setOneMapConfig(e,i,r,!1)}}}if(e.objectConfig.delete.length>0||e.mapConfig.delete.length>0){for(let o of e.objectConfig.delete){console.log(o);let e=o.split(".")[3],i=o.split(".")[2];t.deleteObjectConfig(e,i)}for(let o of e.mapConfig.delete){console.log(o);let e=o.split(".")[3],i=o.split(".")[2];t.deleteMapConfig(e,i)}}for(let t of p)e[t].upload.length>0&&(console.log("uploading "+t),yield s.uploadDatabase(t));(e.readerConfig.upload.length>0||e.listConfig.upload.length>0||e.objectConfig.upload.length>0||e.mapConfig.upload.length>0)&&(yield s.dumpConfigJson("config"),console.log("uploading config"),yield s.uploadConfig("config")),yield s.dumpSyncJson(),console.log("uploading sync"),yield s.uploadConfig("sync")}))}static syncCover(e,t){return i(this,void 0,void 0,(function*(){let o=yield t.getLocalCoverList();console.log(o,"localCoverList");let i=yield e.getSyncUtil(),r=yield i.listFiles("cover");console.log(o,r,"coverList");let s=Array.from(new Set([...o,...r]));for(let e of s)o.includes(e)&&!r.includes(e)&&(yield i.uploadFile(e,e,"cover")),!o.includes(e)&&r.includes(e)&&(yield i.downloadFile(e,e,"cover"))}))}static syncBook(e,t,o){return i(this,void 0,void 0,(function*(){let i=yield o.getLocalBookList(),r=yield t.getSyncUtil(),s=yield r.listFiles("book");console.log(i,s,"bookList");let n=Array.from(new Set([...i,...s]));for(let t of n){i.includes(t)&&!s.includes(t)&&(yield r.uploadFile(t,t,"book"));let o="yes"===e.getReaderConfig("autoOffline");!i.includes(t)&&s.includes(t)&&o&&(yield r.downloadFile(t,t,"book"))}}))}}export{O as BookHelper,u as CommonTool,n as KookitConfig,U as LoginHelper,_ as ReaderRequest,x as SqlStatement,j as SyncHelper,b as SyncUtil,A as ThirdpartyRequest,I as UserRequest};
