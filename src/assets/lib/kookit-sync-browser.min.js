import e from"axios";import{createClient as o,AuthType as t}from"webdav/dist/web/index.js";function i(e,o,t,i){return new(t||(t=Promise))((function(r,s){function n(e){try{l(i.next(e))}catch(e){s(e)}}function a(e){try{l(i.throw(e))}catch(e){s(e)}}function l(e){var o;e.done?r(e.value):(o=e.value,o instanceof t?o:new t((function(e){e(o)}))).then(n,a)}l((i=i.apply(e,o||[])).next())}))}const r="https://web.koodoreader.com",s="https://cloud.960960.xyz/api/v1/third_auth/dropbox_auth",n="https://cloud.960960.xyz/api/v1/third_auth/dropbox_refresh",a="https://cloud.960960.xyz/api/v1/third_auth/onedrive_auth",l="https://cloud.960960.xyz/api/v1/third_auth/onedrive_refresh",d="https://cloud.960960.xyz/api/v1/third_auth/google_auth",c="https://cloud.960960.xyz/api/v1/third_auth/google_refresh",p="http://192.168.28.234:8000/api/v1/thirdparty/s3_download",h="http://192.168.28.234:8000/api/v1/thirdparty/s3_upload",u="http://192.168.28.234:8000/api/v1/thirdparty/s3_list";class f{constructor(e){this.config=e}listFiles(o){return i(this,void 0,void 0,(function*(){try{let{refresh_token:t}=this.config;const i=yield this.refreshToken(t),r=yield e.post("https://api.dropboxapi.com/2/files/list_folder",{path:"/"+o},{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}});return console.log(r.data.entries.map((e=>e.name))),r.data.entries.map((e=>e.name))}catch(e){throw console.error("Error listing files:",e),e}}))}refreshToken(o){return i(this,void 0,void 0,(function*(){return(yield e.post(n,{refresh_token:o})).data.access_token}))}authToken(o){return i(this,void 0,void 0,(function*(){let t=yield e.post(s,{code:o,redirect_uri:r});return console.log(t.data),t.data.refresh_token}))}}class y extends f{constructor(e){super(e)}uploadFile(o,t){return new Promise(((r,s)=>i(this,void 0,void 0,(function*(){try{let{refresh_token:i}=this.config;const s=yield this.refreshToken(i);console.log(s);let n=t.split("/").pop()||"",a=new File([o],n,{lastModified:(new Date).getTime(),type:o.type});const l=yield e.post("https://content.dropboxapi.com/2/files/upload",a,{headers:{Authorization:`Bearer ${s}`,"Content-Type":"application/octet-stream","Dropbox-API-Arg":JSON.stringify({path:"/"+n,mode:"overwrite",autorename:!0,mute:!1})}});console.log("File uploaded successfully:",l),r(!0)}catch(e){console.error("Error uploading file:",e),s(!1)}}))))}downloadFile(o){return new Promise(((t,r)=>i(this,void 0,void 0,(function*(){try{let{refresh_token:i}=this.config;const r=yield this.refreshToken(i),s=yield e({url:"https://content.dropboxapi.com/2/files/download",method:"post",headers:{Authorization:`Bearer ${r}`,"Dropbox-API-Arg":JSON.stringify({path:"/"+o})},responseType:"arraybuffer"});t(s.data)}catch(e){console.error("Error occurred during file download:",e),r(e)}}))))}}class g{constructor(e){this.config=e}getFileId(o,t,r){return i(this,void 0,void 0,(function*(){const i=`https://www.googleapis.com/drive/v3/files?q=name='${t}'+and+'${r}'+in+parents&spaces=appDataFolder&fields=files(id,name)`;try{const t=yield e.get(i,{headers:{Authorization:"Bearer "+o}});if(0===t.data.files.length)return"";const r=t.data.files;return console.log(r),r.length>0?r[0].id:null}catch(e){return console.error("Error occurred during file list retrieval:",e),""}}))}checkFolder(o,t){return i(this,void 0,void 0,(function*(){const i=yield this.getFolderId(o,t);if(i)return console.log("Folder already exists:",i),i;const r={name:t,mimeType:"application/vnd.google-apps.folder",parents:["appDataFolder"]};try{const t=yield e.post("https://www.googleapis.com/drive/v3/files",r,{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}});return console.log("Folder created:",t.data.id),t.data.id}catch(e){throw console.error("Error occurred during folder creation:",e),e}}))}getFolderId(o,t){return i(this,void 0,void 0,(function*(){const i=`https://www.googleapis.com/drive/v3/files?q=name='${t}'+and+mimeType='application/vnd.google-apps.folder'+and+'appDataFolder'+in+parents&spaces=appDataFolder&fields=files(id,name)`;try{const t=(yield e.get(i,{headers:{Authorization:`Bearer ${o}`}})).data.files;return t.length>0?t[0].id:null}catch(e){throw console.error("Error occurred during fetching folder ID:",e),e}}))}listFiles(o){return i(this,void 0,void 0,(function*(){try{let{refresh_token:t}=this.config;const i=yield this.refreshToken(t);let r=yield this.checkFolder(i,o);console.log(r);const s=`https://www.googleapis.com/drive/v3/files?q='${r}'+in+parents&spaces=appDataFolder&fields=files(id,name)`,n=yield e.get(s,{headers:{Authorization:`Bearer ${i}`}});return console.log("Files in folder:",n.data.files.map((e=>e.name))),n.data.files}catch(e){throw console.error("Error listing files:",e),e}}))}refreshToken(o){return i(this,void 0,void 0,(function*(){return(yield e.post(c,{refresh_token:o})).data.access_token}))}authToken(o){return i(this,void 0,void 0,(function*(){let t=yield e.post(d,{code:o,redirect_uri:r});return console.log(t.data),t.data.refresh_token}))}}class m extends g{constructor(e){super(e),this.getData=e=>new Promise(((o,t)=>{if(e){const i=new FileReader;i.onload=t=>o({fileName:e.name,mimeType:e.type,fileSize:e.size,data:t.target.result}),i.onerror=e=>t(e),i.readAsArrayBuffer(e)}else o({})}))}uploadFile(o,t){return new Promise(((r,s)=>i(this,void 0,void 0,(function*(){try{let{refresh_token:s}=this.config;const n=yield this.refreshToken(s);console.log(n);let a=t.split("/").pop()||"",l=new File([o],a,{lastModified:(new Date).getTime(),type:o.type}),d=t.split(".").pop(),c="json"===(i=d||"")?"application/json":["jpg","jpeg","png","gif","bmp"].includes(i)?"image/"+i:"zip"===i?"application/zip":"epub"===i?"application/epub+zip":"txt"===i?"text/plain":"pdf"===i?"application/pdf":"mobi"===i?"application/x-mobipocket-ebook":"azw3"===i||"azw"===i?"application/vnd.amazon.ebook":"cbz"===i?"application/x-cbz":"cbr"===i?"application/x-cbr":"cbt"===i?"application/x-cbt":"cb7"===i?"application/x-cb7":"fb2"===i?"application/x-fictionbook+xml":"html"===i?"text/html":"css"===i?"text/css":"js"===i?"application/javascript":"xml"===i?"application/xml":"xhtml"===i?"application/xhtml+xml":"opf"===i?"application/oebps-package+xml":"ncx"===i?"application/x-dtbncx+xml":"mp3"===i?"audio/mpeg":"wav"===i?"audio/wav":"ogg"===i?"audio/ogg":"mp4"===i?"video/mp4":"webm"===i?"video/webm":"avi"===i?"video/x-msvideo":"wmv"===i?"video/x-ms-wmv":"flv"===i?"video/x-flv":"m3u8"===i?"application/x-mpegURL":"ts"===i?"video/MP2T":"3gp"===i?"video/3gpp":"3g2"===i?"video/3gpp2":void 0,p=t.split("/")[0],h=yield this.checkFolder(n,p),u=yield this.getFileId(n,a||"",h);console.log(u,"fileId");const f={mimeType:c,name:a,parents:[h]},y=u?`https://www.googleapis.com/upload/drive/v3/files/${u}?uploadType=resumable`:"https://www.googleapis.com/upload/drive/v3/files?uploadType=resumable";console.log(y);const g=(yield e({method:u?"PATCH":"POST",url:y,data:u?null:JSON.stringify(f),headers:{Authorization:"Bearer "+n,"Content-Type":"application/json; charset=UTF-8"}})).headers.location;console.log(g);const m=yield this.getData(l);if(0===Object.keys(m).length)return void console.log("No file.");const v=yield e.put(g,m.data,{headers:{Authorization:"Bearer "+n,"Content-Type":"application/zip","Content-Range":`bytes 0-${m.fileSize-1}/${m.fileSize}`}});console.log("File uploaded successfully:",v),r(!0)}catch(e){console.error("Error uploading file:",e),s(!1)}var i}))))}downloadFile(o){return new Promise(((t,r)=>i(this,void 0,void 0,(function*(){try{let{refresh_token:i}=this.config;const s=yield this.refreshToken(i);let n=o.split("/").pop(),a=o.split("/")[0],l=yield this.checkFolder(s,a),d=yield this.getFileId(s,n||"",l);d||(console.error("File not found"),r(!1));const c=`https://www.googleapis.com/drive/v3/files/${d}?alt=media`,p=yield e.get(c,{headers:{Authorization:"Bearer "+s},responseType:"arraybuffer"});t(p.data)}catch(e){console.error("Error occurred during file download:",e),r(e)}}))))}}class v{constructor(e){this.config=e}listFiles(o){return i(this,void 0,void 0,(function*(){try{let{refresh_token:t}=this.config;const i=(yield e.post(l,{refresh_token:t})).data.access_token,r=yield e.get(`https://graph.microsoft.com/v1.0/me/drive/special/approot:/${o}:/children`,{headers:{Authorization:`Bearer ${i}`,"Content-Type":"application/json"}});return console.log("Files in folder:",r.data.value.map((e=>e.name))),r.data.value.map((e=>e.name))}catch(e){throw console.error("Error listing files:",e),e}}))}refreshToken(o){return i(this,void 0,void 0,(function*(){return(yield e.post(l,{refresh_token:o})).data.access_token}))}authToken(o){return i(this,void 0,void 0,(function*(){let t=yield e.post(a,{code:o,redirect_uri:r});return console.log(t.data),t.data.refresh_token}))}}class w extends v{constructor(e){super(e)}uploadFile(o,t){return new Promise(((r,s)=>i(this,void 0,void 0,(function*(){try{let{refresh_token:i}=this.config;const s=yield this.refreshToken(i);console.log(s);let n=t.split("/").pop()||"",a=new File([o],n,{lastModified:(new Date).getTime(),type:o.type});const l="https://graph.microsoft.com/v1.0/me/drive/special/approot:/"+t+":/createUploadSession",d=(yield e.post(l,null,{headers:{Authorization:"Bearer "+s,"Content-Type":"application/json"}})).data.uploadUrl,c=yield e.put(d,a,{headers:{Authorization:"Bearer "+s,"Content-Type":a.type}});console.log("File uploaded successfully:",c),r(!0)}catch(e){console.error("Error uploading file:",e),s(!1)}}))))}downloadFile(o){return new Promise(((t,r)=>i(this,void 0,void 0,(function*(){try{let{refresh_token:i}=this.config;const r=yield this.refreshToken(i),s=`https://graph.microsoft.com/v1.0/me/drive/special/approot:/${o}:/content`,n=yield e.get(s,{responseType:"arraybuffer",headers:{Authorization:"Bearer "+r}});t(n.data)}catch(e){console.error("Error occurred during file download:",e),r(e)}}))))}}class k{constructor(e){this.config=e}uploadFile(o,t){return new Promise(((r,s)=>i(this,void 0,void 0,(function*(){let{endpoint:i,region:s,bucketName:n,accessKeyId:a,secretAccessKey:l}=this.config;try{const d=(yield e.post(h,{bucket_name:n,object_key:t,region:s,endpoint:i,access_key_id:a,secret_access_key:l})).data.url;let c=t.split("/").pop()||"",p=new File([o],c,{lastModified:(new Date).getTime(),type:o.type});const u=yield e.put(d,p,{headers:{}});console.log("File uploaded successfully:",u),r(!0)}catch(e){console.error("Error occurred during file upload:",e),r(!1)}}))))}downloadFile(o){return new Promise(((t,r)=>i(this,void 0,void 0,(function*(){let{endpoint:i,region:s,bucketName:n,accessKeyId:a,secretAccessKey:l}=this.config;try{const r=(yield e.post(p,{bucket_name:n,object_key:o,region:s,endpoint:i,access_key_id:a,secret_access_key:l})).data.url,d=yield e({url:r,method:"post",headers:{},responseType:"arraybuffer"});t(d.data)}catch(e){console.error("Error occurred during file download:",e),r(!1)}}))))}listFiles(o){return i(this,void 0,void 0,(function*(){let{endpoint:t,region:i,bucketName:r,accessKeyId:s,secretAccessKey:n}=this.config;try{let a=yield e.post(u,{bucket_name:r,object_key:o,region:i,endpoint:t,access_key_id:s,secret_access_key:n});return console.log("Files in folder:",a.data.contents.map((e=>e.split("/").pop()))),a.data.contents.map((e=>e.split("/").pop()))}catch(e){throw console.error("Error listing files:",e),e}}))}}class b{constructor(e){let{username:i,password:r,url:s}=e;this.client=o(s,{authType:t.Password,username:i,password:r}),this.username=i,this.password=r}uploadFile(o,t){return new Promise(((r,s)=>i(this,void 0,void 0,(function*(){try{!1===(yield this.client.exists(t.substring(0,t.lastIndexOf("/"))))&&(yield this.client.createDirectory(t.substring(0,t.lastIndexOf("/"))));let i=t.split("/").pop()||"",s=new File([o],i,{lastModified:(new Date).getTime(),type:o.type}),n=this.client.getFileUploadLink(t);const a=new URL(n);a.search="",n=a.toString();const l=btoa(this.username+":"+this.password),d=yield e.put(n,s,{headers:{Authorization:"Basic "+l}});console.log("File uploaded successfully:",d),r(!0)}catch(e){console.error("Error uploading file:",e),s(!1)}}))))}downloadFile(o){return new Promise(((t,r)=>i(this,void 0,void 0,(function*(){try{const i=this.client.getFileDownloadLink(o);console.log(i);const r=btoa(this.username+":"+this.password),s=yield e({url:i,method:"get",headers:{Authorization:"Basic "+r},responseType:"arraybuffer"});t(s.data)}catch(e){console.error("Error occurred during file download:",e),r(e)}}))))}listFiles(e){return i(this,void 0,void 0,(function*(){try{let o=yield this.client.getDirectoryContents(e);return console.log(o.map((e=>e.basename))),o.map((e=>e.basename))}catch(e){return console.error("Error listing files:",e),[]}}))}}const F=["book","config","cover","font"];class _{constructor(e,o){this.type=e,"dropbox"===e?this.remote=new y(o):"onedrive"===e?this.remote=new w(o):"googledrive"===e?this.remote=new m(o):"s3compatible"===e?this.remote=new k(o):"webdav"===e&&(this.remote=new b(o))}downloadFile(e,o){return i(this,void 0,void 0,(function*(){return yield this.remote.downloadFile(o+"/"+e)}))}uploadFile(e,o,t){return i(this,void 0,void 0,(function*(){return yield this.remote.uploadFile(t,o+"/"+e)}))}listFiles(e){return i(this,void 0,void 0,(function*(){return yield this.remote.listFiles(e)}))}downloadAllFiles(){return i(this,void 0,void 0,(function*(){for(let e of F){let o=yield this.listFiles(e);for(let t of o)yield this.downloadFile(t,e)}}))}authToken(e){return i(this,void 0,void 0,(function*(){yield this.remote.authToken(e)}))}}export{_ as SyncUtil};
