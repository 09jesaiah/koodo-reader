import e from"chinese-s2t";import t from"underscore";import r from"jszip";import{ZipReader as n,BlobReader as i,TextWriter as o,BlobWriter as s}from"@zip.js/zip.js";import{unzlibSync as a}from"fflate";import l from"js-untar";import c from"mammoth";import{marked as h}from"marked";import d from"mhtml2html";function u(e,t,r,n){return new(r||(r=Promise))((function(i,o){function s(e){try{l(n.next(e))}catch(e){o(e)}}function a(e){try{l(n.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}l((n=n.apply(e,t||[])).next())}))}const f=e=>e?parseFloat(e+""):0,p=e=>u(void 0,void 0,void 0,(function*(){let t="";if(e.load){let r=yield fetch(yield e.load()).then((e=>e.blob()));t=yield r.text()}return e.loadAsset&&(t=yield m(t,e.loadAsset)),y(t)})),g=e=>Array.from(e.querySelectorAll("img, image")),m=(e,t)=>u(void 0,void 0,void 0,(function*(){let r=(new DOMParser).parseFromString(e,"text/html"),n=g(r);for(let e=0;e<n.length;e++)n[e].getAttribute("src")&&(n[e].src=yield t(n[e].getAttribute("src")));let i=Array.from(r.getElementsByTagName("link"));for(let e=0;e<i.length;e++){const r=i[e];r.getAttribute("href")&&(r.href=yield t(r.getAttribute("href")))}return r.documentElement.innerHTML})),y=e=>{let t=(new DOMParser).parseFromString(e,"text/html"),r=g(t);if(0===r.length)return e;for(let e=0;e<r.length;e++){var n=document.createElement("address"),i=document.createTextNode("img");n.appendChild(i),n.setAttribute("style","visibility: hidden; position: absolute"),r[e].parentNode&&r[e].parentNode.insertBefore(n,r[e])}return t.documentElement.innerHTML},b=(e,t="")=>{var r=document.createElement("iframe");r.style.width="100%",r.style.border="0",r.style.margin="0",r.style.padding="0",r.style.minHeight="calc(100% - 2px)",r.style.fontSize="100%",r.style.font="inherit",r.scrolling="no",r.tabIndex=0,r.style.verticalAlign="baseline",e.innerHTML="",e.appendChild(r)},w=e=>u(void 0,void 0,void 0,(function*(){let t=document.getElementById("page-area");if(!t)return;let r=t.getElementsByTagName("iframe")[0];if(!r)return;let n=r.contentDocument;return n?(1===parseInt(n.body.scrollWidth/n.body.clientWidth+"")&&(yield new Promise((e=>setTimeout(e,1e3)))),{totalPage:"scroll"===e?1:parseInt(n.body.scrollWidth/n.body.clientWidth+"")+1,currentPage:parseInt(f(n.body.scrollLeft)/n.body.clientWidth+"")+1}):void 0})),v=()=>{let e=document.getElementById("page-area");if(!e)return;let t=e.getElementsByTagName("iframe")[0];if(!t)return;let r=t.contentDocument;if(!r)return;let n=r.querySelectorAll("a, article, cite, div, li, p, span, pre, table, bold, body");for(let e=0;e<n.length;e++){const t=n[e];-1===t.className.indexOf("kookit-text")&&(t.className=t.className+" kookit-text")}},x=e=>u(void 0,void 0,void 0,(function*(){const t=new Image;return t.src=e,yield t.decode(),t})),C=(e,t,r)=>u(void 0,void 0,void 0,(function*(){let n=document.getElementById("page-area");if(!n)return;let i=n.getElementsByTagName("iframe")[0];if(!i)return;let o=i.contentDocument;if(!o)return;let s=Math.floor(e.clientWidth/12),a=s%2==0?s:s-1,l=o.querySelectorAll("img, image");for(let n of l){let i=n.parentElement,s=0,l=0,c=n.naturalWidth,h=n.naturalHeight;if("image"===n.tagName){let e=yield x(n.getAttribute("xlink:href"));c=e.naturalWidth,h=e.naturalHeight}if(r.startsWith("CB")&&"scroll"===t)l=i.offsetWidth;else if(r.startsWith("CB")&&"single"===t)s=e.clientHeight,l=e.clientWidth;else if(c&&h){h/c>i.clientHeight/i.clientWidth?(s=i.clientHeight,l=parseInt(s*c/h+"")):(l=i.clientWidth,s=parseInt(l*h/c+"")),s>o.body.clientHeight&&(l=parseInt(l*(o.body.clientHeight/s)+""),s=o.body.clientHeight)}else i&&i.clientWidth&&i.clientWidth>0?(l=i.clientWidth,s=i.clientHeight):(l=e.clientWidth,s=e.clientHeight);l=l?Math.min("scroll"===t||"single"===t?e.clientWidth:(e.clientWidth-a)/2,l):"scroll"===t||"single"===t?e.clientWidth:(e.clientWidth-a)/2,c&&h&&(c>h||s/l>h/c?s=l*(h/c):l=s*(c/h)),(l||s)&&n.setAttribute("style",n.getAttribute("style")+";"+`max-width: ${l>0?l+"px":""};max-height:${s>0?s+"px":""}; margin: 0 auto; ${r.startsWith("CB")?"display: block; margin-left: auto; margin-right: auto;":""}`)}})),L=(e,t)=>{let r=document.getElementById("page-area");if(!r)return;let n=r.getElementsByTagName("iframe")[0];if(!n)return;let i=n.contentDocument;if(!i)return;let o=i.createElement("style");if(o.id="default-style",o.textContent="p,empty-line{display: inherit;margin-block-start: inherit;margin-block-end: inherit;margin-inline-start: inherit;margin-inline-end: inherit;}body{margin: 0px}",i.head.appendChild(o),"scroll"===t)return;let s="double"===t?2:1,a=Math.floor(e.clientWidth/12),l=a%2==0?a:a-1;i.body.setAttribute("style",`width: auto;height: 100%;overflow-y: hidden;overflow-X: hidden;padding-left: 0px;padding-right: 0px;margin: 0px;box-sizing: border-box;max-width: inherit;column-fill: auto;column-gap: ${l}px; column-width: ${(e.clientWidth-l)/s}px;`)};class S{constructor(e){this.book=e,this.chapterList=[],this.flattenChapters=[],this.chapterDocList=[]}getChapter(e){return u(this,void 0,void 0,(function*(){return this.chapterList=e?yield Promise.all(e.map((e=>u(this,void 0,void 0,(function*(){let t=-1;try{t=e.href&&(yield this.book.resolveHref(e.href))?(yield this.book.resolveHref(e.href)).index:-1}catch(e){console.log(e)}return{label:e.label?e.label:t,href:e.href?e.href:"title"+t,index:t,subitems:e.subitems?yield this.getChapter(e.subitems):[]}}))))):yield Promise.all(this.book.sections.map(((e,t)=>u(this,void 0,void 0,(function*(){return{label:e.label?e.label:t,href:e.href?e.href:"title"+t,index:t,subitems:e.subitems?yield this.getChapter(e.subitems):[]}}))))),this.flattenChapters=this.flatChapter(this.chapterList),this.chapterList}))}getChapterDoc(){return u(this,void 0,void 0,(function*(){const e=this.flattenChapters.map((e=>e.index));return this.book.sections.map(((t,r)=>e.indexOf(r)>-1?{label:this.flattenChapters[e.indexOf(r)].label,href:this.flattenChapters[e.indexOf(r)].href,text:t}:{label:"",href:"",text:t}))}))}flatChapter(e){let t=[];for(let r=0;r<e.length;r++)e[r].subitems&&e[r].subitems.length>0?(t.push(e[r]),t=t.concat(this.flatChapter(e[r].subitems))):t.push(e[r]);return t}getMetadata(){return new Promise(((e,t)=>u(this,void 0,void 0,(function*(){const r=this.book.metadata;try{const t=yield this.book.getCover();var n=new FileReader;n.readAsDataURL(t),n.onloadend=()=>{e({name:r.title,author:r.author?r.author[0].name:"",description:r.description,publisher:r.publisher,cover:n.result})}}catch(n){try{let t=r.author&&r.author[0]&&r.author[0].name?r.author[0].name:r.author&&r.author[0]?r.author[0]:r.author?r.author:"";e({name:r.title,author:t,description:r.description,publisher:r.publisher,cover:""})}catch(e){console.log(e),t(e)}}}))))}}const T=(e,t)=>[-1,...t,e.length].reduce((({xs:t,a:r},n)=>({xs:t?.concat([e.slice(r+1,n)])??[],a:n})),{}).xs,k=/\d/,E=/^epubcfi\((.*)\)$/,B=e=>e.replace(/[\^[\](),;=]/g,"^$&"),I=(e,t)=>{return r=([e])=>e===t,e.map(((e,t,n)=>r(e,t,n)?t:null)).filter((e=>null!=e));var r},A=e=>{const t=[];let r;for(const[n,i]of e){if("/"===n)t.push({index:i});else{const e=t[t.length-1];if(":"===n)e.offset=i;else if("~"===n)e.temporal=i;else if("@"===n)e.spatial=(e.spatial??[]).concat(i);else if(";s"===n)e.side=i;else if("["===n){if("/"!==r||!i){e.text=(e.text??[]).concat(i);continue}e.id=i}}r=n}return t},O=e=>T(e,I(e,"!")).map(A),M=e=>{const t=(e=>{const t=[];let r,n,i="";const o=e=>(t.push(e),r=null,i=""),s=e=>(i+=e,n=!1);for(const t of Array.from(e.trim()).concat(""))if("^"!==t||n){if("!"===r)o(["!"]);else if(","===r)o([","]);else if("/"===r||":"===r){if(k.test(t)){s(t);continue}o([r,parseInt(i)])}else if("~"===r){if(k.test(t)||"."===t){s(t);continue}o(["~",parseFloat(i)])}else if("@"===r){if(":"===t){o(["@",parseFloat(i)]),r="@";continue}if(k.test(t)||"."===t){s(t);continue}o(["@",parseFloat(i)])}else{if("["===r){";"!==t||n?","!==t||n?"]"!==t||n?s(t):o(["[",i]):(o(["[",i]),r="["):(o(["[",i]),r=";");continue}if(r?.startsWith(";")){"="!==t||n?";"!==t||n?"]"!==t||n?s(t):o([r,i]):(o([r,i]),r=";"):(r=`;${i}`,i="");continue}}"/"!==t&&":"!==t&&"~"!==t&&"@"!==t&&"["!==t&&"!"!==t&&","!==t||(r=t)}else n=!0;return t})((r=e,r.match(E)?.[1]??r));var r;const n=I(t,",");if(!n.length)return O(t);const[i,o,s]=T(t,n).map(O);return{parent:i,start:o,end:s}},D=({index:e,id:t,offset:r,temporal:n,spatial:i,text:o,side:s})=>{const a=s?`;s=${s}`:"";return`/${e}`+(t?`[${B(t)}${a}]`:"")+(null!=r&&e%2?`:${r}`:"")+(n?`~${n}`:"")+(i?`@${i.join(":")}`:"")+(o||!t&&s?"["+(o?.map(B)?.join(",")??"")+a+"]":"")},N=e=>e.parent?[e.parent,e.start,e.end].map(N).join(","):e.map((e=>e.map(D).join(""))).join("!"),R=e=>{return t=N(e),E.test(t)?t:`epubcfi(${t})`;var t},F=(e,t)=>{return"string"==typeof e?R(F(M(e),t)):e.parent?(r=e.parent,n=e[t?"end":"start"],r.slice(0,-1).concat([r[r.length-1].concat(n[0])]).concat(n.slice(1))):e;var r,n},_=({nodeType:e})=>3===e||4===e,P=({nodeType:e})=>1===e,H=e=>{const t=Array.from(e.childNodes).filter((e=>_(e)||P(e))).reduce(((e,t)=>{let r=e[e.length-1];return r?_(t)?Array.isArray(r)?r.push(t):_(r)?e[e.length-1]=[r,t]:e.push(t):P(r)?e.push(null,t):e.push(t):e.push(t),e}),[]);return P(t[0])&&t.unshift("first"),P(t[t.length-1])&&t.push("last"),t.unshift("before"),t.push("after"),t},U=(e,t)=>e?H(e)[t]:null,j=(e,t)=>{const{id:r}=t[t.length-1];if(r){const t=e.ownerDocument.getElementById(r);if(t)return{node:t,offset:0}}for(const{index:r}of t){const t=U(e,r);if("first"===t)return{node:e.firstChild??e};if("last"===t)return{node:e.lastChild??e};if("before"===t)return{node:e,before:!0};if("after"===t)return{node:e,after:!0};e=t}const{offset:n}=t[t.length-1];if(!Array.isArray(e))return{node:e,offset:n};let i=0;for(const t of e){const{length:e}=t.nodeValue;if(i+e>=n)return{node:t,offset:n-i};i+=e}},$=(e,t)=>{const{parentNode:r,id:n}=e,i=H(r),o=i.findIndex((t=>Array.isArray(t)?t.some((t=>t===e)):t===e)),s=i[o];if(Array.isArray(s)){let r=0;for(const n of s){if(n===e){r+=t;break}r+=n.nodeValue.length}t=r}const a={id:n,index:o,offset:t};return r!==e.ownerDocument.documentElement?$(r).concat(a):[a]},z=(e,t)=>j(e.documentElement,F(t)).node,W="urn:oasis:names:tc:opendocument:xmlns:container",q="http://www.w3.org/1999/xhtml",X="http://www.idpf.org/2007/opf",V="http://www.idpf.org/2007/ops",G="http://purl.org/dc/elements/1.1/",J="http://www.w3.org/2001/04/xmlenc#",K="http://www.daisy.org/z3986/2005/ncx/",Z="http://www.w3.org/1999/xlink",Y="http://www.w3.org/ns/SMIL",Q={XML:"application/xml",NCX:"application/x-dtbncx+xml",XHTML:"application/xhtml+xml",HTML:"text/html",CSS:"text/css",SVG:"image/svg+xml",JS:/\/(x-)?(javascript|ecmascript)/},ee=e=>e.toLowerCase().replace(/[-:](.)/g,((e,t)=>t.toUpperCase())),te=(e,t,r)=>r?r=>r.getAttribute(e)?.split(/\s/)?.includes(t):"function"==typeof t?r=>t(r.getAttribute(e)):r=>r.getAttribute(e)===t,re=(...e)=>t=>t?Object.fromEntries(e.map((e=>[ee(e),t.getAttribute(e)]))):null,ne=e=>{return t=e?.textContent,t?t.trim().replace(/\s{2,}/g," "):"";var t},ie=(e,t)=>{const r=e.lookupNamespaceURI(null)===t||e.lookupPrefix(t),n=r?(e,r)=>e=>e.namespaceURI===t&&e.localName===r:(e,t)=>e=>e.localName===t;return{$:(e,t)=>[...e.children].find(n(e,t)),$$:(e,t)=>[...e.children].filter(n(e,t)),$$$:r?(e,r)=>[...e.getElementsByTagNameNS(t,r)]:(e,r)=>[...e.getElementsByTagName(t,r)]}},oe=(e,t)=>{try{if(t.includes(":"))return new URL(e,t);const r="whatever://whatever/";return decodeURI(new URL(e,r+t).href.replace(r,""))}catch(t){return console.warn(t),e}},se=e=>/^(?!blob)\w+:/i.test(e),ae=async(e,t,r)=>{const n=[];e.replace(t,((...e)=>(n.push(e),null)));const i=[];for(const e of n)i.push(await r(...e));return e.replace(t,(()=>i.shift()))},le=e=>e.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),ce={attrs:["dir","xml:lang"]},he={name:"alternate-script",many:!0,...ce,props:["file-as"]},de={many:!0,...ce,props:[{name:"role",many:!0,attrs:["scheme"]},"file-as",he]},ue=[{name:"title",many:!0,...ce,props:["title-type","display-seq","file-as",he]},{name:"identifier",many:!0,props:[{name:"identifier-type",attrs:["scheme"]}]},{name:"language",many:!0},{name:"creator",...de},{name:"contributor",...de},{name:"publisher",...ce,props:["file-as",he]},{name:"description",...ce,props:[he]},{name:"rights",...ce,props:[he]},{name:"date"},{name:"dcterms:modified",type:"meta"},{name:"subject",many:!0,...ce,props:["term","authority",he]},{name:"belongs-to-collection",type:"meta",many:!0,...ce,props:["collection-type","group-position","dcterms:identifier","file-as",he,{name:"belongs-to-collection",recursive:!0}]}],fe=(e,t=e=>e)=>{const{$:r,$$:n,$$$:i}=ie(e,q),o=e=>n=>{const i=r(n,"a")??r(n,"span"),o=r(n,"ol"),a=(e=>e?decodeURI(t(e)):null)(i?.getAttribute("href")),l={label:ne(i)||i?.getAttribute("title"),href:a,subitems:s(o)};return e&&(l.type=i?.getAttributeNS(V,"type")?.split(/\s/)),l},s=(e,t)=>e?n(e,"li").map(o(t)):null,a=(e,t)=>s(r(e,"ol"),t),l=i(e,"nav");let c=null,h=null,d=null,u=[];for(const e of l){const t=e.getAttributeNS(V,"type")?.split(/\s/)??[];t.includes("toc")?c??=a(e):t.includes("page-list")?h??=a(e):t.includes("landmarks")?d??=a(e,!0):u.push({label:ne(e.firstElementChild),type:t,list:a(e)})}return{toc:c,pageList:h,landmarks:d,others:u}},pe=(e,t=e=>e)=>{const{$:r,$$:n}=ie(e,K),i=e=>{const o=r(e,"navLabel"),s=r(e,"content"),a=ne(o),l=(e=>e?decodeURI(t(e)):null)(s.getAttribute("src"));if("navPoint"===e.localName){const t=n(e,"navPoint");return{label:a,href:l,subitems:t.length?t.map(i):null}}return{label:a,href:l}},o=(e,t)=>n(e,t).map(i),s=(t,n)=>{const i=r(e.documentElement,t);return i?o(i,n):null};return{toc:s("navMap","navPoint"),pageList:s("pageList","pageTarget"),others:n(e.documentElement,"navList").map((e=>({label:ne(r(e,"navLabel")),list:o(e,"navTarget")})))}},ge=e=>{if(!e)return;const t=e.split(":").map((e=>parseFloat(e)));if(3===t.length){const[e,r,n]=t;return 60*e*60+60*r+n}if(2===t.length){const[e,r]=t;return 60*e+r}const[r,n]=e.split(/(?=[^\d.])/);return parseFloat(r)*("h"===n?3600:"min"===n?60:"ms"===n?.001:1)},me=/([0-9a-f]{8})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{4})-([0-9a-f]{12})/,ye=e=>ne(e.getElementById(e.documentElement.getAttribute("unique-identifier"))??e.getElementsByTagNameNS(G,"identifier")[0]),be=async(e,t,r)=>{const n=new Uint8Array(await r.slice(0,t).arrayBuffer());t=Math.min(t,n.length);for(var i=0;i<t;i++)n[i]=n[i]^e[i%e.length];return new Blob([n,r.slice(t)],{type:r.type})},we=async e=>{const t=(new TextEncoder).encode(e),r=await globalThis.crypto.subtle.digest("SHA-1",t);return new Uint8Array(r)},ve=(e=we)=>({"http://www.idpf.org/2008/embedding":{key:t=>e(ye(t).replaceAll(/[\u0020\u0009\u000d\u000a]/g,"")),decode:(e,t)=>be(e,1040,t)},"http://ns.adobe.com/pdf/enc#RC":{key:e=>{const t=(e=>{for(const t of e.getElementsByTagNameNS(G,"identifier")){const[e]=ne(t).split(":").slice(-1);if(me.test(e))return e}return""})(e).replaceAll("-","");return Uint8Array.from({length:16},((e,r)=>parseInt(t.slice(2*r,2*r+2),16)))},decode:(e,t)=>be(e,1024,t)}});class xe{#e=new Map;#t=new Map;#r;constructor(e){this.#r=e}async init(e,t){if(!e)return;const r=Array.from(e.getElementsByTagNameNS(J,"EncryptedData"),(e=>({algorithm:e.getElementsByTagNameNS(J,"EncryptionMethod")[0]?.getAttribute("Algorithm"),uri:e.getElementsByTagNameNS(J,"CipherReference")[0]?.getAttribute("URI")})));for(const{algorithm:e,uri:n}of r){if(!this.#t.has(e)){const r=this.#r[e];if(!r){console.warn("Unknown encryption algorithm");continue}const n=await r.key(t);this.#t.set(e,(e=>r.decode(n,e)))}this.#e.set(n,e)}}getDecoder(e){return this.#t.get(this.#e.get(e))??(e=>e)}}class Ce{constructor({opf:e,resolveHref:t}){this.opf=e;const{$:r,$$:n,$$$:i}=ie(e,X),o=r(e.documentElement,"manifest"),s=r(e.documentElement,"spine"),a=n(s,"itemref");this.manifest=n(o,"item").map(re("href","id","media-type","properties","media-overlay")).map((e=>(e.href=t(e.href),e.properties=e.properties?.split(/\s/),e))),this.spine=a.map(re("idref","id","linear","properties")).map((e=>(e.properties=e.properties?.split(/\s/),e))),this.pageProgressionDirection=s.getAttribute("page-progression-direction"),this.navPath=this.getItemByProperty("nav")?.href,this.ncxPath=(this.getItemByID(s.getAttribute("toc"))??this.manifest.find((e=>e.mediaType===Q.NCX)))?.href;const l=r(e.documentElement,"guide");l&&(this.guide=n(l,"reference").map(re("type","title","href")).map((({type:e,title:r,href:n})=>({label:r,type:e.split(/\s/),href:t(n)})))),this.cover=this.getItemByProperty("cover-image")??this.getItemByID(i(e,"meta").find(te("name","cover"))?.getAttribute("content"))??this.getItemByHref(this.guide?.find((e=>e.type.includes("cover")))?.href),this.cfis=(e=>{const t=[],{parentNode:r}=e[0],n=$(r);for(const[i,o]of H(r).entries()){const r=e[t.length];o===r&&t.push(R([n.concat({id:r.id,index:i})]))}return t})(a)}getItemByID(e){return this.manifest.find((t=>t.id===e))}getItemByHref(e){return this.manifest.find((t=>t.href===e))}getItemByProperty(e){return this.manifest.find((t=>t.properties?.includes(e)))}resolveCFI(e){const t=M(e),r=(t.parent??t).shift();let n=z(this.opf,r);n&&"idref"!==n.nodeName&&(r.at(-1).id=null,n=z(this.opf,r));const i=n?.getAttribute("idref");return{index:this.spine.findIndex((e=>e.idref===i)),anchor:e=>((e,t)=>{const r=F(t),n=F(t,!0),i=e.documentElement,o=j(i,r[0]),s=j(i,n[0]),a=e.createRange();return o.before?a.setStartBefore(o.node):o.after?a.setStartAfter(o.node):a.setStart(o.node,o.offset),s.before?a.setEndBefore(s.node):s.after?a.setEndAfter(s.node):a.setEnd(s.node,s.offset),a})(e,t)}}}class Le{#n=new Map;#i=new Map;#o=new Map;allowScript=!1;constructor({loadText:e,loadBlob:t,resources:r}){this.loadText=e,this.loadBlob=t,this.manifest=r.manifest,this.assets=r.manifest}createURL(e,t,r,n){if(!t)return"";const i=URL.createObjectURL(new Blob([t],{type:r}));if(this.#n.set(e,i),this.#o.set(e,1),n){const t=this.#i.get(n);t?t.push(e):this.#i.set(n,[e])}return i}ref(e,t){const r=this.#i.get(t);return r?.includes(e)||(this.#o.set(e,this.#o.get(e)+1),r?r.push(e):this.#i.set(t,[e])),this.#n.get(e)}unref(e){if(!this.#o.has(e))return;const t=this.#o.get(e)-1;if(t<1){URL.revokeObjectURL(this.#n.get(e)),this.#n.delete(e),this.#o.delete(e);const t=this.#i.get(e);if(t)for(;t.length;)this.unref(t.pop());this.#i.delete(e)}else this.#o.set(e,t)}async loadItem(e,t=[]){if(!e)return null;const{href:r,mediaType:n}=e,i=Q.JS.test(e.mediaType);if(i&&!this.allowScript)return null;const o=t.at(-1);if(this.#n.has(r))return this.ref(r,o);return(i||[Q.XHTML,Q.HTML,Q.CSS,Q.SVG].includes(n))&&t.every((e=>e!==r))?this.loadReplaced(e,t):this.createURL(r,await this.loadBlob(r),n,o)}async loadHref(e,t,r=[]){if(se(e))return e;const n=oe(e,t);let i=this.manifest.find((e=>e.href===n));return i||(i={href:n,mediaType:""}),this.loadItem(i,r.concat(t))}async loadReplaced(e,t=[]){const{href:r,mediaType:n}=e,i=t.at(-1),o=await this.loadText(r);if(!o)return null;if([Q.XHTML,Q.HTML,Q.SVG].includes(n)){let s=(new DOMParser).parseFromString(o,n);if(n===Q.XHTML&&s.querySelector("parsererror")&&(console.warn(s.querySelector("parsererror").innerText),e.mediaType=Q.HTML,s=(new DOMParser).parseFromString(o,e.mediaType)),[Q.XHTML,Q.SVG].includes(e.mediaType)){let e=s.firstChild;for(;e instanceof ProcessingInstruction;){if(e.data){const n=await ae(e.data,/(?:^|\s*)(href\s*=\s*['"])([^'"]*)(['"])/i,((e,n,i,o)=>this.loadHref(i,r,t).then((e=>`${n}${e}${o}`))));e.replaceWith(s.createProcessingInstruction(e.target,n))}e=e.nextSibling}}const a=async(e,n)=>e.setAttribute(n,await this.loadHref(e.getAttribute(n),r,t));for(const e of s.querySelectorAll("link[href]"))await a(e,"href");for(const e of s.querySelectorAll("[src]"))await a(e,"src");for(const e of s.querySelectorAll("[poster]"))await a(e,"poster");for(const e of s.querySelectorAll("object[data]"))await a(e,"data");for(const e of s.querySelectorAll("[*|href]:not([href]"))e.setAttributeNS(Z,"href",await this.loadHref(e.getAttributeNS(Z,"href"),r,t));for(const e of s.querySelectorAll("style"))e.textContent&&(e.textContent=await this.replaceCSS(e.textContent,r,t));for(const e of s.querySelectorAll("[style]"))e.setAttribute("style",await this.replaceCSS(e.getAttribute("style"),r,t));const l=(new XMLSerializer).serializeToString(s);return this.createURL(r,l,e.mediaType,i)}const s=n===Q.CSS?await this.replaceCSS(o,r,t):await this.replaceString(o,r,t);return this.createURL(r,s,n,i)}async replaceCSS(e,t,r=[]){const n=await ae(e,/url\(\s*["']?([^'"\n]*?)\s*["']?\s*\)/gi,((e,n)=>this.loadHref(n,t,r).then((e=>`url("${e}")`)))),i=await ae(n,/@import\s*["']([^"'\n]*?)["']/gi,((e,n)=>this.loadHref(n,t,r).then((e=>`@import "${e}"`)))),o=window?.innerWidth??800,s=window?.innerHeight??600;return i.replace(/-epub-/gi,"").replace(/(\d*\.?\d+)vw/gi,((e,t)=>parseFloat(t)*o/100+"px")).replace(/(\d*\.?\d+)vh/gi,((e,t)=>parseFloat(t)*s/100+"px")).replace(/page-break-(after|before|inside)/gi,((e,t)=>`-webkit-column-break-${t}`))}replaceString(e,t,r=[]){const n=new Map,i=this.assets.map((e=>{if(e.href===t)return;const r=((e,t)=>{if(!e)return t;const r=e.replace(/\/$/,"").split("/"),n=t.replace(/\/$/,"").split("/"),i=(r.length>n.length?r:n).findIndex(((e,t)=>r[t]!==n[t]));return i<0?"":Array(r.length-i).fill("..").concat(n.slice(i)).join("/")})((e=>e.slice(0,e.lastIndexOf("/")+1))(t),e.href),i=encodeURI(r),o="/"+e.href,s=encodeURI(o),a=new Set([r,i,o,s]);for(const t of a)n.set(t,e);return Array.from(a)})).flat().filter((e=>e));if(!i.length)return e;const o=new RegExp(i.map(le).join("|"),"g");return ae(e,o,(async e=>this.loadItem(n.get(e.replace(/^\//,"")),r.concat(t))))}unloadItem(e){this.unref(e?.href)}}const Se=e=>{for(const t of e){if("page-spread-left"===t||"rendition:page-spread-left"===t)return"left";if("page-spread-right"===t||"rendition:page-spread-right"===t)return"right";if("rendition:page-spread-center"===t)return"center"}};class Te{parser=new DOMParser;#s;constructor({loadText:e,loadBlob:t,getSize:r,sha1:n}){this.loadText=e,this.loadBlob=t,this.getSize=r,this.#s=new xe(ve(n))}#a(e){return e?this.parser.parseFromString(e,Q.XML):null}async#l(e){return this.#a(await this.loadText(e))}async init(){const e=await this.#l("META-INF/container.xml");if(!e)throw new Error("Failed to load container file");const t=Array.from(e.getElementsByTagNameNS(W,"rootfile"),re("full-path","media-type")).filter((e=>"application/oebps-package+xml"===e.mediaType));if(!t.length)throw new Error("No package document defined in container");const r=t[0].fullPath,n=await this.#l(r);if(!n)throw new Error("Failed to load package document");const i=await this.#l("META-INF/encryption.xml");await this.#s.init(i,n),this.resources=new Ce({opf:n,resolveHref:e=>oe(e,r)});const o=new Le({loadText:this.loadText,loadBlob:e=>Promise.resolve(this.loadBlob(e)).then(this.#s.getDecoder(e)),resources:this.resources});this.sections=this.resources.spine.map(((e,t)=>{const{idref:r,linear:n,properties:i=[]}=e,s=this.resources.getItemByID(r);return s?{id:this.resources.getItemByID(r)?.href,load:()=>o.loadItem(s),unload:()=>o.unloadItem(s),createDocument:()=>this.loadDocument(s),size:this.getSize(s.href),cfi:this.resources.cfis[t],linear:n,pageSpread:Se(i),resolveHref:e=>oe(e,s.href),loadMediaOverlay:()=>this.loadMediaOverlay(s)}:(console.warn(`Could not find item with ID "${r}" in manifest`),null)})).filter((e=>e));const{navPath:s,ncxPath:a}=this.resources;if(s)try{const e=e=>oe(e,s),t=fe(await this.#l(s),e);this.toc=t.toc,this.pageList=t.pageList,this.landmarks=t.landmarks}catch(e){console.warn(e)}if(!this.toc&&a)try{const e=e=>oe(e,a),t=pe(await this.#l(a),e);this.toc=t.toc,this.pageList=t.pageList}catch(e){console.warn(e)}this.landmarks??=this.resources.guide;const{metadata:l,rendition:c,media:h}=(e=>{const{$:t,$$:r}=ie(e,X),n=t(e.documentElement,"metadata"),i=Array.from(n.children),o=(e,t)=>{if(!t)return null;const{props:r=[],attrs:n=[]}=e,s=ne(t);if(!r.length&&!n.length)return s;const a=t.getAttribute("id"),l=a?i.filter(te("refines","#"+a)):[];return Object.fromEntries([["value",s]].concat(r.map((t=>{const{many:r,recursive:n}=t,i="string"==typeof t?t:t.name,s=te("property",i),a=n?e:t;return[ee(i),r?l.filter(s).map((e=>o(a,e))):o(a,l.find(s))]}))).concat(n.map((e=>[ee(e),t.getAttribute(e)]))))},s=i.filter(te("refines",null)),a=e=>Object.fromEntries(r(n,"meta").filter(te("property",(t=>t?.startsWith(e)))).map((t=>[t.getAttribute("property").replace(e,""),ne(t)])));return{metadata:Object.fromEntries(ue.map((e=>{const{type:t,name:r,many:n}=e,i="meta"===t?e=>e.namespaceURI===X&&e.getAttribute("property")===r:e=>e.namespaceURI===G&&e.localName===r;return[ee(r),n?s.filter(i).map((t=>o(e,t))):o(e,s.find(i))]}))),rendition:a("rendition:"),media:a("media:")}})(n);this.rendition=c,this.media=h,h.duration=ge(h.duration),this.dir=this.resources.pageProgressionDirection,this.rawMetadata=l;const d=l?.title?.[0];this.metadata={title:d?.value,sortAs:d?.fileAs,language:l?.language,identifier:ye(n),description:l?.description?.value,publisher:l?.publisher?.value,published:l?.date,modified:l?.dctermsModified,subject:l?.subject?.filter((({value:e,code:t})=>e||t))?.map((({value:e,code:t,scheme:r})=>({name:e,code:t,scheme:r}))),rights:l?.rights?.value};const u={art:"artist",aut:"author",bkp:"producer",clr:"colorist",edt:"editor",ill:"illustrator",trl:"translator",pbl:"publisher"},f=e=>t=>{const r=[...new Set(t.role?.map((({value:t,scheme:r})=>(r&&"marc:relators"!==r?null:u[t])??e)))],n={name:t.value,sortAs:t.fileAs};return[r?.length?r:[e],n]};return l?.creator?.map(f("author"))?.concat(l?.contributor?.map?.(f("contributor")))?.forEach((([e,t])=>e.forEach((e=>{this.metadata[e]?this.metadata[e].push(t):this.metadata[e]=[t]})))),this}async loadDocument(e){const t=await this.loadText(e.href);return this.parser.parseFromString(t,e.mediaType)}async loadMediaOverlay(e){const t=e.mediaOverlay;if(!t)return null;const r=this.resources.getItemByID(t),n=((e,t=e=>e)=>{const{$:r,$$$:n}=ie(e,Y);return n(e,"par").map((e=>{const n=r(e,"text")?.getAttribute("src")?.split("#")?.[1],i=r(e,"audio");return i?{id:n,audio:{src:(o=i.getAttribute("src"),o?decodeURI(t(o)):null),clipBegin:ge(i.getAttribute("clipBegin")),clipEnd:ge(i.getAttribute("clipEnd"))}}:{id:n};var o}))})(await this.#l(r.href),(e=>oe(e,r.href)));return n}resolveCFI(e){return this.resources.resolveCFI(e)}resolveHref(e){const[t,r]=e.split("#"),n=this.resources.getItemByHref(decodeURI(t));if(!n)return null;return{index:this.resources.spine.findIndex((({idref:e})=>e===n.id)),anchor:r?e=>((e,t)=>e.getElementById(t)??e.querySelector(`[name="${CSS.escape(t)}"]`))(e,r):()=>0}}splitTOCHref(e){return e?.split("#")??[]}getTOCFragment(e,t){return e.getElementById(t)??e.querySelector(`[name="${CSS.escape(t)}"]`)}isExternal(e){return se(e)}async getCover(){const e=this.resources?.cover;return e?.href?new Blob([await this.loadBlob(e.href)],{type:e.mediaType}):null}async getCalibreBookmarks(){const e=await this.loadText("META-INF/calibre_bookmarks.txt"),t="encoding=json+base64:";if(e?.startsWith(t)){const t=atob(e.slice(21));return JSON.parse(t)}}}const ke=(e,t=!1)=>{const r=(new DOMParser).parseFromString(t?Ue(e):e,"text/html");let n=Oe(r);0===n.length&&(n=ze(r));for(let e=0;e<n.length;e++){var i=document.createElement("address"),o=document.createTextNode(" ");i.appendChild(o),n[e].parentNode&&n[e].parentNode.insertBefore(i,n[e])}const s=He(r.body.innerHTML),a={getCover:()=>""};return a.sections=s.map((e=>({id:e.index,load:()=>{return t=e.index,u(void 0,void 0,void 0,(function*(){return URL.createObjectURL(new Blob([s[t].text],{type:"text/html"}))}));var t},unload:()=>{e.index}}))),a.toc=s.map((e=>({label:e.label,href:"title"+e.index}))).filter((e=>""!==e.label)),a.rendition={layout:"pre-paginated"},a.resolveHref=e=>({index:parseInt(e.substring(5,e.length))}),a.splitTOCHref=e=>[e,null],a.getTOCFragment=e=>e.documentElement,a};let Ee=["章","节","回","節","卷","部","輯","辑","話","集","话","篇"," ","　"],Be=[],Ie=["CHAPTER","Chapter","序章","前言","声明","写在前面的话","后记","楔子","后序"],Ae=[" ","　","、","·",".","：",":"];const Oe=e=>Array.from(e.querySelectorAll("h1,h2,h3,h4,h5,h6,title")),Me=e=>e.trim().replace(/(\r\n|\n|\r|\t)/gm,"").substring(0,100).split("").filter((e=>"="!==e&&"-"!==e&&"_"!==e&&"+"!==e)).join(""),De=e=>e&&e.length<40&&!Ne(e)&&(Re(e)||e.startsWith("第")&&_e(e)||e.startsWith("卷")&&Pe(e)||e.indexOf("第")>-1&&e.lastIndexOf("第")<4&&_e(e.substr(e.indexOf("第")))||Fe(e)),Ne=e=>Be.filter((t=>e.indexOf(t)>-1)).length>0,Re=e=>Ie.filter((t=>e.startsWith(t)||e.startsWith(window.ChineseS2T.s2t(t))||e.startsWith(window.ChineseS2T.t2s(t)))).length>0,Fe=e=>Ae.filter((t=>e.indexOf(t)>-1&&(/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c\u96f6]+$/.test(e.substring(0,e.indexOf(t)))||/^\d+$/.test(e.substring(0,e.indexOf(t)))))).length>0,_e=e=>{let t=!1;for(let r=0;r<Ee.length&&((/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c\u96f6]+$/.test(e.substring(1,e.indexOf(Ee[r])).trim())||/^\d+$/.test(e.substring(1,e.indexOf(Ee[r])).trim()))&&(t=!0),!t);r++);return t},Pe=e=>!(!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c\u96f6]+$/.test(e.substring(1,e.indexOf(" ")))&&!/^\d+$/.test(e.substring(1,e.indexOf(" "))))||(!(!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c\u96f6]+$/.test(e.substring(1,e.indexOf("　")))&&!/^\d+$/.test(e.substring(1,e.indexOf("　"))))||!(!/^[\u4e00\u4e8c\u4e09\u56db\u4e94\u516d\u4e03\u516b\u4e5d\u5341\u767e\u5343\u4e07\u842c\u96f6]+$/.test(e.substring(1))&&!/^\d+$/.test(e.substring(1)))),He=e=>{let t=[],r=e.split("<address> </address>").filter((e=>""!==e.trim())),n=r.map((e=>je(e)||$e(e)));return t=r.map(((e,t)=>({index:t,label:n[t],text:e,href:"title"+t}))),t},Ue=e=>{let t="",r=e.split("\n");for(let e of r)Me(e)&&De(Me(e))?t+=`<h1>${Me(e)}</h1>`:t+=`<p>${e}</p>`;return t||`<h1>Title</h1><p>${e}</p>`},je=e=>{const t=/<h[1-6][^>]*>(.*?)<\/h[1-6]>/.exec(e);return t?t[1].replace(/&lt;/g,"<").replace(/&gt;/g,">"):""},$e=e=>{const t=/<title[^>]*>(.*?)<\/title>/.exec(e);return t?t[1].replace(/&lt;/g,"<").replace(/&gt;/g,">"):""},ze=e=>{let t=e.getElementsByTagName("*"),r=Array.from(t).filter((e=>1===e.childNodes.length&&e.childNodes[0].nodeType===Node.TEXT_NODE&&De(Me(e.textContent)))),n=[];for(let e=0;e<r.length;e++){const t=r[e],i=document.createElement("h1");i.innerHTML=t.innerText,t.parentNode.replaceChild(i,t),n.push(i)}return n};let We=!1;const qe=e=>Array.from(e.querySelectorAll("h1,h2,h3,h4,h5,h6,p,div,ul,dl,ol,pre,blockquote,address")),Xe=(e,t,r,n,i,o,s,a,l)=>u(void 0,void 0,void 0,(function*(){let c=document.getElementById("page-area");if(!c)return;let h=c.getElementsByTagName("iframe")[0];if(!h)return;let d=h.contentDocument;if(!d)return;let u=Math.floor(e.clientWidth/12),f=u%2==0?u:u-1;const p=e.clientWidth;s>0?d.body.scrollBy({top:0,left:-p-f,behavior:"sliding"===o?"smooth":"auto"}):s<0&&(yield et(e,t,r,n,i,a,l),d.body.scrollBy({top:0,left:p+f,behavior:"sliding"===o?"smooth":"auto"}))})),Ve=(e,r,n,i)=>{let o=t.findLastIndex(n,{href:r});return r&&t.findLastIndex(n,{href:r})>-1||(o=e),"prev"===i?Object.assign(Object.assign({},n[o-1]),{index:o-1}):Object.assign(Object.assign({},n[o+1]),{index:o+1})},Ge=(e,t,r,n,i,o)=>u(void 0,void 0,void 0,(function*(){let t=parseInt(o.chapterDocIndex||"0"),s=o.chapterHref||"";if(0===t)return;let a=Ve(t,s,r,"prev");a&&(o.text="prevChapter",o.page="",yield Ke(a.index,a.label,a.href,r,e,n,i,o))})),Je=(e,t,r,n)=>u(void 0,void 0,void 0,(function*(){let{width:i,height:o}=yield r[n].text.getDimension(),s="double"===t?2:1,a=Math.floor(e.clientWidth/12),l=a%2==0?a:a-1,c=(e.clientWidth-l)/s;"single"===t&&(c=e.clientWidth);let h=e.clientHeight,d=Math.min(c/i,h/o);return"scroll"===t&&(d=c/i),d})),Ke=(e,r,n,i,o,s,a,l)=>u(void 0,void 0,void 0,(function*(){let c=document.getElementById("page-area");if(!c)return;let h=c.getElementsByTagName("iframe")[0];if(!h)return;let d=h.contentDocument;if(d){if(d.body.innerHTML="",h.height="0px",d.body.scrollTo(0,0),r&&!e||i[e]&&i[e].label&&r&&r!==i[e].label&&-1===n.indexOf("#")){let n=t.findLastIndex(i,{label:r});-1!==n&&(e=n)}if((-1===e||e>i.length-1)&&(e=0),d.body.innerHTML=yield p(i[e].text),"PDF"===a){let t=yield Je(o,s,i,e);yield i[e].text.render(d,t)}yield Ze(d),l.chapterDocIndex&&i[l.chapterDocIndex].text&&i[l.chapterDocIndex].text.unload&&i[l.chapterDocIndex].text.unload(),l.chapterTitle=r,l.chapterHref=n,l.chapterDocIndex=e+"",l.percentage=e/i.length+"",l.text="",yield((e,t,r,n)=>u(void 0,void 0,void 0,(function*(){let i=r.contentDocument;if(i)if(yield Promise.all(Array.from([...i.images,...i.querySelectorAll("image")]).map((e=>e.complete?Promise.resolve(0!==e.naturalHeight):new Promise((t=>{e.addEventListener("load",(()=>t(!0))),e.addEventListener("error",(()=>t(!1)))}))))).then((e=>{e.every((e=>e))?console.log("all images loaded successfully!!"):console.log("some images failed to load, all finished loading")})),yield C(e,t,n),"PDF"!==n&&v(),"scroll"!==t){if(r.height=e.clientHeight+"px","double"===t){let t=Math.floor(e.clientWidth/12),r=t%2==0?t:t-1,n=(e.clientWidth+r)/2;if((i.body.scrollWidth-i.body.clientWidth)/n%2==1){let e=document.createElement("div");e.setAttribute("style","height: "+i.body.clientHeight+"px; display: inline-block; width: "+(n-r)+"px"),i.body.appendChild(e)}}}else if("PDF"===n){let e=i.querySelector(".koodoPDFLayer");r.height=e.getBoundingClientRect().height+100+"px"}else r.height=i.body.scrollHeight+"px",r.height=i.body.scrollHeight+300+"px"})))(o,s,h,a),Ye(o,s,"","","","")}})),Ze=e=>u(void 0,void 0,void 0,(function*(){let t=Array.from(e.getElementsByTagName("link"));for(let e=0;e<t.length;e++){t[e].onload=()=>{console.log("finished")}}let r=[];for(let e=0;e<t.length;e++){const n=t[e];n.href.endsWith("null")||r.push(new Promise(((e,t)=>{n.addEventListener("load",e)})))}try{yield Promise.race([Promise.all(r),new Promise(((e,t)=>{setTimeout((()=>{t(new Error("Timeout"))}),1e3)}))])}catch(e){console.log(e)}})),Ye=(t,r,n,i,o,s)=>u(void 0,void 0,void 0,(function*(){let a=document.getElementById("page-area");if(!a)return;let l=a.getElementsByTagName("iframe")[0];if(!l)return;let c=l.contentDocument;if(!c)return;let h=0,d=0,u=c.body;if(s&&"scroll"!==r){let e=Math.floor(t.clientWidth/12),r=e%2==0?e:e-1;d=((p=getComputedStyle(t).width,parseFloat(p.substring(0,p.length-2)))+r)*(parseInt(s)-1)}else if(n){let o=qe(c.body);console.log("nodeList",o.length);let s=o.filter(((t,r)=>(console.log(Me(t.textContent),Me(n),r),Me(t.textContent)&&(Me(t.textContent)===Me(n)||Me(t.textContent)===e.t2s(Me(n))||Me(t.textContent)===e.s2t(Me(n)))&&(Math.abs(r-parseInt(i))<2||"search"===i||"ignore"===i||"next"===i))));if(0===s.length)return void console.log("failed");u=Qe(s[0],t,r),d=u?f(u.offsetLeft)-f(u.marginLeft||parseFloat(getComputedStyle(u).marginLeft)):"prevChapter"===n?c.body.scrollWidth:0,h=u?f(u.offsetTop)-f(u.marginTop||parseFloat(getComputedStyle(u).marginTop)):0}else if(o&&o.indexOf("#")>-1){let e=CSS.escape(o.split("#").reverse()[0]);if(!c.body.querySelector("#"+e))return;u=Qe(c.body.querySelector("#"+e)||c.body,t,r),d=u?f(u.offsetLeft)-f(u.marginLeft||parseFloat(getComputedStyle(u).marginLeft)):0,h=u?f(u.offsetTop)-f(u.marginTop||parseFloat(getComputedStyle(u).marginTop)):0}var p;"scroll"!==r?c.body.scrollTo(d,0):t.scrollTo(0,h)})),Qe=(e,t,r)=>{let n=Math.floor(t.clientWidth/12),i=n%2==0?n:n-1;return"scroll"===r||"scroll"!==r&&parseInt(f(e.offsetLeft)-f(e.marginLeft||parseFloat(getComputedStyle(e).marginLeft))+"")%((t.clientWidth+i)/2)==0?e:e.parentElement?Qe(e.parentElement,t,r):e},et=(e,t,r,n,i,o,s)=>u(void 0,void 0,void 0,(function*(){let a=document.getElementById("page-area");if(!a)return;let l=a.getElementsByTagName("iframe")[0];if(!l)return;let c=l.contentDocument;c&&Math.abs(e.scrollHeight-f(e.scrollTop)-e.clientHeight)<10&&Math.abs(c.body.scrollWidth-f(c.body.scrollLeft)-c.body.clientWidth)<10&&(yield nt(e,t,r,n,i,s),o("rendered"))})),tt=(e,t,r)=>{let n=Math.floor(t.clientWidth/12),i=n%2==0?n:n-1;return Math.abs(e.offsetLeft-Qe(e,t,r).offsetLeft)>(t.clientWidth+i)/2},rt=(e,r,n)=>{let i=n.chapterHref||"",o=i.lastIndexOf("#"),s=i.substring(0,o),a=i.substring(o+1);for(let i=0;i<e.length;i++){const o=e[i];if(a&&o.id){let e=s+"#"+o.id;t.findLastIndex(r,{href:e})>-1&&(n.chapterHref=e)}}},nt=(e,t,r,n,i,o)=>u(void 0,void 0,void 0,(function*(){let t=parseInt(o.chapterDocIndex||"0"),s=o.chapterHref||"";if(t>=r.length-1)return void(o.percentage="1");let a=Ve(t,s,r,"next");a&&(o.page="",yield Ke(a.index,a.label,a.href,r,e,n,i,o))})),it=(e,t)=>{let r=document.getElementById("page-area");if(!r)return;let n=r.getElementsByTagName("iframe")[0];if(!n)return;let i=n.contentDocument;return i?qe(i.body).filter((e=>!ot(e))).filter((r=>st(e,r,t)&&(r.textContent||"").trim())).filter((e=>"img"!==e.textContent)).map((e=>e.textContent)):void 0},ot=e=>{var t=e.children;let r=!1;var n=/^(address|section|blockquote|body|center|dir|div|dl|fieldset|form|h[1-6]|hr|isindex|menu|noframes|noscript|ol|p|pre|table|ul|dd|dt|frameset|li|tbody|td|tfoot|th|thead|tr|html)$/i;if(Array.from(t).filter((e=>n.test(e.nodeName))).length<3)return!1;for(var i=0;i<t.length;i++)if(n.test(t[i].nodeName)){r=!0;break}return r},st=(e,t,r)=>{var n=!1,i=t.getBoundingClientRect();if("scroll"!==r&&t.textContent&&t.textContent.trim()){let t=i.left;n=t>-10&&t<=e.clientWidth}else if("scroll"===r&&t.textContent&&t.textContent.trim()){let t=i.top;n=t>=e.scrollTop&&t<=e.scrollTop+e.clientHeight}else if("scroll"!==r){let t=i.left;n=t>=0&&t<=e.clientWidth}return n};class at{constructor(){this.callbacks={},this.callbacks.base={}}on(e,t){const r=this;if(void 0===e||""===e)return console.warn("wrong names"),!1;if(void 0===t)return console.warn("wrong callback"),!1;return this.resolveNames(e).forEach((function(e){const n=r.resolveName(e);r.callbacks[n.namespace]instanceof Object||(r.callbacks[n.namespace]={}),r.callbacks[n.namespace][n.value]instanceof Array||(r.callbacks[n.namespace][n.value]=[]),r.callbacks[n.namespace][n.value].push(t)})),this}off(e){const t=this;if(void 0===e||""===e)return console.warn("wrong name"),!1;return this.resolveNames(e).forEach((function(e){const r=t.resolveName(e);if("base"!==r.namespace&&""===r.value)delete t.callbacks[r.namespace];else if("base"===r.namespace)for(const e in t.callbacks)t.callbacks[e]instanceof Object&&t.callbacks[e][r.value]instanceof Array&&(delete t.callbacks[e][r.value],0===Object.keys(t.callbacks[e]).length&&delete t.callbacks[e]);else t.callbacks[r.namespace]instanceof Object&&t.callbacks[r.namespace][r.value]instanceof Array&&(delete t.callbacks[r.namespace][r.value],0===Object.keys(t.callbacks[r.namespace]).length&&delete t.callbacks[r.namespace])})),this}trigger(e,t=[]){if(void 0===e||""===e)return console.warn("wrong name"),!1;const r=this;const n=t instanceof Array?t:[];let i=this.resolveNames(e);i=this.resolveName(i[0]),setTimeout((()=>{if("base"===i.namespace)for(const e in r.callbacks){if(r.callbacks[e]instanceof Object&&r.callbacks[e][i.value]instanceof Array&&r.callbacks[e][i.value])r.callbacks[e][i.value].forEach((function(e){e.apply(r,n)}));else if(this.callbacks[i.namespace]instanceof Object&&r.callbacks[i.namespace][i.value]){if(""===i.value)return console.warn("wrong name"),this;r.callbacks[i.namespace][i.value].forEach((function(e){e.apply(r,n)}))}return null}}),100)}resolveNames(e){let t=e;return t=t.replace(/[^a-zA-Z0-9 ,/.]/g,""),t=t.replace(/[,/]+/g," "),t=t.split(" "),t}resolveName(e){const t={},r=e.split(".");return t.original=e,t.value=r[0],t.namespace="base",r.length>1&&""!==r[1]&&(t.namespace=r[1]),t}}const lt={svg:"image/svg+xml",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",webp:"image/webp",zip:"application/zip",rar:"application/x-rar-compressed","7z":"application/x-7z-compressed",tar:"application/x-tar",html:"text/html",htm:"text/html",xml:"text/xml",xhtml:"application/xhtml+xml",css:"text/css"},ct={"image/svg+xml":"svg","image/png":"png","image/jpeg":"jpg","image/gif":"gif","image/webp":"webp","application/zip":"zip","application/x-rar-compressed":"rar","application/x-7z-compressed":"7z","application/x-tar":"tar","text/html":"html","text/xml":"xml","application/xhtml+xml":"xhtml","text/css":"css"},ht=Node.ELEMENT_NODE,dt=Node.TEXT_NODE,ut=Node.CDATA_SECTION_NODE;function ft(e,t,r){let n,i,o,s=0,a=0,l=!0;for(i=0;i<e.length;i++)if(o=e[i],o.nodeType===ht){if(n||l?(s+=2,l=!1):s++,t===o)return"img"===o.tagName.toLowerCase()?{count:s,offset:r}:{count:s};a=0,n=!0}else{if((null==o?void 0:o.nodeType)!==dt&&(null==o?void 0:o.nodeType)!==ut)continue;if((n||l)&&(s++,l=!1),t===o)return{count:s,offset:r+a};a+=o.textContent.length,n=!1}throw new Error("The specified node was not found in the array of siblings")}function pt(e,t){const r="number"==typeof e,n="number"==typeof t;return r||n?!r&&n?-1:r&&!n?1:(e||0)-(t||0):0}function gt(e,t){if(!e&&!t)return 0;if(!e&&t)return-1;if(e&&!t)return 1;const r=(e.y||0)-(t.y||0);return r||(e.x||0)-(t.x||0)}class mt{constructor(e,t){this.isRange=!1,this.opts=Object.assign({flattenRange:!1,stricter:!0},t||{}),this.cfi=e,this.parts=[];const r=(e=e.trim()).match(/^epubcfi\((.*)\)$/);if(!r)throw new Error("Not a valid CFI");if(r.length<2)return;let n,i,o;e=r[1]||"";let s=[],a=0;for(;e.length;){if(({parsed:n,offset:i,newDoc:o}=this.parse(e)),!n||null===i)throw new Error("Parsing failed");if(a&&o)throw new Error("CFI is a range that spans multiple documents. This is not allowed");s.push(n),(o||e.length-i<=0)&&(2===a?this.to=s:this.parts.push(s),s=[]),","===(e=e.slice(i))[0]&&(0===a?(s.length&&this.parts.push(s),s=[]):1===a&&(s.length&&(this.from=s),s=[]),e=e.slice(1),a++)}this.from&&this.from.length&&(!this.opts.flattenRange&&this.to&&this.to.length?this.isRange=!0:(this.parts=this.parts.concat(this.from),delete this.from,delete this.to)),this.opts.stricter&&this.removeIllegalOpts()}removeIllegalOpts(e){if(!e)if(this.from){if(this.removeIllegalOpts(this.from),!this.to)return;e=this.to}else e=this.parts;let t,r,n,i;for(t=0;t<e.length;t++)for(n=e[t],r=0;r<n.length-1;r++)i=n[r],delete i.temporal,delete i.spatial,delete i.offset,delete i.textLocationAssertion}static generatePart(e,t,r){let n,i="";for(;e.parentNode;)n=ft(e.parentNode.childNodes,e,t),!i&&n.offset&&(i=":"+n.offset),i="/"+n.count+(e.id?"["+(e.id.replace(/[\[\]\^,();]/g,"^$&")+"]"):"")+i,e=e.parentNode;return i}static generate(e,t,r){let n;if(Array.isArray(e)){const t=[];for(const n of e)t.push(this.generatePart(n.node,n.offset,r));n=t.join("!")}else n=this.generatePart(e,t,r);return r&&(n+=r),"epubcfi("+n+")"}static toParsed(e){return e.isRange?e.getFrom():e.get()}static comparePath(e,t){const r=Math.max(e.length,t.length);let n,i,o,s;for(n=0;n<r;n++){if(i=e[n],o=t[n],!i)return-1;if(!o)return 1;if(s=this.compareParts(i,o),s)return s}return 0}static sort(e){e.sort(((e,t)=>this.compare(e,t)))}static compare(e,t){let r=e.get(),n=t.get();if(e.isRange||t.isRange){if(e.isRange&&t.isRange){const e=this.comparePath(r.from,n.from);return e||this.comparePath(r.to,n.to)}return e.isRange&&(r=r.from),t.isRange&&(n=n.from),this.comparePath(r,n)}return this.comparePath(r,n)}static compareParts(e,t){const r=Math.max(e.length,t.length);let n,i,o,s;for(n=0;n<r;n++){if(i=e[n],o=t[n],!i)return-1;if(!o)return 1;if(s=i.nodeIndex-o.nodeIndex,s)return s;if(0===i.nodeIndex)return 0;if(!(n<r-1)){if(i.nodeIndex%2==0){if(s=pt(i.temporal,o.temporal),s)return s;if(s=gt(i.spatial,o.spatial),s)return s}if(s=(i.offset||0)-(o.offset||0),s)return s}}return 0}decodeEntities(e,t){try{const r=e.createElement("textarea");return r.innerHTML=t,r.value||""}catch(e){return t}}trueLength(e,t){return this.decodeEntities(e,t).length}getFrom(){if(!this.isRange)throw new Error("Trying to get beginning of non-range CFI");if(!this.from)return this.deepClone(this.parts);const e=this.deepClone(this.parts);return e[e.length-1]=e[e.length-1].concat(this.from),e}getTo(){if(!this.isRange)throw new Error("Trying to get end of non-range CFI");const e=this.deepClone(this.parts);return e[e.length-1]=e[e.length-1].concat(this.to),e}get(){return this.isRange?{from:this.getFrom(),to:this.getTo(),isRange:!0}:this.deepClone(this.parts)}parseSideBias(e,t){if(!t)return;const r=t.trim().match(/^(.*);s=([ba])$/);!r||r.length<3?"object"==typeof e.textLocationAssertion?e.textLocationAssertion.post=t:e.textLocationAssertion=t:(r[1]&&("object"==typeof e.textLocationAssertion?e.textLocationAssertion.post=r[1]:e.textLocationAssertion=r[1]),"a"===r[2]?e.sideBias="after":e.sideBias="before")}parseSpatialRange(e){if(!e)return;const t=e.trim().match(/^([\d\.]+):([\d\.]+)$/);if(!t||t.length<3)return;const r={x:parseInt(t[1]),y:parseInt(t[2])};return"number"==typeof r.x&&"number"==typeof r.y?r:void 0}parse(e){const t={},r=/[\d]/;let n,i,o,s,a,l,c=!1,h=!1;for(l=0;l<=e.length;l++)if(s=l<e.length?e[l]:"","^"!==s||a){if("/"===i){if(s.match(r)){n?n+=s:n=s,a=!1;continue}n&&(t.nodeIndex=parseInt(n),n=null),o=i,i=null}if(":"===i){if(s.match(r)){n?n+=s:n=s,a=!1;continue}n&&(t.offset=parseInt(n),n=null),o=i,i=null}if("@"===i){let e=!1;if(s.match(r)||"."===s||":"===s?":"===s&&(c?e=!0:c=!0):e=!0,!e){n?n+=s:n=s,a=!1;continue}o=i,i=null,n&&c&&(t.spatial=this.parseSpatialRange(n)),n=null}if("~"===i){if(s.match(r)||"."===s){n?n+=s:n=s,a=!1;continue}n&&(t.temporal=parseFloat(n)),o=i,i=null,n=null}if(!i){if("!"===s){l++,i=s;break}if(","===s)break;if("/"===s){if(h)break;h=!0,o=i,i=s,a=!1;continue}if(":"===s||"~"===s||"@"===s){if(this.opts.stricter){if(":"===s&&(void 0!==t.temporal||void 0!==t.spatial))break;if(("~"===s||"@"===s)&&void 0!==t.offset)break}o=i,i=s,a=!1,c=!1;continue}if("["===s&&!a&&":"===o){o=i,i="[",a=!1;continue}if("["===s&&!a&&"/"===o){o=i,i="nodeID",a=!1;continue}}"["!==i?("nodeID"!==i||("]"!==s||a?n?n+=s:n=s:(o=i,i=null,t.nodeID=n,n=null)),a=!1):("]"!==s||a?","!==s||a?n?n+=s:n=s:(t.textLocationAssertion={},n&&(t.textLocationAssertion.pre=n),n=null):(o=i,i=null,this.parseSideBias(t,n),n=null),a=!1)}else a=!0;if(!t.nodeIndex&&0!==t.nodeIndex)throw new Error("Missing child node index in CFI");return{parsed:t,offset:l,newDoc:"!"===i}}getChildNodeByCFIIndex(e,t,r,n){const i=t.childNodes;if(!i.length)return{node:t,offset:0};if(r<=0)return{node:i[0],relativeToNode:"before",offset:0};let o,s,a,l=0;for(s=0;s<i.length;s++)switch(a=i[s],a.nodeType){case ht:if(l%2==0){if(l+=2,l>=r)return"img"===a.tagName.toLowerCase()&&n?{node:a,offset:n}:{node:a,offset:0}}else{if(l+=1,l===r)return"img"===a.tagName.toLowerCase()&&n?{node:a,offset:n}:{node:a,offset:0};if(l>r)return o?{node:o,offset:this.trueLength(e,o.textContent)}:{node:t,offset:0}}o=a;break;case dt:case ut:if(0!==l&&l%2!=0||(l+=1),l===r){const t=this.trueLength(e,a.textContent);if(!(n>=t))return{node:a,offset:n};n-=t}o=a;break;default:continue}if(r>l){const r={relativeToNode:"after",offset:0};return r.node=o||t,this.isTextNode(r.node)&&(r.offset=this.trueLength(e,r.node.textContent.length)),r}}isTextNode(e){return!!e&&(e.nodeType===dt||e.nodeType===ut)}correctOffset(e,t,r,n){let i,o=t;if("string"==typeof n?i=this.decodeEntities(e,n):(n.pre=this.decodeEntities(e,n.pre),n.post=this.decodeEntities(e,n.post),i=n.pre+"."+n.post),!this.isTextNode(t))return{node:t,offset:0};for(;this.isTextNode(o.previousSibling);)o=o.previousSibling;const s=o;let a;const l=[];let c="",h=0;for(;this.isTextNode(o)&&(a=this.decodeEntities(e,o.textContent),l[h]=a.length,c+=a,o.nextSibling);)o=o.nextSibling,h++;const d=n.pre?n.pre.length:0,u=function(e,t,r){r=r||0;const n=[];let i,o=0;do{if(i=e.match(t),!i)break;n.push(i.index+r),o+=i.index+i.length,e=e.slice(i.index+i.length)}while(o<e.length);return n}(c,new RegExp(i),d);if(!u.length)return{node:t,offset:r};let f=function(e,t){let r,n,i,o;for(i=0;i<e.length;i++)o=Math.abs(e[i]-t),(!i||o<r)&&(o=r,n=e[i]);return n}(u,r);if(o===t&&f===r)return{node:t,offset:r};for(h=0,o=s;f>=l[h];){if(f-=l[h],f<0)return{node:t,offset:r};const e=[];if(!o.nextSibling||h+1>=e.length)return{node:t,offset:r};h++,o=o.nextSibling}return{node:o,offset:f}}resolveNode(e,t,r,n){if(n=Object.assign({},n||{}),!r)throw new Error("Missing DOM argument");let i;if(0===e&&(i=r.querySelector("package")),!i)for(const e of r.childNodes)if(e.nodeType===ht){i=e;break}if(i=r,!i)throw new Error("Document incompatible with CFIs");let o,s,a=i,l=0;for(o=t.length-1;o>=0;o--)if(s=t[o],!n.ignoreIDs&&s.nodeID&&(a=r.getElementById(s.nodeID))){l=o+1;break}a||(a=i);let c={node:a,offset:0};for(o=l;o<t.length;o++)s=t[o],s&&(c=this.getChildNodeByCFIIndex(r,c.node,s.nodeIndex,s.offset),s.textLocationAssertion&&(c=this.correctOffset(r,c.node,s.offset,s.textLocationAssertion)));return c}resolveURI(e,t,r){if(r=r||{},e<0||e>this.parts.length-2)throw new Error("index is out of bounds");const n=this.parts[e];if(!n)throw new Error("Missing CFI part for index: "+e);let i=this.resolveNode(e,n,t,r).node;const o=i.tagName.toLowerCase();if("itemref"===o&&"spine"===i.parentNode.tagName.toLowerCase()){const e=i.getAttribute("idref");if(!e)throw new Error("Referenced node had not 'idref' attribute");if(i=t.getElementById(e),!i)throw new Error("Specified node is missing from manifest");const r=i.getAttribute("href");if(!r)throw new Error("Manifest item is missing href attribute");return r}if("iframe"===o||"embed"===o){const e=i.getAttribute("src");if(!e)throw new Error(o+" element is missing 'src' attribute");return e}if("object"===o){const e=i.getAttribute("data");if(!e)throw new Error(o+" element is missing 'data' attribute");return e}if("image"===o||"use"===o){const e=i.getAttribute("xlink:href");if(!e)throw new Error(o+" element is missing 'xlink:href' attribute");return e}throw new Error("No URI found")}deepClone(e){return JSON.parse(JSON.stringify(e))}resolveLocation(e,t){const r=t.length-1,n=t[r];if(!n)throw new Error("Missing CFI part for index: "+r);const i=this.resolveNode(r,n,e),o=this.deepClone(n[n.length-1]);return delete o.nodeIndex,o.offset||delete i.offset,Object.assign(Object.assign({},o),i)}resolveLast(e,t){if(t=Object.assign({range:!1},t||{}),!this.isRange)return this.resolveLocation(e,this.parts);if(t.range){const t=e.createRange(),r=this.getFrom();"before"===r.relativeToNode?t.setStartBefore(r.node,r.offset):"after"===r.relativeToNode?t.setStartAfter(r.node,r.offset):t.setStart(r.node,r.offset);const n=this.getTo();return"before"===n.relativeToNode?t.setEndBefore(n.node,n.offset):"after"===n.relativeToNode?t.setEndAfter(n.node,n.offset):t.setEnd(n.node,n.offset),t}return{from:this.resolveLocation(e,this.getFrom()),to:this.resolveLocation(e,this.getTo()),isRange:!0}}resolve(e,t){return this.resolveLast(e,t)}}const yt=["color-0","color-1","color-2","color-3","line-0","line-1","line-2","line-3"],bt=["#FEF3CD","#FBFACC","#CEFACD","#CDE9FA"],wt=["#fac106","#ebe702","#0be603","#0493e6"],vt=["#FF0000","#000080","#0000FF","#2EFF2E"],xt=(e,t,r,n)=>{var i,o;let s=yt[t],a=document.getElementById("page-area");if(!a)return;let l=a.getElementsByTagName("iframe")[0];if(!l||!l.contentWindow)return;let c=l.contentWindow||(null===(i=l.contentDocument)||void 0===i?void 0:i.defaultView),h=l.contentDocument;if(!h)return;let d=e;d=[d],window.rangy.getSelection(l).restoreCharacterRanges(h,d);let u=h.getSelection();if(!u)return;let f=u.getRangeAt(0);for(var p=kt(f),g=0;g<p.length;g++)St(p[g],s,r,n,h);c&&c.getSelection()&&(null===(o=c.getSelection())||void 0===o||o.empty())},Ct=(e,t,r,n,i,o)=>{let s=document.getElementById("page-area");if(!s)return;let a=s.getElementsByTagName("iframe")[0];if(!a||!a.contentWindow)return;let l=a.contentDocument;if(!l)return;let c=yt[t],h=l.querySelector(".noteLayer");var d=i.getViewport({scale:o});e.coords.forEach((e=>{var t=d.convertToViewportRectangle(e),i=document.createElement("div");null==i||i.setAttribute("style","position: absolute;"+(c.indexOf("color")>-1?"background-color: ":"border-bottom: ")+(c.indexOf("color")>-1?wt[c.split("-")[1]]:`2px solid ${vt[c.split("-")[1]]}`)+"; left:"+Math.min(t[0],t[2])+"px; top:"+Math.min(t[1],t[3])+"px;width:"+Math.abs(t[0]-t[2])+"px; height:"+Math.abs(t[1]-t[3])+"px; z-index: 1;opacity: "+(c.indexOf("color")>-1?.3:1)+";"),null==i||i.setAttribute("data-key",r),null==i||i.setAttribute("class","kookit-note"),null==i||i.addEventListener("click",(e=>{e&&e.target&&e.target.dataset&&e.target.dataset.key&&n(e)})),h.appendChild(i)}))},Lt=()=>{let e=document.getElementById("page-area");if(!e)return;let t=e.getElementsByTagName("iframe")[0];if(!t||!t.contentWindow)return;let r=t.contentDocument;if(!r)return;const n=r.querySelectorAll(".kookit-note");for(let e=0;e<n.length;e++){const t=n[e];t.parentNode.removeChild(t)}},St=(e,t,r,n,i)=>{const o=Tt(e.getClientRects());for(let e=0;e<o.length;e++){const l=o[e];var s=document.createElement("span");null==s||s.setAttribute("style","position: absolute;"+(t.indexOf("color")>-1?"background-color: ":"border-bottom: ")+(t.indexOf("color")>-1?bt[t.split("-")[1]]+";opacity: 1":`2px solid ${vt[t.split("-")[1]]}`)+";left:"+(Math.min(l.left,l.x)+i.body.scrollLeft)+"px; top:"+(Math.min(l.top,l.y)+i.body.scrollTop)+"px;width:"+l.width+"px; height:"+l.height+"px; z-index:-1;"),s.setAttribute("class"," kookit-note"),s.setAttribute("data-key",r),i.body.appendChild(s);var a=document.createElement("span");null==a||a.setAttribute("style","position: absolute;left:"+(Math.min(l.left,l.x)+i.body.scrollLeft)+"px; top:"+(Math.min(l.top,l.y)+i.body.scrollTop)+"px;width:"+l.width+"px; height:"+l.height+"px; z-index:1;"),a.setAttribute("class"," kookit-note"),a.setAttribute("data-key",r),a.addEventListener("click",(e=>{e&&e.target&&e.target.dataset&&e.target.dataset.key&&n(e)})),i.body.appendChild(a)}},Tt=e=>{let t=[];for(let r=0;r<e.length;r++){const n=e[r];t.push(n)}return t},kt=e=>{var t=e.commonAncestorContainer,r=new Array(0),n=new Array(0);if(e.startContainer!==t)for(let n=e.startContainer;n!==t;n=n.parentNode)r.push(n);if(r.length>0)for(let t=0;t<r.length;t++){var i=document.createRange();t?(i.setStartAfter(r[t-1]),i.setEndAfter(r[t].lastChild)):(i.setStart(r[t],e.startOffset),i.setEndAfter(r[t].nodeType===Node.TEXT_NODE?r[t]:r[t].lastChild)),n.push(i)}var o=new Array(0),s=new Array(0);if(e.endContainer!==t)for(var a=e.endContainer;a!==t;a=a.parentNode)o.push(a);if(o.length>0)for(let t=0;t<o.length;t++){var l=document.createRange();t?(l.setStartBefore(o[t].firstChild),l.setEndBefore(o[t-1])):(l.setStartBefore(o[t].nodeType===Node.TEXT_NODE?o[t]:o[t].firstChild),l.setEnd(o[t],e.endOffset)),s.unshift(l)}if(!(r.length>0&&o.length>0))return[e];var c=document.createRange();return c.setStartAfter(r[r.length-1]),c.setEndBefore(o[o.length-1]),n.push(c),n.concat(s)};class Et extends at{constructor(e,t,r){super(),this.mode=e,this.animation=r,this.format=t,this.chapterList=[],this.chapterDocList=[],this.flattenChapters=[],this.book="",this.element="",this.tempLocation={}}getPageSize(){let e="double"===this.mode?2:1,t=Math.floor(this.element.clientWidth/12),r=t%2==0?t:t-1;return{width:this.element.clientWidth,height:this.element.clientHeight,left:this.element.offsetLeft,top:this.element.offsetTop,scrollTop:this.element.scrollTop,sectionWidth:(this.element.clientWidth-r)/e,gap:r}}getCache(e){return new Promise(((t,n)=>u(this,void 0,void 0,(function*(){let n=new S(e);this.chapterList=yield n.getChapter(e.toc),this.chapterDocList=yield n.getChapterDoc();let i=this.chapterList,o=this.chapterDocList.map((e=>({href:e.href,label:e.label}))),s=yield Promise.all(this.chapterDocList.map((e=>u(this,void 0,void 0,(function*(){let t="";if(e.text.load){let r=yield fetch(yield e.text.load()).then((e=>e.blob()));t=yield r.text()}return t}))))),a=new r;a.file("toc.json",JSON.stringify(i)),a.file("sections.json",JSON.stringify(o));let l=[];for(let e=0;e<s.length;e++){let t=(new DOMParser).parseFromString(s[e],"text/html"),r=g(t);for(let t=0;t<r.length;t++){let n=a.folder("imgs/"+e);if(!n)break;if(r[t].getAttribute("src"))try{let i=yield fetch(yield r[t].getAttribute("src")).then((e=>e.blob()));n.file(t+"."+ct[i.type],i),r[t].src="imgs/"+e+"/"+t+"."+ct[i.type]}catch(e){console.log(e)}}let n=Array.from(t.getElementsByTagName("link"));for(let t=0;t<n.length;t++){let r=n[t],i=a.folder("css/"+e);if(!i)break;if(r.getAttribute("href"))try{let n=yield fetch(yield r.getAttribute("href")).then((e=>e.blob()));i.file(t+"."+ct[n.type],n),r.href="css/"+e+"/"+t+"."+ct[n.type]}catch(e){console.log(e)}}l.push(t.documentElement.innerHTML)}let c=a.folder("chapters");if(c){for(let e=0;e<l.length;e++)c.file(e+".html",l[e]);a.generateAsync({type:"blob"}).then((e=>u(this,void 0,void 0,(function*(){t(yield new Response(e).arrayBuffer())})))).catch((e=>{t("err")}))}}))))}resolveChapter(e){let t=e,r=-1;for(let e=0;e<this.flattenChapters.length;e++)if(this.flattenChapters[e].href.includes(t)){r=e;break}if(r>-1)return this.flattenChapters[r];{let n=e.split("#")[0];for(let e=0;e<this.flattenChapters.length;e++)if(this.flattenChapters[e].href.includes(n.substring(1))){r=e;break}if(r>-1)return this.flattenChapters[r];for(let e=0;e<this.chapterDocList.length;e++)if(this.chapterDocList[e].text&&this.chapterDocList[e].text.id&&(this.chapterDocList[e].text.id+"").includes(t)){r=e;break}return r>-1?{label:"",href:"",index:r}:null}}flatChapter(e){let t=[];for(let r=0;r<e.length;r++)e[r].subitems&&e[r].subitems.length>0?(t.push(e[r]),t=t.concat(this.flatChapter(e[r].subitems))):t.push(e[r]);return this.flattenChapters=t,t}getChapter(){return this.chapterList}getChapterDoc(){return this.chapterDocList}goToPercentage(e){return u(this,void 0,void 0,(function*(){if(this.flattenChapters.length>0){let t=1===e?this.flattenChapters.length-1:Math.floor(this.flattenChapters.length*e);yield this.goToChapter(this.flattenChapters[t].index.toString(),this.flattenChapters[t].href,this.flattenChapters[t].label)}}))}goToChapterIndex(e){return u(this,void 0,void 0,(function*(){this.flattenChapters.length>0&&(yield this.goToChapter(this.flattenChapters[e].index,this.flattenChapters[e].href,this.flattenChapters[e].label))}))}goToChapter(e,t,r){return u(this,void 0,void 0,(function*(){yield Ke(parseInt(e),r,t,this.chapterDocList,this.element,this.mode,this.format,this.tempLocation),t&&t.indexOf("#")>-1&&(yield Ye(this.element,this.mode,"","",t,"")),yield this.record(),this.trigger("rendered")}))}goToPosition(e){return u(this,void 0,void 0,(function*(){let t=JSON.parse(e);this.tempLocation={text:t.text,chapterTitle:t.chapterTitle,chapterDocIndex:t.chapterDocIndex,chapterHref:t.chapterHref,count:t.count,page:t.page};let{text:r,chapterTitle:n,chapterDocIndex:i,chapterHref:o,count:s,page:a,cfi:l}=t;if(yield Ke(parseInt(i),n,o,this.chapterDocList,this.element,this.mode,this.format,this.tempLocation),l){const e=new mt(l,{});let t=document.getElementById("page-area");if(!t)return;let n=t.getElementsByTagName("iframe")[0];if(!n)return;let i=n.contentDocument;if(!i)return;const{node:o,offset:a}=e.resolve(i,{});if(console.log(o,a),!o)return;let c=null,h=o;for(;h;){const e=h;if(e.tagName&&"h1,h2,h3,h4,h5,h6,p,div,ul,dl,ol,pre,blockquote,address".indexOf(e.tagName.toLowerCase())>-1){c=e;break}h=h.parentNode}if(!c)return;s="ignore",r=c.textContent}yield Ye(this.element,this.mode,r,s,"",a),yield this.record(),this.trigger("rendered")}))}goToNode(e){return u(this,void 0,void 0,(function*(){let t=document.getElementById("page-area");if(!t)return;let r=t.getElementsByTagName("iframe")[0];if(!r)return;let n=r.contentDocument;if(!n)return;let i=Qe(e,this.element,this.mode),o=i?f(i.offsetLeft)-f(i.marginLeft||parseFloat(getComputedStyle(i).marginLeft)):0,s=i?f(i.offsetTop)-f(i.marginTop||parseFloat(getComputedStyle(i).marginTop)):0;"scroll"!==this.mode?n.body.scrollTo(o,0):this.element.scrollTo(0,s),yield this.record(),this.trigger("rendered")}))}removeContent(){this.element.innerHTML=""}prev(){return u(this,void 0,void 0,(function*(){this.trigger("page-changed");let e=document.getElementById("page-area");if(!e)return;let t=e.getElementsByTagName("iframe")[0];if(!t)return;let r=t.contentDocument;if(r){if("scroll"===this.mode||0===f(r.body.scrollLeft)){yield Ge(this.element,this.flatChapter(this.chapterList),this.chapterDocList,this.mode,this.format,this.tempLocation),parseInt(this.tempLocation.chapterDocIndex||"-1")>-1&&r.body.scrollTo(r.body.scrollWidth,0),this.trigger("rendered")}else yield Xe(this.element,this.flatChapter(this.chapterList),this.chapterDocList,this.mode,this.format,this.animation,1,this.trigger,this.tempLocation);yield this.record()}}))}next(){return u(this,void 0,void 0,(function*(){this.trigger("page-changed");let e=document.getElementById("page-area");if(!e)return;let t=e.getElementsByTagName("iframe")[0];if(!t)return;let r=t.contentDocument;r&&(Math.abs(r.body.scrollWidth-f(r.body.scrollLeft)-r.body.clientWidth)<10&&"scroll"!==this.mode||Math.abs(this.element.scrollHeight-f(this.element.scrollTop)-this.element.clientHeight)<10&&"scroll"===this.mode?(yield nt(this.element,this.flatChapter(this.chapterList),this.chapterDocList,this.mode,this.format,this.tempLocation),this.trigger("rendered")):"scroll"===this.mode?this.element.scrollBy({left:0,top:this.element.clientHeight-50,behavior:"smooth"}):yield Xe(this.element,this.flatChapter(this.chapterList),this.chapterDocList,this.mode,this.format,this.animation,-1,this.trigger,this.tempLocation),yield this.record())}))}prevChapter(){return u(this,void 0,void 0,(function*(){this.trigger("page-changed");let e=document.getElementById("page-area");if(!e)return;let t=e.getElementsByTagName("iframe")[0];t&&t.contentDocument&&(yield Ge(this.element,this.flatChapter(this.chapterList),this.chapterDocList,this.mode,this.format,this.tempLocation),yield this.record(),this.trigger("rendered"))}))}nextChapter(){return u(this,void 0,void 0,(function*(){this.trigger("page-changed");let e=document.getElementById("page-area");if(!e)return;let t=e.getElementsByTagName("iframe")[0];t&&t.contentDocument&&(yield nt(this.element,this.flatChapter(this.chapterList),this.chapterDocList,this.mode,this.format,this.tempLocation),yield this.record(),this.trigger("rendered"))}))}visibleText(){return it(this.element,this.mode)}audioText(){return((e,t)=>{let r=document.getElementById("page-area");if(!r)return;let n=r.getElementsByTagName("iframe")[0];if(!n)return;let i=n.contentDocument;if(!i)return;let o=qe(i.body).filter((e=>!ot(e))).filter((e=>(e.textContent||"").trim())).filter((e=>"img"!==e.textContent)).map((e=>e.textContent)),s=0;if(it(e,t)&&it(e,t).length>0){let r=it(e,t)[0];s=o.indexOf(r)}return o.slice(s)})(this.element,this.mode)}highlightNode(e,t){((e,t,r,n)=>{let i=document.getElementById("page-area");if(!i)return;let o=i.getElementsByTagName("iframe")[0];if(!o)return;let s=o.contentDocument;if(!s)return;let a=qe(s.body).filter((e=>(e.getAttribute("style")===n&&e.setAttribute("style",""),(e.textContent||"").trim()&&e.textContent===r)));a.length>0&&a[0].setAttribute("style",n)})(this.element,this.mode,e,t)}doSearch(e){return u(this,void 0,void 0,(function*(){return yield((e,r)=>u(void 0,void 0,void 0,(function*(){var n;let i=[];for(let t=0;t<r.length;t++){let o=(new DOMParser).parseFromString(yield p(r[t].text),"text/html"),s=qe(o.body).filter((e=>!ot(e)));for(let o=0;o<s.length;o++){let a=(s[o].textContent||"").indexOf(e);a>-1&&i.push({excerpt:(null===(n=s[o].textContent)||void 0===n?void 0:n.substring(a-100,a+100))||"",cfi:JSON.stringify({text:s[o].textContent,chapterTitle:r[t].label,chapterDocIndex:t,chapterHref:r[t].href,count:"search",percentage:t/r.length})})}}for(let e=0;e<r.length;e++)r[e].text&&r[e].text.unload&&r[e].text.unload();return t.uniq(i,"excerpt")})))(e,this.chapterDocList)}))}getProgress(){return u(this,void 0,void 0,(function*(){return yield w(this.mode)}))}record(){return u(this,void 0,void 0,(function*(){var e,t,r,n;"sliding"===this.animation&&(yield new Promise((e=>setTimeout(e,1e3)))),yield(e=this.element,t=this.mode,r=this.flatChapter(this.chapterList),n=this.tempLocation,u(void 0,void 0,void 0,(function*(){var i;if(We)return;let o=document.getElementById("page-area");if(!o)return;let s=o.getElementsByTagName("iframe")[0];if(!s)return;let a=s.contentDocument;if(!a)return;let l=qe(a.body),c=l.filter((r=>st(e,r,t)&&(r.textContent||"").trim())),h=c[0],d=0;for(let r=0;r<l.length;r++)if(st(e,l[r],t)&&h&&l[r].innerHTML===h.innerHTML){d=r;break}rt(c,r,n),h&&!tt(h,e,t)?(n.text=h&&h.textContent?h.textContent:"",n.count=d+"",n.page=""):n.page=(null===(i=yield w(t))||void 0===i?void 0:i.currentPage)+"",We=!0,setTimeout((()=>{We=!1}),100)})))}))}getPosition(){return this.tempLocation}setStyle(e){let t=document.getElementById("page-area");if(!t)return;let r=t.getElementsByTagName("iframe")[0];if(!r)return;let n=r.contentDocument;n&&n.body.setAttribute("style",e+n.body.getAttribute("style"))}getHightlightCoords(e){return u(this,void 0,void 0,(function*(){let e=document.getElementById("page-area");if(!e)return;let t=e.getElementsByTagName("iframe")[0];if(!t)return;let r=t.contentDocument;return r?window.rangy.getSelection(t).saveCharacterRanges(r.body)[0]:void 0}))}renderHighlighters(e,t){return u(this,void 0,void 0,(function*(){Lt();for(let r=0;r<e.length;r++){const n=e[r];try{xt(JSON.parse(n.range),n.color,n.key,t)}catch(e){return void console.warn(e,"Exception has been caught when restore character ranges.")}}}))}removeOneNote(e,t){let r=document.getElementById("page-area");if(!r)return;let n=r.getElementsByTagName("iframe")[0];if(!n||!n.contentWindow)return;let i=n.contentDocument;if(!i)return;const o=i.querySelectorAll(".kookit-note");for(let t=0;t<o.length;t++){const r=o[t];r.getAttribute("data-key")===e&&r.parentNode.removeChild(r)}}createOneNote(e,t){return u(this,void 0,void 0,(function*(){xt(JSON.parse(e.range),e.color,e.key,t)}))}}class Bt extends Et{constructor(e,t,r){super(t,"EPUB",r),this.epubBuffer=e,this.mode=t,this.chapterList=[],this.chapterDocList=[],this.book="",this.element=""}renderTo(e){return new Promise(((t,r)=>u(this,void 0,void 0,(function*(){this.element=e,this.book||(yield this.parse());let r=new S(this.book);this.chapterList=yield r.getChapter(this.book.toc),this.chapterDocList=yield r.getChapterDoc(),b(e),L(e,this.mode),t()}))))}parse(){return u(this,void 0,void 0,(function*(){let e=new Blob([this.epubBuffer]),t=new File([e],"book",{lastModified:(new Date).getTime(),type:e.type});try{const e=yield this.makeZipLoader(t);this.book=yield new Te(e).init()}catch(e){throw console.log(e),e}}))}preCache(){return u(this,void 0,void 0,(function*(){return this.book||(yield this.parse()),yield this.getCache(this.book)}))}makeZipLoader(e){return u(this,void 0,void 0,(function*(){let t;try{t=new n(new i(e))}catch(e){throw e}const r=yield t.getEntries(),a=new Map(r.map((e=>[e.filename,e]))),l=e=>(t,...r)=>a.has(t)?e(a.get(t),...r):null;return{entries:r,loadText:l((e=>e.getData(new o))),loadBlob:l(((e,t)=>new Promise(((r,n)=>{e.getData(new s(t)).then((e=>{r(e)})).catch((e=>{r(new Blob)}))})))),getSize:e=>{var t,r;return null!==(r=null===(t=a.get(e))||void 0===t?void 0:t.uncompressedSize)&&void 0!==r?r:0}}}))}getMetadata(){return u(this,void 0,void 0,(function*(){try{this.book||(yield this.parse());let e=new S(this.book);return yield e.getMetadata()}catch(e){throw console.log(e),e}}))}}const It=e=>{if(!e)return"";const t=document.createElement("textarea");return t.innerHTML=e,t.value},At={XML:"application/xml",XHTML:"application/xhtml+xml",HTML:"text/html",CSS:"text/css",SVG:"image/svg+xml"},Ot={name:[0,32,"string"],type:[60,4,"string"],creator:[64,4,"string"],numRecords:[76,2,"uint"]},Mt={compression:[0,2,"uint"],numTextRecords:[8,2,"uint"],recordSize:[10,2,"uint"],encryption:[12,2,"uint"]},Dt={magic:[16,4,"string"],length:[20,4,"uint"],type:[24,4,"uint"],encoding:[28,4,"uint"],uid:[32,4,"uint"],version:[36,4,"uint"],titleOffset:[84,4,"uint"],titleLength:[88,4,"uint"],localeRegion:[94,1,"uint"],localeLanguage:[95,1,"uint"],resourceStart:[108,4,"uint"],huffcdic:[112,4,"uint"],numHuffcdic:[116,4,"uint"],exthFlag:[128,4,"uint"],trailingFlags:[240,4,"uint"],indx:[244,4,"uint"]},Nt={resourceStart:[108,4,"uint"],fdst:[192,4,"uint"],numFdst:[196,4,"uint"],frag:[248,4,"uint"],skel:[252,4,"uint"],guide:[260,4,"uint"]},Rt={magic:[0,4,"string"],length:[4,4,"uint"],count:[8,4,"uint"]},Ft={magic:[0,4,"string"],length:[4,4,"uint"],type:[8,4,"uint"],idxt:[20,4,"uint"],numRecords:[24,4,"uint"],encoding:[28,4,"uint"],language:[32,4,"uint"],total:[36,4,"uint"],ordt:[40,4,"uint"],ligt:[44,4,"uint"],numLigt:[48,4,"uint"],numCncx:[52,4,"uint"]},_t={magic:[0,4,"string"],length:[4,4,"uint"],numControlBytes:[8,4,"uint"]},Pt={magic:[0,4,"string"],offset1:[8,4,"uint"],offset2:[12,4,"uint"]},Ht={magic:[0,4,"string"],length:[4,4,"uint"],numEntries:[8,4,"uint"],codeLength:[12,4,"uint"]},Ut={magic:[0,4,"string"],numEntries:[8,4,"uint"]},jt={flags:[8,4,"uint"],dataStart:[12,4,"uint"],keyLength:[16,4,"uint"],keyStart:[20,4,"uint"]},$t={1252:"windows-1252",65001:"utf-8"},zt={100:["creator","string",!0],101:["publisher"],103:["description"],104:["isbn"],105:["subject","string",!0],106:["date"],108:["contributor","string",!0],109:["rights"],110:["subjectCode","string",!0],112:["source","string",!0],113:["asin"],121:["boundary","uint"],122:["fixedLayout"],125:["numResources","uint"],126:["originalResolution"],127:["zeroGutter"],128:["zeroMargin"],129:["coverURI"],132:["regionMagnification"],201:["coverOffset","uint"],202:["thumbnailOffset","uint"],503:["title"],524:["language","string",!0],527:["pageProgressionDirection"]},Wt={1:["ar","ar-SA","ar-IQ","ar-EG","ar-LY","ar-DZ","ar-MA","ar-TN","ar-OM","ar-YE","ar-SY","ar-JO","ar-LB","ar-KW","ar-AE","ar-BH","ar-QA"],2:["bg"],3:["ca"],4:["zh","zh-TW","zh-CN","zh-HK","zh-SG"],5:["cs"],6:["da"],7:["de","de-DE","de-CH","de-AT","de-LU","de-LI"],8:["el"],9:["en","en-US","en-GB","en-AU","en-CA","en-NZ","en-IE","en-ZA","en-JM",null,"en-BZ","en-TT","en-ZW","en-PH"],10:["es","es-ES","es-MX",null,"es-GT","es-CR","es-PA","es-DO","es-VE","es-CO","es-PE","es-AR","es-EC","es-CL","es-UY","es-PY","es-BO","es-SV","es-HN","es-NI","es-PR"],11:["fi"],12:["fr","fr-FR","fr-BE","fr-CA","fr-CH","fr-LU","fr-MC"],13:["he"],14:["hu"],15:["is"],16:["it","it-IT","it-CH"],17:["ja"],18:["ko"],19:["nl","nl-NL","nl-BE"],20:["no","nb","nn"],21:["pl"],22:["pt","pt-BR","pt-PT"],23:["rm"],24:["ro"],25:["ru"],26:["hr",null,"sr"],27:["sk"],28:["sq"],29:["sv","sv-SE","sv-FI"],30:["th"],31:["tr"],32:["ur"],33:["id"],34:["uk"],35:["be"],36:["sl"],37:["et"],38:["lv"],39:["lt"],41:["fa"],42:["vi"],43:["hy"],44:["az"],45:["eu"],46:["hsb"],47:["mk"],48:["st"],49:["ts"],50:["tn"],52:["xh"],53:["zu"],54:["af"],55:["ka"],56:["fo"],57:["hi"],58:["mt"],59:["se"],62:["ms"],63:["kk"],65:["sw"],67:["uz",null,"uz-UZ"],68:["tt"],69:["bn"],70:["pa"],71:["gu"],72:["or"],73:["ta"],74:["te"],75:["kn"],76:["ml"],77:["as"],78:["mr"],79:["sa"],82:["cy","cy-GB"],83:["gl","gl-ES"],87:["kok"],97:["ne"],98:["fy"]},qt=(e,t)=>{const r=new e.constructor(e.length+t.length);return r.set(e),r.set(t,e.length),r},Xt=(e,t,r)=>{const n=new e.constructor(e.length+t.length+r.length);return n.set(e),n.set(t,e.length),n.set(r,e.length+t.length),n},Vt=new TextDecoder,Gt=e=>Vt.decode(e),Jt=e=>{if(!e)return;const t=e.byteLength,r=4===t?"getUint32":2===t?"getUint16":"getUint8";return new DataView(e)[r](0)},Kt=(e,t)=>Object.fromEntries(Array.from(Object.entries(e)).map((([e,[r,n,i]])=>[e,("string"===i?Gt:Jt)(t.slice(r,r+n))]))),Zt=e=>new TextDecoder($t[e]),Yt=(e,t=0)=>{let r=0,n=0;for(const i of e.subarray(t,t+4))if(r=r<<7|(127&i)>>>0,n++,128&i)break;return{value:r,length:n}},Qt=e=>{let t=0;for(const r of e.subarray(-4))128&r&&(t=0),t=t<<7|127&r;return t},er=e=>{let t=0;for(;e>0;e>>=1)1&~e||t++;return t},tr=e=>{let t=0;for(;!(1&e);)e>>=1,t++;return t},rr=e=>{let t=[];for(let r=0;r<e.length;r++){const n=e[r];if(0===n)t.push(0);else if(n<=8)for(const i of e.subarray(r+1,(r+=n)+1))t.push(i);else if(n<=127)t.push(n);else if(n<=191){const i=n<<8|e[1+r++],o=(16383&i)>>>3,s=3+(7&i);for(let e=0;e<s;e++)t.push(t[t.length-o])}else t.push(32,128^n)}return Uint8Array.from(t)},nr=(e,t)=>{const r=t+32,n=r>>3;let i=0n;for(let r=t>>3;r<=n;r++)i=i<<8n|BigInt(e[r]??0);return i>>8n-BigInt(7&r)&0xffffffffn},ir=async(e,t)=>{const r=await t(e),n=Kt(Ft,r);if("INDX"!==n.magic)throw new Error("Invalid INDX record");const i=Zt(n.encoding),o=r.slice(n.length),s=Kt(_t,o);if("TAGX"!==s.magic)throw new Error("Invalid TAGX section");const a=(s.length-12)/4,l=Array.from({length:a},((e,t)=>new Uint8Array(o.slice(12+4*t,12+4*t+4)))),c={};let h=0;for(let r=0;r<n.numCncx;r++){const o=await t(e+n.numRecords+r+1),s=new Uint8Array(o);for(let e=0;e<s.byteLength;){const t=e,{value:r,length:n}=Yt(s,e);e+=n;const a=o.slice(e,e+r);e+=r,c[h+t]=i.decode(a)}h+=65536}const d=[];for(let r=0;r<n.numRecords;r++){const n=await t(e+1+r),i=new Uint8Array(n),o=Kt(Ft,n);if("INDX"!==o.magic)throw new Error("Invalid INDX record");for(let e=0;e<o.numRecords;e++){const t=o.idxt+4+2*e,r=Jt(n.slice(t,t+2)),a=Jt(n.slice(r,r+1)),c=Gt(n.slice(r+1,r+1+a)),h=[],u=r+1+a;let f=0,p=u+s.numControlBytes;for(const[e,t,r,o]of l){if(1&o){f++;continue}const s=u+f,a=Jt(n.slice(s,s+1))&r;if(a===r)if(er(r)>1){const{value:r,length:n}=Yt(i,p);h.push([e,null,r,t]),p+=n}else h.push([e,1,null,t]);else h.push([e,a>>tr(r),null,t])}const g={};for(const[e,t,r,n]of h){const o=[];if(null!=t)for(let e=0;e<t*n;e++){const{value:e,length:t}=Yt(i,p);o.push(e),p+=t}else{let e=0;for(;e<r;){const{value:t,length:r}=Yt(i,p);o.push(t),p+=r,e+=r}}g[e]=o}d.push({name:c,tagMap:g})}}return{table:d,cncx:c}};class or{#c;#h;pdb;async open(e){this.#c=e;const t=Kt(Ot,await e.slice(0,78).arrayBuffer());this.pdb=t;const r=await e.slice(78,78+8*t.numRecords).arrayBuffer();this.#h=Array.from({length:t.numRecords},((e,t)=>Jt(r.slice(8*t,8*t+4)))).map(((e,t,r)=>[e,r[t+1]]))}loadRecord(e){const t=this.#h[e];if(!t)throw new RangeError("Record index out of bounds");return this.#c.slice(...t).arrayBuffer()}async loadMagic(e){const t=this.#h[e][0];return Gt(await this.#c.slice(t,t+4).arrayBuffer())}}class sr extends or{#d=0;#u;#f;#p;#g;#m;constructor({unzlib:e}){super(),this.unzlib=e}async open(e){await super.open(e),this.headers=this.#y(await super.loadRecord(0)),this.#u=this.headers.mobi.resourceStart;let t=this.headers.mobi.version>=8;if(!t){const e=this.headers.exth?.boundary;if(e<4294967295)try{this.headers=this.#y(await super.loadRecord(e)),this.#d=e,t=!0}catch(e){console.warn(e),console.warn("Failed to open KF8; falling back to MOBI")}}return await this.#b(),t?new mr(this).init():new cr(this).init()}#y(e){const t=Kt(Mt,e),r=Kt(Dt,e);if("MOBI"!==r.magic)throw new Error("Missing MOBI header");const{titleOffset:n,titleLength:i,localeLanguage:o,localeRegion:s}=r;r.title=e.slice(n,n+i);const a=Wt[o];r.language=a?.[s>>2]??a?.[0];const l=64&r.exthFlag?((e,t)=>{const{magic:r,count:n}=Kt(Rt,e);if("EXTH"!==r)throw new Error("Invalid EXTH header");const i=Zt(t),o={};let s=12;for(let t=0;t<n;t++){const t=Jt(e.slice(s,s+4)),r=Jt(e.slice(s+4,s+8));if(t in zt){const[n,a,l]=zt[t],c=e.slice(s+8,s+r),h="uint"===a?Jt(c):i.decode(c);l?(o[n]??=[],o[n].push(h)):o[n]=h}s+=r}return o})(e.slice(r.length+16),r.encoding):null;return{palmdoc:t,mobi:r,exth:l,kf8:r.version>=8?Kt(Nt,e):null}}async#b(){const{palmdoc:e,mobi:t}=this.headers;this.#f=Zt(t.encoding),this.#p=new TextEncoder;const{compression:r}=e;if(this.#g=1===r?e=>e:2===r?rr:17480===r?await(async(e,t)=>{const r=await t(e.huffcdic),{magic:n,offset1:i,offset2:o}=Kt(Pt,r);if("HUFF"!==n)throw new Error("Invalid HUFF record");const s=Array.from({length:256},((e,t)=>i+4*t)).map((e=>Jt(r.slice(e,e+4)))).map((e=>[128&e,31&e,e>>>8])),a=[null].concat(Array.from({length:32},((e,t)=>o+8*t)).map((e=>[Jt(r.slice(e,e+4)),Jt(r.slice(e+4,e+8))]))),l=[];for(let r=1;r<e.numHuffcdic;r++){const n=await t(e.huffcdic+r),i=Kt(Ht,n);if("CDIC"!==i.magic)throw new Error("Invalid CDIC record");const o=Math.min(1<<i.codeLength,i.numEntries-l.length),s=n.slice(i.length);for(let e=0;e<o;e++){const t=Jt(s.slice(2*e,2*e+2)),r=Jt(s.slice(t,t+2)),n=32767&r,i=32768&r,o=new Uint8Array(s.slice(t+2,t+2+n));l.push([o,i])}}const c=e=>{let t=new Uint8Array;const r=8*e.byteLength;for(let n=0;n<r;){const i=Number(nr(e,n));let[o,h,d]=s[i>>>24];if(!o){for(;i>>>32-h<a[h][0];)h+=1;d=a[h][1]}if((n+=h)>r)break;const u=d-(i>>>32-h);let[f,p]=l[u];p||(f=c(f),l[u]=[f,!0]),t=qt(t,f)}return t};return c})(t,this.loadRecord.bind(this)):null,!this.#g)throw new Error("Unknown compression type");const{trailingFlags:n}=t,i=1&n,o=er(n>>>1);this.#m=e=>{for(let t=0;t<o;t++){const t=Qt(e);e=e.subarray(0,-t)}if(i){const t=1+(3&e[e.length-1]);e=e.subarray(0,-t)}return e}}decode(...e){return this.#f.decode(...e)}encode(...e){return this.#p.encode(...e)}loadRecord(e){return super.loadRecord(this.#d+e)}loadMagic(e){return super.loadMagic(this.#d+e)}loadText(e){return this.loadRecord(e+1).then((e=>new Uint8Array(e))).then(this.#m).then(this.#g)}async loadResource(e){const t=await super.loadRecord(this.#u+e),r=Gt(t.slice(0,4));return"FONT"===r?(async(e,t)=>{const{flags:r,dataStart:n,keyLength:i,keyStart:o}=Kt(jt,e),s=new Uint8Array(e.slice(n));if(2&r){const t=16===i?1024:1040,r=new Uint8Array(e.slice(o,o+i)),n=Math.min(t,s.length);for(var a=0;a<n;a++)s[a]=s[a]^r[a%r.length]}if(1&r)try{return await t(s)}catch(e){console.warn(e),console.warn("Failed to decompress font")}return s})(t,this.unzlib):"VIDE"===r||"AUDI"===r?t.slice(12):t}getNCX(){const e=this.headers.mobi.indx;if(e<4294967295)return(async(e,t)=>{const{table:r,cncx:n}=await ir(e,t),i=r.map((({tagMap:e},t)=>({index:t,offset:e[1]?.[0],size:e[2]?.[0],label:n[e[3]]??"",headingLevel:e[4]?.[0],pos:e[6],parent:e[21]?.[0],firstChild:e[22]?.[0],lastChild:e[23]?.[0]}))),o=e=>(null==e.firstChild||(e.children=i.filter((t=>t.parent===e.index)).map(o)),e);return i.filter((e=>0===e.headingLevel)).map(o)})(e,this.loadRecord.bind(this))}getMetadata(){const{mobi:e,exth:t}=this.headers;return{identifier:e.uid.toString(),title:It(t?.title||this.decode(e.title)),author:t?.creator?.map(It),publisher:It(t?.publisher),language:t?.language??e.language,published:t?.date,description:It(t?.description),subject:t?.subject?.map(It),rights:It(t?.rights)}}async getCover(){const{exth:e}=this.headers,t=e?.coverOffset<4294967295?e?.coverOffset:e?.thumbnailOffset<4294967295?e?.thumbnailOffset:null;if(null!=t){const e=await this.loadResource(t);return new Blob([e])}}}const ar=/<\s*(?:mbp:)?pagebreak[^>]*>/gi,lr=/<[^<>]+filepos=['"]{0,1}(\d+)[^<>]*>/gi;class cr{parser=new DOMParser;serializer=new XMLSerializer;#w=new Map;#v=new Map;#n=new Map;#x;#C=[];#L=At.HTML;constructor(e){this.mobi=e}async init(){let e=new Uint8Array;for(let t=0;t<this.mobi.headers.palmdoc.numTextRecords;t++)e=qt(e,await this.mobi.loadText(t));const t=Array.from(new Uint8Array(e),(e=>String.fromCharCode(e))).join("");this.#x=[0].concat(Array.from(t.matchAll(ar),(e=>e.index))).map(((e,r,n)=>t.slice(e,n[r+1]))).map((e=>Uint8Array.from(e,(e=>e.charCodeAt(0))))).map((e=>({book:this,raw:e}))).reduce(((e,t)=>{const r=e[e.length-1];return t.start=r?.end??0,t.end=t.start+t.raw.byteLength,e.concat(t)}),[]),this.sections=this.#x.map(((e,t)=>({id:t,load:()=>this.loadSection(e),createDocument:()=>this.createDocument(e),size:e.end-e.start})));try{this.landmarks=await this.getGuide();const e=this.landmarks.find((({type:e})=>e?.includes("toc")))?.href;if(e){const{index:t}=this.resolveHref(e),r=await this.sections[t].createDocument();let n,i=0,o=0;const s=new Map,a=new Map;this.toc=Array.from(r.querySelectorAll("a[filepos]")).reduce(((e,t)=>{const r=(e=>{let t=0;for(;e;){const r=e.parentElement;if(r){const e=r.tagName.toLowerCase();"p"===e?t+=1.5:"blockquote"===e&&(t+=2)}e=r}return t})(t),l={label:t.innerText?.trim(),href:`filepos:${t.getAttribute("filepos")}`},c=r>o?i+1:r===o?i:s.get(r)??Math.max(0,i-1);if(c>i)n?(n.subitems??=[],n.subitems.push(l),a.set(c,n)):e.push(l);else{const t=a.get(c);t?t.subitems.push(l):e.push(l)}return n=l,i=c,o=r,s.set(r,c),e}),[])}}catch(e){console.warn(e)}return this.#C=[...new Set(Array.from(t.matchAll(lr),(e=>e[1])))].map((e=>({filepos:e,number:Number(e)}))).sort(((e,t)=>e.number-t.number)),this.metadata=this.mobi.getMetadata(),this.getCover=this.mobi.getCover.bind(this.mobi),this}async getGuide(){const e=await this.createDocument(this.#x[0]);return Array.from(e.getElementsByTagName("reference"),(e=>({label:e.getAttribute("title"),type:e.getAttribute("type")?.split(/\s/),href:`filepos:${e.getAttribute("filepos")}`})))}async loadResource(e){if(this.#w.has(e))return this.#w.get(e);const t=await this.mobi.loadResource(e),r=URL.createObjectURL(new Blob([t]));return this.#w.set(e,r),r}async loadRecindex(e){return this.loadResource(Number(e)-1)}async replaceResources(e){for(const t of e.querySelectorAll("img[recindex]")){const e=t.getAttribute("recindex");try{t.src=await this.loadRecindex(e)}catch(t){console.warn(`Failed to load image ${e}`)}}for(const t of e.querySelectorAll("[mediarecindex]")){const e=t.getAttribute("mediarecindex"),r=t.getAttribute("recindex");try{t.src=await this.loadRecindex(e),r&&(t.poster=await this.loadRecindex(r))}catch(t){console.warn(`Failed to load media ${e}`)}}for(const t of e.querySelectorAll("[filepos]")){const e=t.getAttribute("filepos");t.href=`filepos:${e}`}}async loadText(e){if(this.#v.has(e))return this.#v.get(e);const{raw:t}=e,r=this.#C.filter((({number:t})=>t>=e.start&&t<e.end)).map((t=>({...t,offset:t.number-e.start})));let n=t;r.length&&(n=t.subarray(0,r[0].offset),r.forEach((({filepos:e,offset:i},o)=>{const s=r[o+1],a=this.mobi.encode(`<a id="filepos${e}"></a>`);n=Xt(n,a,t.subarray(i,s?.offset))})));const i=this.mobi.decode(n).replaceAll(ar,"");return this.#v.set(e,i),i}async createDocument(e){const t=await this.loadText(e);return this.parser.parseFromString(t,this.#L)}async loadSection(e){if(this.#n.has(e))return this.#n.get(e);const t=await this.createDocument(e),r=t.createElement("style");t.head.append(r),r.append(t.createTextNode("blockquote {\n            margin-block-start: 0;\n            margin-block-end: 0;\n            margin-inline-start: 1em;\n            margin-inline-end: 0;\n        }")),await this.replaceResources(t);const n=this.serializer.serializeToString(t),i=URL.createObjectURL(new Blob([n],{type:this.#L}));return this.#n.set(e,i),i}resolveHref(e){const t=e.match(/filepos:(.*)/)[1],r=Number(t);return{index:this.#x.findIndex((e=>e.end>r)),anchor:e=>e.getElementById(`filepos${t}`)}}splitTOCHref(e){const t=e.match(/filepos:(.*)/)[1],r=Number(t);return[this.#x.findIndex((e=>e.end>r)),`filepos${t}`]}getTOCFragment(e,t){return e.getElementById(t)}isExternal(e){return/^(?!blob|filepos)\w+:/i.test(e)}destroy(){for(const e of this.#w.values())URL.revokeObjectURL(e);for(const e of this.#n.values())URL.revokeObjectURL(e)}}const hr=/kindle:(flow|embed):(\w+)(?:\?mime=(\w+\/[-+.\w]+))?/,dr=/kindle:pos:fid:(\w+):off:(\w+)/,ur=e=>{const[t,r]=e.match(dr).slice(1);return{fid:parseInt(t,32),off:parseInt(r,32)}},fr=(e=0,t=0)=>`kindle:pos:fid:${e.toString(32).toUpperCase().padStart(4,"0")}:off:${t.toString(32).toUpperCase().padStart(10,"0")}`,pr=e=>{const t=e.match(/\s(id|name|aid)\s*=\s*['"]([^'"]*)['"]/i);if(!t)return;const[,r,n]=t;return`[${r}="${CSS.escape(n)}"]`},gr=e=>{for(const t of e){if("page-spread-left"===t||"rendition:page-spread-left"===t)return"left";if("page-spread-right"===t||"rendition:page-spread-right"===t)return"right";if("rendition:page-spread-center"===t)return"center"}};class mr{parser=new DOMParser;serializer=new XMLSerializer;#n=new Map;#S=new Map;#T=new Map;#k={};#x;#E;#B=new Uint8Array;#I=new Uint8Array;#A=-1;#O=-1;#L=At.XHTML;#M=new Map;constructor(e){this.mobi=e}async init(){const e=this.mobi.loadRecord.bind(this.mobi),{kf8:t}=this.mobi.headers;try{const r=await e(t.fdst),n=Kt(Ut,r);if("FDST"!==n.magic)throw new Error("Missing FDST record");const i=Array.from({length:n.numEntries},((e,t)=>12+8*t)).map((e=>[Jt(r.slice(e,e+4)),Jt(r.slice(e+4,e+8))]));this.#k.fdstTable=i,this.#E=i[i.length-1][1]}catch{}const r=(await ir(t.skel,e)).table.map((({name:e,tagMap:t},r)=>({index:r,name:e,numFrag:t[1][0],offset:t[6][0],length:t[6][1]}))),n=await ir(t.frag,e),i=n.table.map((({name:e,tagMap:t})=>({insertOffset:parseInt(e),selector:n.cncx[t[2][0]],index:t[4][0],offset:t[6][0],length:t[6][1]})));this.#k.skelTable=r,this.#k.fragTable=i,this.#x=r.reduce(((e,t)=>{const r=e[e.length-1],n=r?.fragEnd??0,o=n+t.numFrag,s=i.slice(n,o),a=t.length+s.map((e=>e.length)).reduce(((e,t)=>e+t)),l=(r?.totalLength??0)+a;return e.concat({skel:t,frags:s,fragEnd:o,length:a,totalLength:l})}),[]);const o=await this.getResourcesByMagic(["RESC","PAGE"]),s=new Map;if(o.RESC){const e=await this.mobi.loadRecord(o.RESC),t=this.mobi.decode(e.slice(16)).replace(/\0/g,""),r=t.search(/\?>/),n=`<package>${t.slice(r)}</package>`,i=this.parser.parseFromString(n,At.XML);for(const e of i.querySelectorAll("spine > itemref")){const t=parseInt(e.getAttribute("skelid"));s.set(t,gr(e.getAttribute("properties")?.split(" ")??[]))}}this.sections=this.#x.map(((e,t)=>e.frags.length?{id:t,load:()=>this.loadSection(e),createDocument:()=>this.createDocument(e),size:e.length,pageSpread:s.get(t)}:{linear:"no"}));try{const e=await this.mobi.getNCX(),t=({label:e,pos:r,children:n})=>{const[i,o]=r,s=fr(i,o),a=this.#S.get(i);return a?a.push(o):this.#S.set(i,[o]),{label:It(e),href:s,subitems:n?.map(t)}};this.toc=e?.map(t),this.landmarks=await this.getGuide()}catch(e){console.warn(e)}const{exth:a}=this.mobi.headers;return this.dir=a.pageProgressionDirection,this.rendition={layout:"true"===a.fixedLayout?"pre-paginated":"reflowable",viewport:Object.fromEntries(a.originalResolution?.split("x")?.slice(0,2)?.map(((e,t)=>[t?"height":"width",e]))??[])},this.metadata=this.mobi.getMetadata(),this.getCover=this.mobi.getCover.bind(this.mobi),this}async getResourcesByMagic(e){const t={},r=this.mobi.headers.kf8.resourceStart,n=this.mobi.pdb.numRecords;for(let i=r;i<n;i++)try{const r=await this.mobi.loadMagic(i),n=e.find((e=>e===r));n&&(t[n]=i)}catch{}return t}async getGuide(){const e=this.mobi.headers.kf8.guide;if(e<4294967295){const t=this.mobi.loadRecord.bind(this.mobi),{table:r,cncx:n}=await ir(e,t);return r.map((({name:e,tagMap:t})=>({label:n[t[1][0]]??"",type:e?.split(/\s/),href:fr(t[6]?.[0]??t[3]?.[0])})))}}async loadResourceBlob(e){const{resourceType:t,id:r,type:n}=(e=>{const[t,r,n]=e.match(hr).slice(1);return{resourceType:t,id:parseInt(r,32),type:n}})(e),i="flow"===t?await this.loadFlow(r):await this.mobi.loadResource(r-1),o=[At.XHTML,At.HTML,At.CSS,At.SVG].includes(n)?await this.replaceResources(this.mobi.decode(i)):i,s=n===At.SVG?this.parser.parseFromString(o,n):null;return[new Blob([o],{type:n}),s?.getElementsByTagNameNS("http://www.w3.org/2000/svg","image")?.length?s.documentElement:null]}async loadResource(e){if(this.#n.has(e))return this.#n.get(e);const[t,r]=await this.loadResourceBlob(e),n=r?e:URL.createObjectURL(t);return r&&this.#M.set(n,r),this.#n.set(e,n),n}replaceResources(e){return(async(e,t,r)=>{const n=[];e.replace(t,((...e)=>(n.push(e),null)));const i=[];for(const e of n)i.push(await r(...e));return e.replace(t,(()=>i.shift()))})(e,new RegExp(hr,"g"),this.loadResource.bind(this))}async loadRaw(e,t){const r=t-this.#B.length,n=null==this.#E?1/0:this.#E-this.#I.length-e;if(r<0||r<n){for(;this.#B.length<t;){const e=++this.#A,t=await this.mobi.loadText(e);this.#B=qt(this.#B,t)}return this.#B.slice(e,t)}for(;this.#E-this.#I.length>e;){const e=this.mobi.headers.palmdoc.numTextRecords-1-++this.#O,t=await this.mobi.loadText(e);this.#I=qt(t,this.#I)}const i=this.#E-this.#I.length;return this.#I.slice(e-i,t-i)}loadFlow(e){if(e<4294967295)return this.loadRaw(...this.#k.fdstTable[e])}async loadText(e){const{skel:t,frags:r,length:n}=e,i=await this.loadRaw(t.offset,t.offset+n);let o=i.slice(0,t.length);for(const e of r){const r=e.insertOffset-t.offset,n=t.length+e.offset,s=i.slice(n,n+e.length);o=Xt(o.slice(0,r),s,o.slice(r));const a=this.#S.get(e.index);if(a)for(const t of a){const r=this.mobi.decode(s).slice(t),n=pr(r);this.#D(e.index,t,n)}}return this.mobi.decode(o)}async createDocument(e){const t=await this.loadText(e);return this.parser.parseFromString(t,this.#L)}async loadSection(e){if(this.#n.has(e))return this.#n.get(e);const t=await this.loadText(e),r=await this.replaceResources(t);let n=this.parser.parseFromString(r,this.#L);n.querySelector("parsererror")&&(this.#L=At.HTML,n=this.parser.parseFromString(r,this.#L));for(const[e,t]of this.#M)for(const r of n.querySelectorAll(`img[src="${e}"]`))r.replaceWith(t);const i=URL.createObjectURL(new Blob([this.serializer.serializeToString(n)],{type:this.#L}));return this.#n.set(e,i),i}getIndexByFID(e){return this.#x.findIndex((t=>t.frags.some((t=>t.index===e))))}#D(e,t,r){const n=this.#T.get(e);if(n)n.set(t,r);else{const n=new Map;this.#T.set(e,n),n.set(t,r)}}async resolveHref(e){const{fid:t,off:r}=ur(e),n=this.getIndexByFID(t);if(n<0)return;const i=this.#T.get(t)?.get(r);if(i)return{index:n,anchor:e=>e.querySelector(i)};const{skel:o,frags:s}=this.#x[n],a=s.find((e=>e.index===t)),l=o.offset+o.length+a.offset,c=await this.loadRaw(l,l+a.length),h=this.mobi.decode(c).slice(r),d=pr(h);this.#D(t,r,d);return{index:n,anchor:e=>e.querySelector(d)}}splitTOCHref(e){const t=ur(e);return[this.getIndexByFID(t.fid),t]}getTOCFragment(e,{fid:t,off:r}){const n=this.#T.get(t)?.get(r);return e.querySelector(n)}isExternal(e){return/^(?!blob|kindle)\w+:/i.test(e)}destroy(){for(const e of this.#n.values())URL.revokeObjectURL(e)}}class yr extends Et{constructor(e,t,r){super(t,"MOBI",r),this.mobiBuffer=e,this.mode=t,this.chapterList=[],this.chapterDocList=[],this.book="",this.element=""}renderTo(e){return new Promise(((t,r)=>u(this,void 0,void 0,(function*(){this.element=e,this.book||(yield this.parse());let r=new S(this.book);this.chapterList=yield r.getChapter(this.book.toc),this.chapterDocList=yield r.getChapterDoc(),b(e),L(e,this.mode),t()}))))}parse(){return u(this,void 0,void 0,(function*(){try{let e=new Blob([this.mobiBuffer]),t=new File([e],"book",{lastModified:(new Date).getTime(),type:e.type});(yield(async e=>"BOOKMOBI"===Gt(await e.slice(60,68).arrayBuffer()))(t))&&(this.book=yield new sr({unzlib:a}).open(t))}catch(e){throw console.log(e),e}}))}preCache(){return u(this,void 0,void 0,(function*(){return this.book||(yield this.parse()),yield this.getCache(this.book)}))}getMetadata(){return u(this,void 0,void 0,(function*(){try{this.book||(yield this.parse());let e=new S(this.book);return yield e.getMetadata()}catch(e){throw console.log(e),e}}))}}const br=e=>`./lib/pdfjs/${e}`,wr=window.pdfjsLib,vr=async e=>await(await fetch(e)).text(),xr=async()=>await vr(br("text_layer_builder.css")),Cr=async()=>await vr(br("annotation_layer_builder.css")),Lr=async(e,t)=>{const r=e.getViewport({scale:1});if(t){const t=document.createElement("canvas");t.height=r.height,t.width=r.width;const n=t.getContext("2d");return await e.render({canvasContext:n,viewport:r}).promise,new Promise((e=>t.toBlob(e)))}return URL.createObjectURL(new Blob([`\n        <!DOCTYPE html>\n        <html lang="en">\n        <meta charset="utf-8">\n        <meta name="viewport" content="width=${r.width}, height=${r.height}">\n        <style>\n        html, body {\n            margin: 0;\n            padding: 0;\n        }\n        ${await xr()}\n        ${await Cr()}\n        </style>\n        <div class="noteLayer"></div>\n        <div class="koodoPDFLayer">\n            <div class="textLayer"></div>\n            <div class="annotationLayer"></div>\n            <div id="canvas"></div>\n        </div>\n\n    `],{type:"text/html"}))},Sr=e=>({label:e.title,href:e.dest?JSON.stringify(e.dest):null,subitems:e.items.length?e.items.map(Sr):null}),Tr=async e=>{const t=new wr.PDFDataRangeTransport(e.size,[]);t.requestDataRange=(r,n)=>{e.slice(r,n).arrayBuffer().then((e=>{t.onDataRange(r,e)}))};const r=await wr.getDocument({range:t,cMapUrl:br("cmaps/"),standardFontDataUrl:br("standard_fonts/"),isEvalSupported:!1}).promise,n={rendition:{layout:"pre-paginated"}},{metadata:i,info:o}=await r.getMetadata()??{};n.metadata={title:i?.get("dc:title")??o?.Title,author:i?.get("dc:creator")??o?.Author,contributor:i?.get("dc:contributor"),description:i?.get("dc:description")??o?.Subject,language:i?.get("dc:language"),publisher:i?.get("dc:publisher"),subject:i?.get("dc:subject"),identifier:i?.get("dc:identifier"),source:i?.get("dc:source"),rights:i?.get("dc:rights")};const s=await r.getOutline();n.toc=s?.map(Sr);const a=new Map;return n.sections=Array.from({length:r.numPages}).map(((e,t)=>({id:t,load:async()=>{const e=a.get(t);if(e)return e;const n=await Lr(await r.getPage(t+1));return console.log(n),a.set(t,n),n},unload:async()=>{let e=await r.getPage(t+1);console.log(e),e.cleanup()},render:async(e,n)=>await(async(e,t,r)=>{const n=r*devicePixelRatio;let i=t.querySelector(".koodoPDFLayer");i.style.transform=`scale(${1/devicePixelRatio})`,i.style.transformOrigin="top left",i.style.setProperty("--scale-factor",n);const o=e.getViewport({scale:n}),s=document.createElement("canvas");i.style.width=`${o.width}px`,i.style.height=`${o.height}px`,s.height=o.height,s.width=o.width;const a=s.getContext("2d");await e.render({canvasContext:a,viewport:o}).promise,t.querySelector("#canvas").replaceChildren(t.adoptNode(s)),i.style.overflow="hidden";const l=t.querySelector(".textLayer"),c=new wr.TextLayer({textContentSource:await e.streamTextContent(),container:l,viewport:o});await c.render();for(const e of document.querySelectorAll(".hiddenCanvasElement"))Object.assign(e.style,{position:"absolute",top:"0",left:"0",width:"0",height:"0",display:"none"});const h=document.createElement("div");h.className="endOfContent",l.append(h),l.onpointerdown=()=>l.classList.add("selecting"),l.onpointerup=()=>l.classList.remove("selecting");const d=t.querySelector(".annotationLayer");await new wr.AnnotationLayer({page:e,viewport:o,div:d}).render({annotations:await e.getAnnotations(),linkService:{goToDestination:()=>{},getDestinationHash:e=>JSON.stringify(e),addLinkAttributes:(e,t)=>e.href=t}})})(await r.getPage(t+1),e,n),size:1e3,getDimension:async()=>{let e=(await r.getPage(t+1)).getViewport({scale:1});return{width:e.width,height:e.height}},getPage:async()=>await r.getPage(t+1)}))),n.isExternal=e=>/^\w+:/i.test(e),n.resolveHref=async e=>{const t=JSON.parse(e),n="string"==typeof t?await r.getDestination(t):t;return{index:await r.getPageIndex(n[0])}},n.splitTOCHref=async e=>{const t=JSON.parse(e),n="string"==typeof t?await r.getDestination(t):t;return[await r.getPageIndex(n[0]),null]},n.getTOCFragment=e=>e.documentElement,n.getCover=async()=>Lr(await r.getPage(1),!0),n.destroy=()=>r.destroy(),n};class kr extends Et{constructor(e,t,r){super(t,"PDF",r),this.pdfBuffer=e,this.mode=t,this.chapterList=[],this.chapterDocList=[],this.book="",this.element=""}renderTo(e){return new Promise(((t,r)=>u(this,void 0,void 0,(function*(){this.element=e,this.book||(yield this.parse());let r=new S(this.book);this.chapterList=yield r.getChapter(this.book.toc),this.chapterDocList=yield r.getChapterDoc(),b(e),L(e,this.mode),t()}))))}parse(){return u(this,void 0,void 0,(function*(){try{let e=new Blob([this.pdfBuffer]),t=new File([e],"book",{lastModified:(new Date).getTime(),type:e.type});(yield(async e=>{const t=new Uint8Array(await e.slice(0,5).arrayBuffer());return 37===t[0]&&80===t[1]&&68===t[2]&&70===t[3]&&45===t[4]})(t))&&(this.book=yield Tr(t))}catch(e){throw console.log(e),e}}))}preCache(){return u(this,void 0,void 0,(function*(){return this.book||(yield this.parse()),yield this.getCache(this.book)}))}getMetadata(){return u(this,void 0,void 0,(function*(){try{this.book||(yield this.parse());let e=new S(this.book);return yield e.getMetadata()}catch(e){throw console.log(e),e}}))}getHightlightCoords(e){return u(this,void 0,void 0,(function*(){let t=document.getElementById("page-area");if(!t)return;let r=t.getElementsByTagName("iframe")[0];if(!r||!r.contentWindow)return;let n=r.contentDocument;if(!n)return;var i=n.getSelection().getRangeAt(0).getClientRects();let o=yield this.chapterDocList[e].text.getPage(),s=yield Je(this.element,this.mode,this.chapterDocList,e);var a=o.getViewport({scale:s});let l=n.querySelector("canvas");var c=null==l?void 0:l.getClientRects()[0];let h=[];for(let e=0;e<i.length;e++)0===e?h.push({bottom:i[e].bottom,top:i[e].top,left:i[e].left,right:i[e].right}):Math.abs(h[h.length-1].bottom-i[e].bottom)<5?(h[h.length-1].left>i[e].left&&(h[h.length-1].left=i[e].left),h[h.length-1].right<i[e].right&&(h[h.length-1].right=i[e].right)):h.push({bottom:i[e].bottom,top:i[e].top,left:i[e].left,right:i[e].right});var d=h.map((function(e){return a.convertToPdfPoint(e.left-c.x,e.top-c.y).concat(a.convertToPdfPoint(e.right-c.x,e.bottom-c.y))}));return{page:e,coords:d}}))}renderHighlighters(e,t){var r,n;return u(this,void 0,void 0,(function*(){Lt();for(let o=0;o<e.length;o++){const s=e[o];let a=document.getElementById("page-area");if(!a)return;let l=a.getElementsByTagName("iframe")[0];if(!l||!l.contentWindow)return;let c=l.contentWindow||(null===(r=l.contentDocument)||void 0===r?void 0:r.defaultView),h=JSON.parse(s.range);var i=h.page;let d=yield this.chapterDocList[i].text.getPage(),u=yield Je(this.element,this.mode,this.chapterDocList,i);try{Ct(h,s.color,s.key,t,d,u)}catch(e){return void console.warn(e,"Exception has been caught when restore character ranges.")}if(!c||!c.getSelection())return;null===(n=c.getSelection())||void 0===n||n.empty()}}))}createOneNote(e,t){var r,n;return u(this,void 0,void 0,(function*(){let i=document.getElementById("page-area");if(!i)return;let o=i.getElementsByTagName("iframe")[0];if(!o||!o.contentWindow)return;let s=o.contentWindow||(null===(r=o.contentDocument)||void 0===r?void 0:r.defaultView),a=JSON.parse(e.range);var l=a.page;let c=yield this.chapterDocList[l].text.getPage(),h=yield Je(this.element,this.mode,this.chapterDocList,l);Ct(a,e.color,e.key,t,c,h),s&&s.getSelection()&&(null===(n=s.getSelection())||void 0===n||n.empty())}))}}var Er="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function Br(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Ir={},Ar={};Object.defineProperty(Ar,"__esModule",{value:!0}),Ar.default=()=>{throw new Error("File system is not available")};var Or={},Mr={};Object.defineProperty(Mr,"__esModule",{value:!0}),Mr.default=(e,t,r)=>({confidence:r,name:t.name(e),lang:t.language?t.language():void 0});var Dr=Er&&Er.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(Or,"__esModule",{value:!0});const Nr=Dr(Mr);Or.default=class{name(){return"ASCII"}match(e){const t=e.rawInput;for(let r=0;r<e.rawLen;r++){const n=t[r];if(n<32||n>126)return(0,Nr.default)(e,this,0)}return(0,Nr.default)(e,this,100)}};var Rr={},Fr=Er&&Er.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(Rr,"__esModule",{value:!0});const _r=Fr(Mr);Rr.default=class{name(){return"UTF-8"}match(e){let t,r=!1,n=0,i=0,o=0;const s=e.rawInput;e.rawLen>=3&&239==(255&s[0])&&187==(255&s[1])&&191==(255&s[2])&&(r=!0);for(let t=0;t<e.rawLen;t++){const r=s[t];if(128&r){if(192==(224&r))o=1;else if(224==(240&r))o=2;else if(240==(248&r))o=3;else{if(i++,i>5)break;o=0}for(;t++,!(t>=e.rawLen);){if(128!=(192&s[t])){i++;break}if(0==--o){n++;break}}}}if(t=0,r&&0==i)t=100;else if(r&&n>10*i)t=80;else if(n>3&&0==i)t=100;else if(n>0&&0==i)t=80;else if(0==n&&0==i)t=10;else{if(!(n>10*i))return null;t=25}return(0,_r.default)(e,this,t)}};var Pr={},Hr=Er&&Er.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(Pr,"__esModule",{value:!0}),Pr.UTF_32LE=Pr.UTF_32BE=Pr.UTF_16LE=Pr.UTF_16BE=void 0;const Ur=Hr(Mr);Pr.UTF_16BE=class{name(){return"UTF-16BE"}match(e){const t=e.rawInput;return t.length>=2&&254==(255&t[0])&&!(255&~t[1])?(0,Ur.default)(e,this,100):null}};Pr.UTF_16LE=class{name(){return"UTF-16LE"}match(e){const t=e.rawInput;return t.length>=2&&!(255&~t[0])&&254==(255&t[1])?t.length>=4&&0==t[2]&&0==t[3]?null:(0,Ur.default)(e,this,100):null}};class jr{name(){return"UTF-32"}getChar(e,t){return-1}match(e){let t=0,r=0,n=!1,i=0;const o=e.rawLen/4*4,s=e.rawInput;if(0==o)return null;65279==this.getChar(s,0)&&(n=!0);for(let e=0;e<o;e+=4){const n=this.getChar(s,e);n<0||n>=1114111||n>=55296&&n<=57343?r+=1:t+=1}return n&&0==r?i=100:n&&t>10*r?i=80:t>3&&0==r?i=100:t>0&&0==r?i=80:t>10*r&&(i=25),0==i?null:(0,Ur.default)(e,this,i)}}Pr.UTF_32BE=class extends jr{name(){return"UTF-32BE"}getChar(e,t){return(255&e[t+0])<<24|(255&e[t+1])<<16|(255&e[t+2])<<8|255&e[t+3]}};Pr.UTF_32LE=class extends jr{name(){return"UTF-32LE"}getChar(e,t){return(255&e[t+3])<<24|(255&e[t+2])<<16|(255&e[t+1])<<8|255&e[t+0]}};var $r={},zr=Er&&Er.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty($r,"__esModule",{value:!0}),$r.gb_18030=$r.euc_kr=$r.euc_jp=$r.big5=$r.sjis=void 0;const Wr=zr(Mr);function qr(e,t){const r=(e,t,n,i)=>{if(i<n)return-1;const o=Math.floor(n+i>>>1);return t>e[o]?r(e,t,o+1,i):t<e[o]?r(e,t,n,o-1):o};return r(e,t,0,e.length-1)}class Xr{constructor(){this.charValue=0,this.index=0,this.nextIndex=0,this.error=!1,this.done=!1}reset(){this.charValue=0,this.index=-1,this.nextIndex=0,this.error=!1,this.done=!1}nextByte(e){if(this.nextIndex>=e.rawLen)return this.done=!0,-1;return 255&e.rawInput[this.nextIndex++]}}class Vr{constructor(){this.commonChars=[]}name(){return"mbcs"}match(e){let t=0,r=0,n=0,i=0,o=0;const s=new Xr;e:{for(s.reset();this.nextChar(s,e);){if(i++,s.error)n++;else{const e=4294967295&s.charValue;e>255&&(t++,null!=this.commonChars&&qr(this.commonChars,e)>=0&&r++)}if(n>=2&&5*n>=t)break e}if(t<=10&&0==n)o=0==t&&i<10?0:10;else if(t<20*n)o=0;else if(null==this.commonChars)o=30+t-20*n,o>100&&(o=100);else{const e=90/Math.log(t/4);o=Math.floor(Math.log(r+1)*e+10),o=Math.min(o,100)}}return 0==o?null:(0,Wr.default)(e,this,o)}nextChar(e,t){return!0}}$r.sjis=class extends Vr{constructor(){super(...arguments),this.commonChars=[33088,33089,33090,33093,33115,33129,33130,33141,33142,33440,33442,33444,33449,33450,33451,33453,33455,33457,33459,33461,33463,33469,33470,33473,33476,33477,33478,33480,33481,33484,33485,33500,33504,33511,33512,33513,33514,33520,33521,33601,33603,33614,33615,33624,33630,33634,33639,33653,33654,33673,33674,33675,33677,33683,36502,37882,38314]}name(){return"Shift_JIS"}language(){return"ja"}nextChar(e,t){e.index=e.nextIndex,e.error=!1;const r=e.charValue=e.nextByte(t);if(r<0)return!1;if(r<=127||r>160&&r<=223)return!0;const n=e.nextByte(t);return!(n<0)&&(e.charValue=r<<8|n,n>=64&&n<=127||n>=128&&n<=255||(e.error=!0),!0)}};function Gr(e,t){e.index=e.nextIndex,e.error=!1;let r=0,n=0,i=0;return r=e.charValue=e.nextByte(t),r<0?e.done=!0:r<=141||(n=e.nextByte(t),e.charValue=e.charValue<<8|n,r>=161&&r<=254?n<161&&(e.error=!0):142!=r?143==r&&(i=e.nextByte(t),e.charValue=e.charValue<<8|i,i<161&&(e.error=!0)):n<161&&(e.error=!0)),0==e.done}$r.big5=class extends Vr{constructor(){super(...arguments),this.commonChars=[41280,41281,41282,41283,41287,41289,41333,41334,42048,42054,42055,42056,42065,42068,42071,42084,42090,42092,42103,42147,42148,42151,42177,42190,42193,42207,42216,42237,42304,42312,42328,42345,42445,42471,42583,42593,42594,42600,42608,42664,42675,42681,42707,42715,42726,42738,42816,42833,42841,42970,43171,43173,43181,43217,43219,43236,43260,43456,43474,43507,43627,43706,43710,43724,43772,44103,44111,44208,44242,44377,44745,45024,45290,45423,45747,45764,45935,46156,46158,46412,46501,46525,46544,46552,46705,47085,47207,47428,47832,47940,48033,48593,49860,50105,50240,50271]}name(){return"Big5"}language(){return"zh"}nextChar(e,t){e.index=e.nextIndex,e.error=!1;const r=e.charValue=e.nextByte(t);if(r<0)return!1;if(r<=127||255==r)return!0;const n=e.nextByte(t);return!(n<0)&&(e.charValue=e.charValue<<8|n,(n<64||127==n||255==n)&&(e.error=!0),!0)}};$r.euc_jp=class extends Vr{constructor(){super(...arguments),this.commonChars=[41377,41378,41379,41382,41404,41418,41419,41430,41431,42146,42148,42150,42152,42154,42155,42156,42157,42159,42161,42163,42165,42167,42169,42171,42173,42175,42176,42177,42179,42180,42182,42183,42184,42185,42186,42187,42190,42191,42192,42206,42207,42209,42210,42212,42216,42217,42218,42219,42220,42223,42226,42227,42402,42403,42404,42406,42407,42410,42413,42415,42416,42419,42421,42423,42424,42425,42431,42435,42438,42439,42440,42441,42443,42448,42453,42454,42455,42462,42464,42465,42469,42473,42474,42475,42476,42477,42483,47273,47572,47854,48072,48880,49079,50410,50940,51133,51896,51955,52188,52689],this.nextChar=Gr}name(){return"EUC-JP"}language(){return"ja"}};$r.euc_kr=class extends Vr{constructor(){super(...arguments),this.commonChars=[45217,45235,45253,45261,45268,45286,45293,45304,45306,45308,45496,45497,45511,45527,45538,45994,46011,46274,46287,46297,46315,46501,46517,46527,46535,46569,46835,47023,47042,47054,47270,47278,47286,47288,47291,47337,47531,47534,47564,47566,47613,47800,47822,47824,47857,48103,48115,48125,48301,48314,48338,48374,48570,48576,48579,48581,48838,48840,48863,48878,48888,48890,49057,49065,49088,49124,49131,49132,49144,49319,49327,49336,49338,49339,49341,49351,49356,49358,49359,49366,49370,49381,49403,49404,49572,49574,49590,49622,49631,49654,49656,50337,50637,50862,51151,51153,51154,51160,51173,51373],this.nextChar=Gr}name(){return"EUC-KR"}language(){return"ko"}};$r.gb_18030=class extends Vr{constructor(){super(...arguments),this.commonChars=[41377,41378,41379,41380,41392,41393,41457,41459,41889,41900,41914,45480,45496,45502,45755,46025,46070,46323,46525,46532,46563,46767,46804,46816,47010,47016,47037,47062,47069,47284,47327,47350,47531,47561,47576,47610,47613,47821,48039,48086,48097,48122,48316,48347,48382,48588,48845,48861,49076,49094,49097,49332,49389,49611,49883,50119,50396,50410,50636,50935,51192,51371,51403,51413,51431,51663,51706,51889,51893,51911,51920,51926,51957,51965,52460,52728,52906,52932,52946,52965,53173,53186,53206,53442,53445,53456,53460,53671,53930,53938,53941,53947,53972,54211,54224,54269,54466,54490,54754,54992]}name(){return"GB18030"}language(){return"zh"}nextChar(e,t){e.index=e.nextIndex,e.error=!1;let r=0,n=0,i=0,o=0;e:if(r=e.charValue=e.nextByte(t),r<0)e.done=!0;else if(!(r<=128))if(n=e.nextByte(t),e.charValue=e.charValue<<8|n,r>=129&&r<=254){if(n>=64&&n<=126||n>=80&&n<=254)break e;if(n>=48&&n<=57&&(i=e.nextByte(t),i>=129&&i<=254&&(o=e.nextByte(t),o>=48&&o<=57))){e.charValue=e.charValue<<16|i<<8|o;break e}e.error=!0}else;return 0==e.done}};var Jr={},Kr=Er&&Er.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(Jr,"__esModule",{value:!0}),Jr.KOI8_R=Jr.windows_1256=Jr.windows_1251=Jr.ISO_8859_9=Jr.ISO_8859_8=Jr.ISO_8859_7=Jr.ISO_8859_6=Jr.ISO_8859_5=Jr.ISO_8859_2=Jr.ISO_8859_1=void 0;const Zr=Kr(Mr);class Yr{constructor(e,t){this.byteIndex=0,this.ngram=0,this.ngramCount=0,this.hitCount=0,this.spaceChar=32,this.ngramList=e,this.byteMap=t}search(e,t){let r=0;return e[r+32]<=t&&(r+=32),e[r+16]<=t&&(r+=16),e[r+8]<=t&&(r+=8),e[r+4]<=t&&(r+=4),e[r+2]<=t&&(r+=2),e[r+1]<=t&&(r+=1),e[r]>t&&(r-=1),r<0||e[r]!=t?-1:r}lookup(e){this.ngramCount+=1,this.search(this.ngramList,e)>=0&&(this.hitCount+=1)}addByte(e){this.ngram=(this.ngram<<8)+(255&e)&16777215,this.lookup(this.ngram)}nextByte(e){return this.byteIndex>=e.inputLen?-1:255&e.inputBytes[this.byteIndex++]}parse(e,t){let r,n=!1;for(this.spaceChar=t;(r=this.nextByte(e))>=0;){const e=this.byteMap[r];0!=e&&(e==this.spaceChar&&n||this.addByte(e),n=e==this.spaceChar)}this.addByte(this.spaceChar);const i=this.hitCount/this.ngramCount;return i>.33?98:Math.floor(300*i)}}class Qr{constructor(e,t){this.fLang=e,this.fNGrams=t}}class en{constructor(){this.spaceChar=32,this.nGramLang=void 0}ngrams(){return[]}byteMap(){return[]}name(e){return"sbcs"}language(){return this.nGramLang}match(e){this.nGramLang=void 0;const t=this.ngrams();if(r=t,Array.isArray(r)&&isFinite(r[0])){const r=new Yr(t,this.byteMap()).parse(e,this.spaceChar);return r<=0?null:(0,Zr.default)(e,this,r)}var r;let n=-1;for(let r=t.length-1;r>=0;r--){const i=t[r],o=new Yr(i.fNGrams,this.byteMap()).parse(e,this.spaceChar);o>n&&(n=o,this.nGramLang=i.fLang)}return n<=0?null:(0,Zr.default)(e,this,n)}}Jr.ISO_8859_1=class extends en{byteMap(){return[32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,0,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,170,32,32,32,32,32,32,32,32,32,32,181,32,32,32,32,186,32,32,32,32,32,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,32,248,249,250,251,252,253,254,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,32,248,249,250,251,252,253,254,255]}ngrams(){return[new Qr("da",[2122086,2122100,2122853,2123118,2123122,2123375,2123873,2124064,2125157,2125671,2126053,2126697,2126708,2126953,2127465,6383136,6385184,6385252,6386208,6386720,6579488,6579566,6579570,6579572,6627443,6644768,6644837,6647328,6647396,6648352,6648421,6648608,6648864,6713202,6776096,6776174,6776178,6907749,6908960,6909543,7038240,7039845,7103858,7104871,7105637,7169380,7234661,7234848,7235360,7235429,7300896,7302432,7303712,7398688,7479396,7479397,7479411,7496992,7566437,7610483,7628064,7628146,7629164,7759218]),new Qr("de",[2122094,2122101,2122341,2122849,2122853,2122857,2123113,2123621,2123873,2124142,2125161,2126691,2126693,2127214,2127461,2127471,2127717,2128501,6448498,6514720,6514789,6514804,6578547,6579566,6579570,6580581,6627428,6627443,6646126,6646132,6647328,6648352,6648608,6776174,6841710,6845472,6906728,6907168,6909472,6909541,6911008,7104867,7105637,7217249,7217252,7217267,7234592,7234661,7234848,7235360,7235429,7238757,7479396,7496805,7497065,7562088,7566437,7610468,7628064,7628142,7628146,7695972,7695975,7759218]),new Qr("en",[2122016,2122094,2122341,2122607,2123375,2123873,2123877,2124142,2125153,2125670,2125938,2126437,2126689,2126708,2126952,2126959,2127720,6383972,6384672,6385184,6385252,6386464,6386720,6386789,6386793,6561889,6561908,6627425,6627443,6627444,6644768,6647412,6648352,6648608,6713202,6840692,6841632,6841714,6906912,6909472,6909543,6909806,6910752,7217249,7217268,7234592,7235360,7238688,7300640,7302688,7303712,7496992,7500576,7544929,7544948,7561577,7566368,7610484,7628146,7628897,7628901,7629167,7630624,7631648]),new Qr("es",[2122016,2122593,2122607,2122853,2123116,2123118,2123123,2124142,2124897,2124911,2125921,2125935,2125938,2126197,2126437,2126693,2127214,2128160,6365283,6365284,6365285,6365292,6365296,6382441,6382703,6384672,6386208,6386464,6515187,6516590,6579488,6579564,6582048,6627428,6627429,6627436,6646816,6647328,6647412,6648608,6648692,6907246,6943598,7102752,7106419,7217253,7238757,7282788,7282789,7302688,7303712,7303968,7364978,7435621,7495968,7497075,7544932,7544933,7544944,7562528,7628064,7630624,7693600,15953440]),new Qr("fr",[2122101,2122607,2122849,2122853,2122869,2123118,2123124,2124897,2124901,2125921,2125935,2125938,2126197,2126693,2126703,2127214,2154528,6385268,6386793,6513952,6516590,6579488,6579571,6583584,6627425,6627427,6627428,6627429,6627436,6627440,6627443,6647328,6647412,6648352,6648608,6648864,6649202,6909806,6910752,6911008,7102752,7103776,7103859,7169390,7217252,7234848,7238432,7238688,7302688,7302772,7304562,7435621,7479404,7496992,7544929,7544932,7544933,7544940,7544944,7610468,7628064,7629167,7693600,7696928]),new Qr("it",[2122092,2122600,2122607,2122853,2122857,2123040,2124140,2124142,2124897,2125925,2125938,2127214,6365283,6365284,6365296,6365299,6386799,6514789,6516590,6579564,6580512,6627425,6627427,6627428,6627433,6627436,6627440,6627443,6646816,6646892,6647412,6648352,6841632,6889569,6889571,6889572,6889587,6906144,6908960,6909472,6909806,7102752,7103776,7104800,7105633,7234848,7235872,7237408,7238757,7282785,7282788,7282793,7282803,7302688,7302757,7366002,7495968,7496992,7563552,7627040,7628064,7629088,7630624,8022383]),new Qr("nl",[2122092,2122341,2122849,2122853,2122857,2123109,2123118,2123621,2123877,2124142,2125153,2125157,2125680,2126949,2127457,2127461,2127471,2127717,2128489,6381934,6381938,6385184,6385252,6386208,6386720,6514804,6579488,6579566,6579570,6627426,6627446,6645102,6645106,6647328,6648352,6648435,6648864,6776174,6841716,6907168,6909472,6909543,6910752,7217250,7217252,7217253,7217256,7217263,7217270,7234661,7235360,7302756,7303026,7303200,7303712,7562088,7566437,7610468,7628064,7628142,7628146,7758190,7759218,7761775]),new Qr("no",[2122100,2122102,2122853,2123118,2123122,2123375,2123873,2124064,2125157,2125671,2126053,2126693,2126699,2126703,2126708,2126953,2127465,2155808,6385252,6386208,6386720,6579488,6579566,6579572,6627443,6644768,6647328,6647397,6648352,6648421,6648864,6648948,6713202,6776174,6908779,6908960,6909543,7038240,7039845,7103776,7105637,7169380,7169390,7217267,7234848,7235360,7235429,7237221,7300896,7302432,7303712,7398688,7479411,7496992,7565165,7566437,7610483,7628064,7628142,7628146,7629164,7631904,7631973,7759218]),new Qr("pt",[2122016,2122607,2122849,2122853,2122863,2123040,2123123,2125153,2125423,2125600,2125921,2125935,2125938,2126197,2126437,2126693,2127213,6365281,6365283,6365284,6365296,6382693,6382703,6384672,6386208,6386273,6386464,6516589,6516590,6578464,6579488,6582048,6582131,6627425,6627428,6647072,6647412,6648608,6648692,6906144,6906721,7169390,7238757,7238767,7282785,7282787,7282788,7282789,7282800,7303968,7364978,7435621,7495968,7497075,7544929,7544932,7544933,7544944,7566433,7628064,7630624,7693600,14905120,15197039]),new Qr("sv",[2122100,2122102,2122853,2123118,2123510,2123873,2124064,2124142,2124655,2125157,2125667,2126053,2126699,2126703,2126708,2126953,2127457,2127465,2155634,6382693,6385184,6385252,6386208,6386804,6514720,6579488,6579566,6579570,6579572,6644768,6647328,6648352,6648864,6747762,6776174,6909036,6909543,7037216,7105568,7169380,7217267,7233824,7234661,7235360,7235429,7235950,7299944,7302432,7302688,7398688,7479393,7479411,7495968,7564129,7565165,7610483,7627040,7628064,7628146,7629164,7631904,7758194,14971424,16151072])]}name(e){return e&&e.c1Bytes?"windows-1252":"ISO-8859-1"}};Jr.ISO_8859_2=class extends en{byteMap(){return[32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,0,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,177,32,179,32,181,182,32,32,185,186,187,188,32,190,191,32,177,32,179,32,181,182,183,32,185,186,187,188,32,190,191,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,32,248,249,250,251,252,253,254,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,32,248,249,250,251,252,253,254,32]}ngrams(){return[new Qr("cs",[2122016,2122361,2122863,2124389,2125409,2125413,2125600,2125668,2125935,2125938,2126072,2126447,2126693,2126703,2126708,2126959,2127392,2127481,2128481,6365296,6513952,6514720,6627440,6627443,6627446,6647072,6647533,6844192,6844260,6910836,6972704,7042149,7103776,7104800,7233824,7268640,7269408,7269664,7282800,7300206,7301737,7304052,7304480,7304801,7368548,7368554,7369327,7403621,7562528,7565173,7566433,7566441,7566446,7628146,7630573,7630624,7676016,12477728,14773997,15296623,15540336,15540339,15559968,16278884]),new Qr("hu",[2122016,2122106,2122341,2123111,2123116,2123365,2123873,2123887,2124147,2124645,2124649,2124790,2124901,2125153,2125157,2125161,2125413,2126714,2126949,2156915,6365281,6365291,6365293,6365299,6384416,6385184,6388256,6447470,6448494,6645625,6646560,6646816,6646885,6647072,6647328,6648421,6648864,6648933,6648948,6781216,6844263,6909556,6910752,7020641,7075450,7169383,7170414,7217249,7233899,7234923,7234925,7238688,7300985,7544929,7567973,7567988,7568097,7596391,7610465,7631904,7659891,8021362,14773792,15299360]),new Qr("pl",[2122618,2122863,2124064,2124389,2124655,2125153,2125161,2125409,2125417,2125668,2125935,2125938,2126697,2127648,2127721,2127737,2128416,2128481,6365296,6365303,6385257,6514720,6519397,6519417,6582048,6584937,6627440,6627443,6627447,6627450,6645615,6646304,6647072,6647401,6778656,6906144,6907168,6907242,7037216,7039264,7039333,7170405,7233824,7235937,7235941,7282800,7305057,7305065,7368556,7369313,7369327,7369338,7502437,7502457,7563754,7564137,7566433,7825765,7955304,7957792,8021280,8022373,8026400,15955744]),new Qr("ro",[2122016,2122083,2122593,2122597,2122607,2122613,2122853,2122857,2124897,2125153,2125925,2125938,2126693,2126819,2127214,2144873,2158190,6365283,6365284,6386277,6386720,6386789,6386976,6513010,6516590,6518048,6546208,6579488,6627425,6627427,6627428,6627440,6627443,6644e3,6646048,6646885,6647412,6648692,6889569,6889571,6889572,6889584,6907168,6908192,6909472,7102752,7103776,7106418,7107945,7234848,7238770,7303712,7365998,7496992,7497057,7501088,7594784,7628064,7631477,7660320,7694624,7695392,12216608,15625760])]}name(e){return e&&e.c1Bytes?"windows-1250":"ISO-8859-2"}};Jr.ISO_8859_5=class extends en{byteMap(){return[32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,0,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,241,242,243,244,245,246,247,248,249,250,251,252,32,254,255,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,32,241,242,243,244,245,246,247,248,249,250,251,252,32,254,255]}ngrams(){return[2150944,2151134,2151646,2152400,2152480,2153168,2153182,2153936,2153941,2154193,2154462,2154464,2154704,2154974,2154978,2155230,2156514,2158050,13688280,13689580,13884960,14015468,14015960,14016994,14017056,14164191,14210336,14211104,14216992,14407133,14407712,14413021,14536736,14538016,14538965,14538991,14540320,14540498,14557394,14557407,14557409,14602784,14602960,14603230,14604576,14605292,14605344,14606818,14671579,14672085,14672088,14672094,14733522,14734804,14803664,14803666,14803672,14806816,14865883,14868e3,14868192,14871584,15196894,15459616]}name(){return"ISO-8859-5"}language(){return"ru"}};Jr.ISO_8859_6=class extends en{byteMap(){return[32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,0,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,32,32,32,32,32,224,225,226,227,228,229,230,231,232,233,234,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32]}ngrams(){return[2148324,2148326,2148551,2152932,2154986,2155748,2156006,2156743,13050055,13091104,13093408,13095200,13100064,13100227,13100231,13100232,13100234,13100236,13100237,13100239,13100243,13100249,13100258,13100261,13100264,13100266,13100320,13100576,13100746,13115591,13181127,13181153,13181156,13181157,13181160,13246663,13574343,13617440,13705415,13748512,13836487,14229703,14279913,14805536,14950599,14993696,15001888,15002144,15016135,15058720,15059232,15066656,15081671,15147207,15189792,15255524,15263264,15278279,15343815,15343845,15343848,15386912,15388960,15394336]}name(){return"ISO-8859-6"}language(){return"ar"}};Jr.ISO_8859_7=class extends en{byteMap(){return[32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,0,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,161,162,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,220,32,221,222,223,32,252,32,253,254,192,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,32,243,244,245,246,247,248,249,250,251,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,32]}ngrams(){return[2154989,2154992,2155497,2155753,2156016,2156320,2157281,2157797,2158049,2158368,2158817,2158831,2158833,2159604,2159605,2159847,2159855,14672160,14754017,14754036,14805280,14806304,14807292,14807584,14936545,15067424,15069728,15147252,15199520,15200800,15278324,15327520,15330014,15331872,15393257,15393268,15525152,15540449,15540453,15540464,15589664,15725088,15725856,15790069,15790575,15793184,15868129,15868133,15868138,15868144,15868148,15983904,15984416,15987951,16048416,16048617,16050157,16050162,16050666,16052e3,16052213,16054765,16379168,16706848]}name(e){return e&&e.c1Bytes?"windows-1253":"ISO-8859-7"}language(){return"el"}};Jr.ISO_8859_8=class extends en{byteMap(){return[32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,0,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,181,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,32,32,32,32,32]}ngrams(){return[new Qr("he",[2154725,2154727,2154729,2154746,2154985,2154990,2155744,2155749,2155753,2155758,2155762,2155769,2155770,2157792,2157796,2158304,2159340,2161132,14744096,14950624,14950625,14950628,14950636,14950638,14950649,15001056,15065120,15068448,15068960,15071264,15071776,15278308,15328288,15328762,15329773,15330592,15331104,15333408,15333920,15474912,15474916,15523872,15524896,15540448,15540449,15540452,15540460,15540462,15540473,15655968,15671524,15787040,15788320,15788525,15920160,16261348,16312813,16378912,16392416,16392417,16392420,16392428,16392430,16392441]),new Qr("he",[2154725,2154732,2155753,2155756,2155758,2155760,2157040,2157810,2157817,2158053,2158057,2158565,2158569,2160869,2160873,2161376,2161381,2161385,14688484,14688492,14688493,14688506,14738464,14738916,14740512,14741024,14754020,14754029,14754042,14950628,14950633,14950636,14950637,14950639,14950648,14950650,15002656,15065120,15066144,15196192,15327264,15327520,15328288,15474916,15474925,15474938,15528480,15530272,15591913,15591920,15591928,15605988,15605997,15606010,15655200,15655968,15918112,16326884,16326893,16326906,16376864,16441376,16442400,16442857])]}name(e){return e&&e.c1Bytes?"windows-1255":"ISO-8859-8"}language(){return"he"}};Jr.ISO_8859_9=class extends en{byteMap(){return[32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,0,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,170,32,32,32,32,32,32,32,32,32,32,181,32,32,32,32,186,32,32,32,32,32,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,32,248,249,250,251,252,105,254,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,32,248,249,250,251,252,253,254,255]}ngrams(){return[2122337,2122345,2122357,2122849,2122853,2123621,2123873,2124140,2124641,2124655,2125153,2125676,2126689,2126945,2127461,2128225,6365282,6384416,6384737,6384993,6385184,6385405,6386208,6386273,6386429,6386685,6388065,6449522,6578464,6579488,6580512,6627426,6627435,6644841,6647328,6648352,6648425,6648681,6909029,6909472,6909545,6910496,7102830,7102834,7103776,7103858,7217249,7217250,7217259,7234657,7234661,7234848,7235872,7235950,7273760,7498094,7535982,7759136,7954720,7958386,16608800,16608868,16609021,16642301]}name(e){return e&&e.c1Bytes?"windows-1254":"ISO-8859-9"}language(){return"tr"}};Jr.windows_1251=class extends en{byteMap(){return[32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,0,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,144,131,32,131,32,32,32,32,32,32,154,32,156,157,158,159,144,32,32,32,32,32,32,32,32,32,154,32,156,157,158,159,32,162,162,188,32,180,32,32,184,32,186,32,32,32,32,191,32,32,179,179,180,181,32,32,184,32,186,32,188,190,190,191,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255]}ngrams(){return[2155040,2155246,2155758,2156512,2156576,2157280,2157294,2158048,2158053,2158305,2158574,2158576,2158816,2159086,2159090,2159342,2160626,2162162,14740968,14742268,14937632,15068156,15068648,15069682,15069728,15212783,15263008,15263776,15269664,15459821,15460384,15465709,15589408,15590688,15591653,15591679,15592992,15593186,15605986,15605999,15606001,15655456,15655648,15655918,15657248,15657980,15658016,15659506,15724267,15724773,15724776,15724782,15786210,15787492,15856352,15856354,15856360,15859488,15918571,15920672,15920880,15924256,16249582,16512288]}name(){return"windows-1251"}language(){return"ru"}};Jr.windows_1256=class extends en{byteMap(){return[32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,0,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,129,32,131,32,32,32,32,136,32,138,32,156,141,142,143,144,32,32,32,32,32,32,32,152,32,154,32,156,32,32,159,32,32,32,32,32,32,32,32,32,32,170,32,32,32,32,32,32,32,32,32,32,181,32,32,32,32,32,32,32,32,32,32,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,32,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,32,32,32,32,244,32,32,32,32,249,32,251,252,32,32,255]}ngrams(){return[2148321,2148324,2148551,2153185,2153965,2154977,2155492,2156231,13050055,13091104,13093408,13095200,13099296,13099459,13099463,13099464,13099466,13099468,13099469,13099471,13099475,13099482,13099486,13099491,13099494,13099501,13099808,13100064,13100234,13115591,13181127,13181149,13181153,13181155,13181158,13246663,13574343,13617440,13705415,13748512,13836487,14295239,14344684,14544160,14753991,14797088,14806048,14806304,14885063,14927648,14928160,14935072,14950599,15016135,15058720,15124449,15131680,15474887,15540423,15540451,15540454,15583520,15585568,15590432]}name(){return"windows-1256"}language(){return"ar"}};Jr.KOI8_R=class extends en{byteMap(){return[32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,0,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,163,32,32,32,32,32,32,32,32,32,32,32,32,32,32,32,163,32,32,32,32,32,32,32,32,32,32,32,32,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223]}ngrams(){return[2147535,2148640,2149313,2149327,2150081,2150085,2150338,2150607,2150610,2151105,2151375,2151380,2151631,2152224,2152399,2153153,2153684,2154196,12701385,12702936,12963032,12963529,12964820,12964896,13094688,13181136,13223200,13224224,13226272,13419982,13420832,13424846,13549856,13550880,13552069,13552081,13553440,13553623,13574352,13574355,13574359,13617103,13617696,13618392,13618464,13620180,13621024,13621185,13684684,13685445,13685449,13685455,13812183,13813188,13881632,13882561,13882569,13882583,13944268,13946656,13946834,13948960,14272544,14603471]}name(){return"KOI8-R"}language(){return"ru"}};var tn={},rn=Er&&Er.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(tn,"__esModule",{value:!0}),tn.ISO_2022_CN=tn.ISO_2022_KR=tn.ISO_2022_JP=void 0;const nn=rn(Mr);class on{constructor(){this.escapeSequences=[]}name(){return"ISO_2022"}match(e){let t,r,n,i,o=0,s=0,a=0;const l=e.inputBytes,c=e.inputLen;e:for(t=0;t<c;t++){if(27==l[t]){t:for(n=0;n<this.escapeSequences.length;n++){const e=this.escapeSequences[n];if(!(c-t<e.length)){for(r=1;r<e.length;r++)if(e[r]!=l[t+r])continue t;o++,t+=e.length-1;continue e}}s++}14!=l[t]&&15!=l[t]||a++}return 0==o?null:(i=(100*o-100*s)/(o+s),o+a<5&&(i-=10*(5-(o+a))),i<=0?null:(0,nn.default)(e,this,i))}}tn.ISO_2022_JP=class extends on{constructor(){super(...arguments),this.escapeSequences=[[27,36,40,67],[27,36,40,68],[27,36,64],[27,36,65],[27,36,66],[27,38,64],[27,40,66],[27,40,72],[27,40,73],[27,40,74],[27,46,65],[27,46,70]]}name(){return"ISO-2022-JP"}language(){return"ja"}};tn.ISO_2022_KR=class extends on{constructor(){super(...arguments),this.escapeSequences=[[27,36,41,67]]}name(){return"ISO-2022-KR"}language(){return"kr"}};tn.ISO_2022_CN=class extends on{constructor(){super(...arguments),this.escapeSequences=[[27,36,41,65],[27,36,41,71],[27,36,42,72],[27,36,41,69],[27,36,43,73],[27,36,43,74],[27,36,43,75],[27,36,43,76],[27,36,43,77],[27,78],[27,79]]}name(){return"ISO-2022-CN"}language(){return"zh"}};var sn={};Object.defineProperty(sn,"__esModule",{value:!0}),sn.isByteArray=void 0;sn.isByteArray=e=>null!=e&&"object"==typeof e&&(isFinite(e.length)&&e.length>=0),function(e){var t=Er&&Er.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,i)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),r=Er&&Er.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),n=Er&&Er.__importStar||function(e){if(e&&e.__esModule)return e;var n={};if(null!=e)for(var i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&t(n,e,i);return r(n,e),n},i=Er&&Er.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(e,"__esModule",{value:!0}),e.detectFileSync=e.detectFile=e.analyse=e.detect=void 0;const o=i(Ar),s=i(Or),a=i(Rr),l=n(Pr),c=n($r),h=n(Jr),d=n(tn),u=sn,f=[new a.default,new l.UTF_16BE,new l.UTF_16LE,new l.UTF_32BE,new l.UTF_32LE,new c.sjis,new c.big5,new c.euc_jp,new c.euc_kr,new c.gb_18030,new d.ISO_2022_JP,new d.ISO_2022_KR,new d.ISO_2022_CN,new h.ISO_8859_1,new h.ISO_8859_2,new h.ISO_8859_5,new h.ISO_8859_6,new h.ISO_8859_7,new h.ISO_8859_8,new h.ISO_8859_9,new h.windows_1251,new h.windows_1256,new h.KOI8_R,new s.default];e.detect=t=>{const r=(0,e.analyse)(t);return r.length>0?r[0].name:null};e.analyse=e=>{if(!(0,u.isByteArray)(e))throw new Error("Input must be a byte array, e.g. Buffer or Uint8Array");const t=[];for(let e=0;e<256;e++)t[e]=0;for(let r=e.length-1;r>=0;r--)t[255&e[r]]++;let r=!1;for(let e=128;e<=159;e+=1)if(0!==t[e]){r=!0;break}const n={byteStats:t,c1Bytes:r,rawInput:e,rawLen:e.length,inputBytes:e,inputLen:e.length},i=f.map((e=>e.match(n))).filter((e=>!!e)).sort(((e,t)=>t.confidence-e.confidence));return i};e.detectFile=(t,r={})=>new Promise(((n,i)=>{let s;const a=(0,o.default)(),l=(t,r)=>{s&&a.closeSync(s),t?i(t):n((0,e.detect)(r))};if(r&&r.sampleSize){s=a.openSync(t,"r");const e=Buffer.allocUnsafe(r.sampleSize);a.read(s,e,0,r.sampleSize,r.offset,(t=>{l(t,e)}))}else a.readFile(t,l)}));e.detectFileSync=(t,r={})=>{const n=(0,o.default)();if(r&&r.sampleSize){const i=n.openSync(t,"r"),o=Buffer.allocUnsafe(r.sampleSize);return n.readSync(i,o,0,r.sampleSize,r.offset),n.closeSync(i),(0,e.detect)(o)}return(0,e.detect)(n.readFileSync(t))},e.default={analyse:e.analyse,detect:e.detect,detectFileSync:e.detectFileSync,detectFile:e.detectFile}}(Ir);var an=Br(Ir);class ln extends Et{constructor(e,t,r,n){super(t,"TXT",n),this.text=e,this.encoding=r,this.mode=t,this.chapterList=[],this.chapterDocList=[],this.bookStr="",this.element="",this.book=""}renderTo(e){return new Promise(((t,r)=>u(this,void 0,void 0,(function*(){this.element=e,this.book||(yield this.parse());let r=new S(this.book);this.chapterList=yield r.getChapter(this.book.toc),this.chapterDocList=yield r.getChapterDoc(),b(e),L(e,this.mode),t()}))))}parse(){return u(this,void 0,void 0,(function*(){try{this.book=ke(this.text,!0)}catch(e){throw console.log(e),e}}))}preCache(){return u(this,void 0,void 0,(function*(){return this.book||(yield this.parse()),yield this.getCache(this.book)}))}getMetadata(e){return u(this,void 0,void 0,(function*(){try{const t=new Uint8Array(e);return{charset:an.detect(t)||"utf8"}}catch(e){throw console.log(e),e}}))}}const cn=({entries:e,loadBlob:t,getSize:r},n)=>{const i=new Map,o=new Map,s=[".jpg",".jpeg",".png",".gif",".bmp",".webp",".svg"],a=e.map((e=>e.filename)).filter((e=>s.some((t=>e.endsWith(t))))).sort(),l={getCover:()=>t(a[0])};return l.metadata={title:n.name},l.sections=a.map((e=>({id:e,load:()=>(async e=>{if(i.has(e))return i.get(e);const r=URL.createObjectURL(await t(e)),n=URL.createObjectURL(new Blob([`<img src="${r}">`],{type:"text/html"}));return o.set(e,[r,n]),i.set(e,n),n})(e),unload:()=>(e=>{o.get(e)?.forEach?.((e=>URL.revokeObjectURL(e))),o.delete(e),i.delete(e)})(e),size:r(e)}))),l.toc=a.map((e=>({label:e,href:e}))),l.rendition={layout:"pre-paginated"},l.resolveHref=e=>({index:l.sections.findIndex((t=>t.id===e))}),l.splitTOCHref=e=>[e,null],l.getTOCFragment=e=>e.documentElement,l};class hn extends Et{constructor(e,t,r,n){super(t,r,n),this.comicBuffer=e,this.mode=t,this.format=r,this.chapterList=[],this.chapterDocList=[],this.book="",this.element="",this.rpc}renderTo(e){return new Promise(((t,r)=>u(this,void 0,void 0,(function*(){if(this.element=e,b(e),!this.book)try{yield this.parse()}catch(e){console.log(e),r(e)}let n=new S(this.book);this.chapterList=yield n.getChapter(this.book.toc),this.chapterDocList=yield n.getChapterDoc(),L(e,this.mode),t()}))))}parse(){return u(this,void 0,void 0,(function*(){try{let e=new Blob([this.comicBuffer]),t=new File([e],"book."+this.format.toLocaleLowerCase(),{lastModified:(new Date).getTime(),type:e.type});if("CBZ"===this.format){const e=yield this.makeZipLoader(t);this.book=cn(e,t)}else if("CBT"===this.format){const e=yield this.makeTarLoader();this.book=cn(e,t)}else if("CBR"===this.format){this.rpc=yield window.RPC.new("./lib/libunrar/worker.js",{loaded:function(){console.log("loaded")},progressShow:function(e,t,r){console.log(r)}}),yield new Promise((e=>setTimeout(e,200)));const e=yield this.makeRarLoader();this.book=cn(e,t)}else if("CB7"===this.format){const e=yield this.make7zLoader();this.book=cn(e,t)}}catch(e){throw console.log(e),e}}))}preCache(){return u(this,void 0,void 0,(function*(){return this.book||(yield this.parse()),yield this.getCache(this.book)}))}makeZipLoader(e){return u(this,void 0,void 0,(function*(){const t=new n(new i(e)),r=yield t.getEntries(),a=new Map(r.map((e=>[e.filename,e]))),l=e=>(t,...r)=>a.has(t)?e(a.get(t),...r):null;return{entries:r,loadText:l((e=>e.getData(new o))),loadBlob:l(((e,t)=>e.getData(new s(t)))),getSize:e=>{var t,r;return null!==(r=null===(t=a.get(e))||void 0===t?void 0:t.uncompressedSize)&&void 0!==r?r:0}}}))}makeTarLoader(){return u(this,void 0,void 0,(function*(){const e=yield l(this.comicBuffer),t=new Map(e.map((e=>[e.name,e]))),r=e=>(r,...n)=>t.has(r)?e(t.get(r),...n):null,n=r((e=>e.readAsString())),i=r(((e,t)=>e.blob));return{entries:e.map((e=>({filename:e.name}))),loadText:n,loadBlob:i,getSize:e=>{var r,n;return null!==(n=null===(r=t.get(e))||void 0===r?void 0:r.size)&&void 0!==n?n:0}}}))}makeRarLoader(){return u(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{var r=[this.comicBuffer],n=[{name:"book.rar",content:this.comicBuffer}];this.rpc.transferables=r,this.rpc.unrar(n,null,0).then((t=>{let r=this.getRarEntries(t.ls);const n=new Map(Object.values(r).map((e=>[e.fullFileName,e]))),i=e=>(t,...r)=>n.has(t)?e(n.get(t),...r):null,o=i((e=>e.fullFileName)),s=i(((e,t)=>new Blob([e.fileContent])));e({entries:Object.values(r).map((e=>({filename:e.fullFileName}))),loadText:o,loadBlob:s,getSize:e=>{var t,r;return null!==(r=null===(t=n.get(e))||void 0===t?void 0:t.fileSize)&&void 0!==r?r:0}})})).catch((e=>{t(e),console.log(e)}))}))}))}make7zLoader(){return u(this,void 0,void 0,(function*(){const e="./lib/7z-wasm/7zz.wasm";if(!window.wasmBinary){const t=yield fetch(e,{credentials:"same-origin"});if(!t.ok)throw"failed to load wasm binary file at '"+e+"'";window.wasmBinary=yield t.arrayBuffer()}const t=yield window.SevenZip({wasmBinary:window.wasmBinary}),r=new Uint8Array(this.comicBuffer),n="archive.cb7",i=t.FS.open(n,"w+");t.FS.write(i,r,0,r.length),t.FS.close(i),t.callMain(["x",n]);const o=t.FS,s=this.get7zEntries(o.lookupPath("/").node),a=new Map(s.map((e=>[e.name,e]))),l=e=>(t,...r)=>a.has(t)?e(a.get(t),...r):null,c=l((e=>e.name)),h=l(((e,t)=>new Blob([e.buffer])));return{entries:s.map((e=>({filename:e.name}))),loadText:c,loadBlob:h,getSize:e=>{var t,r;return null!==(r=null===(t=a.get(e))||void 0===t?void 0:t.packSize)&&void 0!==r?r:0}}}))}getRarEntries(e){const t=Object.keys(e);let r=[];for(let n=0;n<t.length;n++){const i=t[n];"dir"===e[i].type?r=r.concat(this.getRarEntries(e[i].ls)):r.push({fullFileName:i,fileContent:e[i].fileContent,fileSize:e[i].fileSize})}return r}get7zEntries(e){const t=e.contents,r=Object.keys(t).filter((e=>"archive.cb7"!=e&&"dev"!=e&&"home"!=e&&"proc"!=e&&"tmp"!=e));let n=[];for(let e=0;e<r.length;e++){const i=r[e];t[i].isFolder?n=n.concat(this.get7zEntries(t[i])):n.push({name:i,buffer:t[i].contents,size:t[i].usedBytes})}return n}getMetadata(){return u(this,void 0,void 0,(function*(){return new Promise(((e,t)=>u(this,void 0,void 0,(function*(){try{this.book||(yield this.parse());const t=yield this.book.getCover();var r=new FileReader;r.readAsDataURL(t),r.onloadend=()=>{e({cover:r.result})}}catch(e){console.log(e),t(e)}}))))}))}}const dn=e=>e?.trim()?.replace(/\s{2,}/g," "),un=e=>dn(e?.textContent),fn={XLINK:"http://www.w3.org/1999/xlink",EPUB:"http://www.idpf.org/2007/ops"},pn="application/xml",gn="application/xhtml+xml",mn={strong:["strong","self"],emphasis:["em","self"],style:["span","self"],a:"anchor",strikethrough:["s","self"],sub:["sub","self"],sup:["sup","self"],code:["code","self"],image:"image"},yn={epigraph:["blockquote"],subtitle:["h2",mn],"text-author":["p",mn],date:["p",mn],stanza:"stanza"},bn={title:["header",{p:["h1",mn],"empty-line":["br"]}],epigraph:["blockquote","self"],image:"image",annotation:["aside"],section:["section","self"],p:["p",mn],poem:["blockquote",yn],subtitle:["h2",mn],cite:["blockquote","self"],"empty-line":["br"],table:["table",{tr:["tr",["align"]],th:["th",["colspan","rowspan","align","valign"]],td:["td",["colspan","rowspan","align","valign"]]}],"text-author":["p",mn]};yn.epigraph.push(bn);const wn={image:"image",title:["section",{p:["h1",mn],"empty-line":["br"]}],epigraph:["section",bn],section:["section",bn]},vn=e=>{const t=e.getAttributeNS(fn.XLINK,"href"),[,r]=t.split("#"),n=e.getRootNode().getElementById(r);return n?`data:${n.getAttribute("content-type")};base64,${n.textContent}`:t};class xn{constructor(e){this.fb2=e,this.doc=document.implementation.createDocument(fn.XHTML,"html")}image(e){const t=this.doc.createElement("img");return t.alt=e.getAttribute("alt"),t.title=e.getAttribute("title"),t.setAttribute("src",vn(e)),t}anchor(e){const t=this.convert(e,{a:["a",mn]});return t.setAttribute("href",e.getAttributeNS(fn.XLINK,"href")),"note"===e.getAttribute("type")&&t.setAttributeNS(fn.EPUB,"epub:type","noteref"),t}stanza(e){const t=this.convert(e,{stanza:["p",{title:["header",{p:["strong",mn],"empty-line":["br"]}],subtitle:["p",mn]}]});for(const r of e.children)"v"===r.nodeName&&(t.append(this.doc.createTextNode(r.textContent)),t.append(this.doc.createElement("br")));return t}convert(e,t){if(3===e.nodeType)return this.doc.createTextNode(e.textContent);if(4===e.nodeType)return this.doc.createCDATASection(e.textContent);if(8===e.nodeType)return this.doc.createComment(e.textContent);const r=t?.[e.nodeName];if(!r)return null;if("string"==typeof r)return this[r](e);const[n,i]=r,o=this.doc.createElement(n);if(e.id&&(o.id=e.id),o.classList.add(e.nodeName),Array.isArray(i))for(const t of i)o.setAttribute(t,e.getAttribute(t));const s="self"===i?t:Array.isArray(i)?null:i;let a=e.firstChild;for(;a;){const e=this.convert(a,s);e&&o.append(e),a=a.nextSibling}return o}}const Cn=URL.createObjectURL(new Blob(['\n@namespace epub "http://www.idpf.org/2007/ops";\nbody > img, section > img {\n    display: block;\n    margin: auto;\n}\n.title {\n    text-align: center;\n}\nbody > section > .title, body.notesBodyType > .title {\n    margin: 3em 0;\n}\nbody.notesBodyType > section .title {\n    text-align: left;\n    margin: 1em 0;\n}\np {\n    text-indent: 1em;\n    margin: 0;\n}\n:not(p) + p, p:first-child {\n    text-indent: 0;\n}\n.poem p {\n    text-indent: 0;\n    margin: 1em 0;\n}\n.text-author, .date {\n    text-align: end;\n}\n.text-author:before {\n    content: "—";\n}\ntable {\n    border-collapse: collapse;\n}\ntd, th {\n    padding: .25em;\n}\na[epub|type~="noteref"] {\n    font-size: .75em;\n    vertical-align: super;\n}\nbody:not(.notesBodyType) > .title, body:not(.notesBodyType) > .epigraph {\n    margin: 3em 0;\n}\n'],{type:"text/css"})),Ln="data-foliate-id",Sn=async e=>{const t={},r=await(async e=>{const t=await e.arrayBuffer(),r=new TextDecoder("utf-8").decode(t),n=new DOMParser,i=n.parseFromString(r,pn),o=i.xmlEncoding||r.match(/^<\?xml\s+version\s*=\s*["']1.\d+"\s+encoding\s*=\s*["']([A-Za-z0-9._-]*)["']/)?.[1];if(o&&"utf-8"!==o.toLowerCase()){const e=new TextDecoder(o).decode(t);return n.parseFromString(e,pn)}return i})(e),n=new xn(r),i=e=>r.querySelector(e),o=e=>[...r.querySelectorAll(e)],s=e=>{const t=un(e.querySelector("nickname"));if(t)return t;const r=un(e.querySelector("first-name")),n=un(e.querySelector("middle-name")),i=un(e.querySelector("last-name"));return{name:[r,n,i].filter((e=>e)).join(" "),sortAs:i?[i,[r,n].filter((e=>e)).join(" ")].join(", "):null}},a=e=>e?.getAttribute("value")??un(e),l=i("title-info annotation");t.metadata={title:un(i("title-info book-title")),identifier:un(i("document-info id")),language:un(i("title-info lang")),author:o("title-info author").map(s),translator:o("title-info translator").map(s),producer:o("document-info author").map(s).concat(o("document-info program-used").map(un)),publisher:un(i("publish-info publisher")),published:a(i("title-info date")),modified:a(i("document-info date")),description:l?n.convert(l,{annotation:["div",bn]}).innerHTML:null,subject:o("title-info genre").map(un)},t.getCover=()=>fetch(vn(i("coverpage image"))).then((e=>e.blob()));const c=Array.from(r.querySelectorAll("body"),(e=>{const t=n.convert(e,{body:["body",wn]});return[Array.from(t.children,(e=>{const t=[e,...e.querySelectorAll("[id]")].map((e=>e.id));return{el:e,ids:t}})),t]})),h=c[0][0].map((({el:e,ids:t})=>({ids:t,titles:Array.from(e.querySelectorAll(":scope > section > .title"),((e,t)=>(e.setAttribute(Ln,t),{title:un(e),index:t}))),el:e}))).concat(c.slice(1).map((([e,t])=>{const r=e.map((e=>e.ids)).flat();return t.classList.add("notesBodyType"),{ids:r,el:t,linear:"no"}}))).map((({ids:e,titles:t,el:r,linear:n})=>{const i=(o=r.outerHTML,`<?xml version="1.0" encoding="utf-8"?>\n<html xmlns="http://www.w3.org/1999/xhtml">\n    <head><link href="${Cn}" rel="stylesheet" type="text/css"/></head>\n    <body>${o}</body>\n</html>`);var o;const s=new Blob([i],{type:gn}),a=URL.createObjectURL(s);return{ids:e,title:dn(r.querySelector(".title, .subtitle, p")?.textContent??(r.classList.contains("title")?r.textContent:"")),titles:t,load:()=>a,createDocument:()=>(new DOMParser).parseFromString(i,gn),size:s.size-Array.from(r.querySelectorAll("[src]"),(e=>e.getAttribute("src")?.length??0)).reduce(((e,t)=>e+t),0),linear:n}})),d=new Map;return t.sections=h.map(((e,t)=>{const{ids:r,load:n,createDocument:i,size:o,linear:s}=e;for(const e of r)e&&d.set(e,t);return{id:t,load:n,createDocument:i,size:o,linear:s}})),t.toc=h.map((({title:e,titles:t},r)=>{const n=r.toString();return{label:e,href:n,subitems:t?.length?t.map((({title:e,index:t})=>({label:e,href:`${n}#${t}`}))):null}})).filter((e=>e)),t.resolveHref=e=>{const[t,r]=e.split("#");return t?{index:Number(t),anchor:e=>e.querySelector(`[${Ln}="${r}"]`)}:{index:d.get(r),anchor:e=>e.getElementById(r)}},t.splitTOCHref=e=>e?.split("#")?.map((e=>Number(e)))??[],t.getTOCFragment=(e,t)=>e.querySelector(`[${Ln}="${t}"]`),t};class Tn extends Et{constructor(e,t,r){super(t,"FB2",r),this.fb2Buffer=e,this.mode=t,this.chapterList=[],this.chapterDocList=[],this.book="",this.element=""}renderTo(e){return new Promise(((t,r)=>u(this,void 0,void 0,(function*(){this.element=e,this.book||(yield this.parse());let r=new S(this.book);this.chapterList=yield r.getChapter(this.book.toc),this.chapterDocList=yield r.getChapterDoc(),b(e),L(e,this.mode),t()}))))}parse(){return u(this,void 0,void 0,(function*(){try{let e=new Blob([this.fb2Buffer]);this.book=yield Sn(e)}catch(e){throw console.log(e),e}}))}preCache(){return u(this,void 0,void 0,(function*(){return this.book||(yield this.parse()),yield this.getCache(this.book)}))}getMetadata(){return u(this,void 0,void 0,(function*(){try{this.book||(yield this.parse());let e=new S(this.book);return yield e.getMetadata()}catch(e){throw console.log(e),e}}))}}const kn=e=>u(void 0,void 0,void 0,(function*(){let n=yield r.loadAsync(e);var i=n.file("toc.json");let o=[];i&&(o=JSON.parse(yield i.async("string")));var s=n.file("sections.json");let a=[];s&&(a=JSON.parse(yield s.async("string")));const l={getCover:()=>""};return l.sections=a.map(((e,t)=>({id:e.href,load:()=>(e=>u(void 0,void 0,void 0,(function*(){var t=n.file("chapters/"+e+".html");let r="";return t&&(r=yield t.async("string")),URL.createObjectURL(new Blob([r],{type:"text/html"}))})))(t),unload:()=>{},loadAsset:e=>(e=>u(void 0,void 0,void 0,(function*(){var t=n.file(e);let r;return t&&(r=yield t.async("arraybuffer")),URL.createObjectURL(new Blob([r],{type:lt[e.split(".").reverse()[0]]}))})))(e)}))),l.toc=o.map((e=>({label:e.label,href:e.href,subitems:e.subitems}))),l.rendition={layout:"pre-paginated"},l.resolveHref=e=>({index:t.findLastIndex(a,{href:e})}),l.splitTOCHref=e=>[e,null],l.getTOCFragment=e=>e.documentElement,l}));class En extends Et{constructor(e,t,r){super(t,"CACHE",r),this.cacheBuffer=e,this.mode=t,this.chapterList=[],this.chapterDocList=[],this.element=""}renderTo(e){return new Promise(((t,r)=>u(this,void 0,void 0,(function*(){this.element=e,this.book=yield kn(this.cacheBuffer);let r=new S(this.book);this.chapterList=yield r.getChapter(this.book.toc),this.chapterDocList=yield r.getChapterDoc(),b(e),L(e,this.mode),t()}))))}}class Bn extends Et{constructor(e,t,r){super(t,"DOCX",r),this.docxBuffer=e,this.mode=t,this.chapterList=[],this.chapterDocList=[],this.element=""}renderTo(e){return new Promise(((t,r)=>u(this,void 0,void 0,(function*(){this.element=e,this.book||(yield this.parse());let r=new S(this.book);this.chapterList=yield r.getChapter(this.book.toc),this.chapterDocList=yield r.getChapterDoc(),b(e),L(e,this.mode),t()}))))}parse(){return u(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{try{c.convertToHtml({arrayBuffer:this.docxBuffer}).then((t=>u(this,void 0,void 0,(function*(){this.book=ke(t.value,!1),e()}))))}catch(e){console.log(e),t(e)}}))}))}preCache(){return u(this,void 0,void 0,(function*(){return this.book||(yield this.parse()),yield this.getCache(this.book)}))}}class In extends Et{constructor(e,t,r){super(t,"MD",r),this.mdBuffer=e,this.mode=t,this.chapterList=[],this.chapterDocList=[],this.element=""}renderTo(e){return new Promise(((t,r)=>u(this,void 0,void 0,(function*(){this.element=e,this.book||(yield this.parse());let r=new S(this.book);this.chapterList=yield r.getChapter(this.book.toc),this.chapterDocList=yield r.getChapterDoc(),b(e),L(e,this.mode),t()}))))}parse(){return u(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{try{var r=new Blob([this.mdBuffer],{type:"text/plain"}),n=new FileReader;n.onload=t=>u(this,void 0,void 0,(function*(){var r;let n=yield h(null===(r=t.target)||void 0===r?void 0:r.result);this.book=ke(n,!1),e()})),n.readAsText(r,"UTF-8")}catch(e){console.log(e),t(e)}}))}))}preCache(){return u(this,void 0,void 0,(function*(){return this.book||(yield this.parse()),yield this.getCache(this.book)}))}}class An extends Et{constructor(e,t,r,n){super(t,r,n),this.htmlBuffer=e,this.mode=t,this.format=r,this.chapterList=[],this.chapterDocList=[],this.element=""}renderTo(e){return new Promise(((t,r)=>u(this,void 0,void 0,(function*(){this.element=e,this.book||(yield this.parse());let r=new S(this.book);this.chapterList=yield r.getChapter(this.book.toc),this.chapterDocList=yield r.getChapterDoc(),b(e),L(e,this.mode),t()}))))}parse(){return u(this,void 0,void 0,(function*(){return new Promise(((e,t)=>{try{var r=new Blob([this.htmlBuffer],{type:lt[this.format.toLocaleLowerCase()]}),n=new FileReader;n.onload=t=>u(this,void 0,void 0,(function*(){var r;let n=null===(r=t.target)||void 0===r?void 0:r.result;"MHTML"===this.format&&(console.log(d.convert(n)),n=d.convert(n).window.document.documentElement.innerHTML),this.book=ke(n,!1),e()})),n.readAsText(r,"UTF-8")}catch(e){console.log(e),t(e)}}))}))}preCache(){return u(this,void 0,void 0,(function*(){return this.book||(yield this.parse()),yield this.getCache(this.book)}))}}export{En as CacheRender,hn as ComicRender,Bn as DocxRender,Bt as EpubRender,Tn as Fb2Render,An as HtmlRender,In as MdRender,yr as MobiRender,kr as PdfRender,ln as TxtRender};
